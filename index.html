<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Monitoring Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class', // or 'media'
            theme: {
                extend: {
                    colors: {
                        'primary': '#1e40af', // Example primary color (blue-700)
                        'secondary': '#374151', // Example secondary color (gray-700)
                        'accent': '#f59e0b', // Example accent color (amber-500)
                        'dark-bg': '#111827', // dark:bg-gray-900
                        'dark-card': '#1f2937', // dark:bg-gray-800
                        'dark-text': '#d1d5db', // dark:text-gray-300
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* A nice sans-serif font */
            background-color: #f3f4f6; /* light:bg-gray-100 */
        }
        .dark body {
            background-color: var(--dark-bg); /* dark:bg-gray-900 */
            color: var(--dark-text); /* dark:text-gray-300 */
        }
        .sidebar {
            transition: width 0.3s ease;
        }
        .sidebar-collapsed {
            width: 4.5rem; /* w-18 */
        }
        .sidebar-expanded {
            width: 16rem; /* w-64 */
        }
        .sidebar-item-label {
            display: inline;
        }
        .sidebar-collapsed .sidebar-item-label {
            display: none;
        }
        .sidebar-item.active {
            background-color: var(--primary); /* bg-blue-700 */
            color: white;
        }
        .dark .sidebar-item.active {
            background-color: var(--primary);
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
        }
        .dark .modal-content {
            background-color: var(--dark-card);
            border-color: #444;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .dark .close-button {
            color: #ccc;
        }
        .dark .close-button:hover,
        .dark .close-button:focus {
            color: white;
        }
        .table-auto th, .table-auto td {
            padding: 0.5rem 0.75rem; /* py-2 px-3 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
        .dark .table-auto th, .dark .table-auto td {
            border-color: #374151; /* dark:border-gray-700 */
        }
        .pagination button {
            margin: 0 0.25rem;
        }
        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }
        .badge-online { background-color: #22c55e; color: white; } /* bg-green-500 */
        .badge-offline { background-color: #ef4444; color: white; } /* bg-red-500 */
        .badge-live { background-color: #3b82f6; color: white; } /* bg-blue-500 */

        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* dark:bg-gray-700 or a lighter color for light mode */
        }
        .dark ::-webkit-scrollbar-track {
            background: #1f2937; /* dark:bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* dark:bg-gray-600 */
            border-radius: 4px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #4b5563; /* dark:bg-gray-500 */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* dark:bg-gray-500 */
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* dark:bg-gray-400 */
        }

        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg text-gray-900 dark:text-dark-text">

    <!-- Login Page -->
    <div id="login-page" class="flex items-center justify-center min-h-screen bg-gray-100 dark:bg-dark-bg">
        <div class="px-8 py-6 mt-4 text-left bg-white dark:bg-dark-card shadow-lg rounded-lg w-full max-w-md">
            <h3 class="text-2xl font-bold text-center text-gray-800 dark:text-white">Admin Login</h3>
            <form id="login-form">
                <div class="mt-4">
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300" for="email">Email</label>
                        <input type="email" placeholder="Email" id="login-email"
                            class="w-full px-4 py-2 mt-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-600 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <div class="mt-4">
                        <label class="block text-gray-700 dark:text-gray-300" for="password">Password</label>
                        <input type="password" placeholder="Password" id="login-password"
                            class="w-full px-4 py-2 mt-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-blue-600 bg-white dark:bg-gray-700 dark:text-white dark:border-gray-600">
                    </div>
                    <p id="login-error" class="text-sm text-red-500 mt-2"></p>
                    <div class="flex items-baseline justify-between">
                        <button type="submit"
                            class="w-full px-6 py-2 mt-4 text-white bg-primary rounded-lg hover:bg-blue-800 dark:hover:bg-blue-600">Login</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Admin Panel (Hidden by default) -->
    <div id="admin-panel" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar-expanded bg-gray-800 dark:bg-gray-900 text-gray-100 flex flex-col transition-all duration-300 ease-in-out">
                <div class="p-4 border-b border-gray-700 dark:border-gray-800 flex items-center justify-between">
                    <h1 class="text-xl font-semibold sidebar-item-label">Admin Panel</h1>
                    <button id="sidebar-toggle" class="p-2 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 focus:outline-none">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <nav class="flex-grow p-2 space-y-1">
                    <a href="#dashboard" data-section="dashboard" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-tachometer-alt w-6 text-center"></i>
                        <span class="ml-3 sidebar-item-label">Dashboard</span>
                    </a>
                    <a href="#devices" data-section="devices" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-mobile-alt w-6 text-center"></i>
                        <span class="ml-3 sidebar-item-label">Devices</span>
                    </a>
                    <!-- Device specific links, dynamically shown or part of device detail view -->
                    <div id="device-specific-links" class="hidden">
                        <h4 class="px-3 pt-2 pb-1 text-xs font-semibold text-gray-400 uppercase sidebar-item-label current-device-name-sidebar">Device: N/A</h4>
                        <a href="#device-info" data-section="device-info" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-info-circle w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">Device Info</span>
                        </a>
                        <a href="#sms" data-section="sms" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-sms w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">SMS Logs</span>
                        </a>
                        <a href="#calls" data-section="calls" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-phone-alt w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">Call Logs</span>
                        </a>
                        <a href="#apps" data-section="apps" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-th-large w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">Installed Apps</span>
                        </a>
                        <a href="#battery" data-section="battery" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-battery-full w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">Battery Info</span>
                        </a>
                        <a href="#location" data-section="location" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-map-marker-alt w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">Location</span>
                        </a>
                         <a href="#files" data-section="files" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-folder-open w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">File Logs</span>
                        </a>
                        <a href="#screenshots" data-section="screenshots" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-camera w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">Screenshots</span>
                        </a>
                        <a href="#notifications" data-section="notifications" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-bell w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">Notifications</span>
                        </a>
                        <a href="#history" data-section="history" class="sidebar-item flex items-center px-3 py-2.5 rounded-md hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-history w-6 text-center"></i>
                            <span class="ml-3 sidebar-item-label">Browsing History</span>
                        </a>
                    </div>
                </nav>
                <div class="p-4 border-t border-gray-700 dark:border-gray-800">
                    <button id="theme-toggle" class="w-full flex items-center px-3 py-2.5 rounded-md text-gray-100 hover:bg-gray-700 dark:hover:bg-gray-700 transition-colors">
                        <i class="fas fa-moon w-6 text-center"></i>
                        <span class="ml-3 sidebar-item-label">Toggle Theme</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col overflow-hidden">
                <!-- Topbar -->
                <header class="bg-white dark:bg-dark-card shadow-md p-4 flex justify-between items-center">
                    <h2 id="current-section-title" class="text-xl font-semibold text-gray-800 dark:text-white">Dashboard</h2>
                    <div>
                        <span id="admin-email" class="text-sm text-gray-600 dark:text-gray-400 mr-4"></span>
                        <button id="logout-button" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">
                            <i class="fas fa-sign-out-alt mr-1"></i> Logout
                        </button>
                    </div>
                </header>

                <!-- Content Sections -->
                <main id="main-content" class="flex-1 p-6 overflow-y-auto">
                    <!-- Dashboard Section -->
                    <section id="dashboard-section" class="content-section">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Total Devices</h3>
                                <p id="total-devices" class="text-3xl font-bold text-primary dark:text-accent">0</p>
                            </div>
                            <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Online Devices</h3>
                                <p id="online-devices" class="text-3xl font-bold text-green-500">0</p>
                            </div>
                            <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Total SMS</h3>
                                <p id="total-sms" class="text-3xl font-bold text-gray-600 dark:text-gray-400">0</p>
                            </div>
                            <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md">
                                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Total Calls</h3>
                                <p id="total-calls" class="text-3xl font-bold text-gray-600 dark:text-gray-400">0</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md">
                             <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-gray-300">Recent Activity (Placeholder)</h3>
                             <p class="text-gray-600 dark:text-gray-400">Real-time activity feed will show here.</p>
                        </div>
                    </section>

                    <!-- Device List Section -->
                    <section id="devices-section" class="content-section hidden">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="device-search" placeholder="Search by name or UID..." class="px-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-600 w-1/3">
                        </div>
                        <div class="bg-white dark:bg-dark-card shadow-md rounded-lg overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Alias</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">UID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Last Seen</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="device-list-table" class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Device rows will be injected here -->
                                    <tr id="no-devices-row" class="hidden"><td colspan="5" class="text-center py-4">No devices found.</td></tr>
                                    <tr id="devices-loading-row"><td colspan="5" class="text-center py-4"><div class="loader"></div></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Device Info Section -->
                    <section id="device-info-section" class="content-section hidden">
                        <button class="export-csv-button mb-4 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" data-type="device-info">
                            <i class="fas fa-file-csv mr-1"></i> Export Device Info
                        </button>
                        <div id="device-info-content" class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md grid grid-cols-1 md:grid-cols-2 gap-4">
                           <!-- Device info will be populated here -->
                           <p>Loading device information...</p>
                        </div>
                        <div class="mt-4 bg-white dark:bg-dark-card p-4 rounded-lg shadow-md">
                            <label for="edit-device-alias" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Device Alias:</label>
                            <input type="text" id="edit-device-alias" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <button id="save-device-alias" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Save Alias</button>
                        </div>
                    </section>

                    <!-- SMS Logs Section -->
                    <section id="sms-section" class="content-section hidden">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="sms-search" placeholder="Search SMS..." class="px-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-600 w-1/3">
                            <button class="export-csv-button px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" data-type="sms">
                                <i class="fas fa-file-csv mr-1"></i> Export SMS
                            </button>
                        </div>
                        <div class="bg-white dark:bg-dark-card shadow-md rounded-lg overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="address">Sender/Recipient</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="body">Message</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="date">Time</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="type">Type</th>
                                    </tr>
                                </thead>
                                <tbody id="sms-log-table" class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- SMS logs will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="sms-pagination" class="mt-4 flex justify-center pagination"></div>
                    </section>

                    <!-- Call Logs Section -->
                    <section id="calls-section" class="content-section hidden">
                        <div class="flex justify-between items-center mb-4">
                            <input type="text" id="call-search" placeholder="Search Calls..." class="px-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-600 w-1/3">
                            <button class="export-csv-button px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" data-type="calls">
                                <i class="fas fa-file-csv mr-1"></i> Export Calls
                            </button>
                        </div>
                        <div class="bg-white dark:bg-dark-card shadow-md rounded-lg overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="number">Number</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="name">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="type">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="duration">Duration</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider sortable" data-sort="date">Date</th>
                                    </tr>
                                </thead>
                                <tbody id="call-log-table" class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Call logs will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="call-pagination" class="mt-4 flex justify-center pagination"></div>
                    </section>

                    <!-- Installed Apps Section -->
                    <section id="apps-section" class="content-section hidden">
                         <div class="flex justify-between items-center mb-4">
                            <p id="total-apps-count" class="text-lg font-semibold"></p>
                            <button class="export-csv-button px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" data-type="apps">
                                <i class="fas fa-file-csv mr-1"></i> Export Apps
                            </button>
                        </div>
                        <div class="bg-white dark:bg-dark-card shadow-md rounded-lg overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">App Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Package Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Type</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Version</th>
                                    </tr>
                                </thead>
                                <tbody id="app-list-table" class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- App list will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Battery Info Section -->
                    <section id="battery-section" class="content-section hidden">
                        <div id="battery-info-content" class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md">
                           <p>Loading battery information...</p>
                        </div>
                    </section>

                    <!-- Location Section -->
                    <section id="location-section" class="content-section hidden">
                        <div class="bg-white dark:bg-dark-card p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-2">Latest Location</h3>
                            <div id="location-details" class="mb-4">
                                <p>Loading location data...</p>
                            </div>
                            <div id="map"></div>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Map requires Google Maps API Key.</p>
                        </div>
                    </section>

                    <!-- File Logs Section -->
                    <section id="files-section" class="content-section hidden">
                        <div class="flex justify-between items-center mb-4">
                           <input type="text" id="file-search" placeholder="Search files by name or folder..." class="px-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-600 w-1/3">
                           <button class="export-csv-button px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" data-type="files">
                               <i class="fas fa-file-csv mr-1"></i> Export Files
                           </button>
                       </div>
                       <div class="bg-white dark:bg-dark-card shadow-md rounded-lg overflow-x-auto">
                           <table class="min-w-full table-auto">
                               <thead class="bg-gray-50 dark:bg-gray-700">
                                   <tr>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Folder</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">File Name</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Extension</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Size</th>
                                       <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Last Modified</th>
                                   </tr>
                               </thead>
                               <tbody id="file-log-table" class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700">
                                   <!-- File logs will be injected here -->
                               </tbody>
                           </table>
                       </div>
                    </section>

                    <!-- Screenshots Section -->
                    <section id="screenshots-section" class="content-section hidden">
                        <div id="screenshot-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            <!-- Screenshots will be injected here -->
                            <p id="no-screenshots-message">No screenshots available for this device.</p>
                        </div>
                    </section>

                    <!-- Notifications Section -->
                    <section id="notifications-section" class="content-section hidden">
                        <div class="bg-white dark:bg-dark-card shadow-md rounded-lg overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">App Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Content</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Time</th>
                                    </tr>
                                </thead>
                                <tbody id="notification-log-table" class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Notifications will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Browsing History Section -->
                    <section id="history-section" class="content-section hidden">
                         <div class="flex justify-between items-center mb-4">
                           <input type="text" id="history-search" placeholder="Search history by title or URL..." class="px-4 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 focus:outline-none focus:ring-1 focus:ring-blue-600 w-1/3">
                           <button class="export-csv-button px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" data-type="history">
                               <i class="fas fa-file-csv mr-1"></i> Export History
                           </button>
                       </div>
                        <div class="bg-white dark:bg-dark-card shadow-md rounded-lg overflow-x-auto">
                            <table class="min-w-full table-auto">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">URL</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Visit Time</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Browser</th>
                                    </tr>
                                </thead>
                                <tbody id="history-log-table" class="bg-white dark:bg-dark-card divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- History logs will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </section>

                    <!-- Loading overlay -->
                    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
                        <div class="loader"></div>
                    </div>

                </main>
            </div>
        </div>
    </div>

    <!-- Screenshot Modal -->
    <div id="screenshot-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-screenshot-modal">&times;</span>
            <img id="modal-screenshot-img" src="" alt="Full Screenshot" class="w-full h-auto">
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <!-- Google Maps API (Replace YOUR_GOOGLE_MAPS_API_KEY) -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initMap"></script>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw",
            authDomain: "victimdataproject.firebaseapp.com", // You might need to add this from your Firebase console
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.appspot.com", // You might need to add this
            messagingSenderId: "938788267301", // If you use messaging
            appId: "1:938788267301:web:cdcff391160dce48fa66cc",
            // measurementId: "G-XXXXXXXXXX" // If you use Analytics
        };

        // --- Initialize Firebase ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- Global State ---
        let currentUser = null;
        let currentDeviceUID = null;
        let currentDeviceData = {};
        let allDevicesData = {}; // Store all device data for dashboard and filtering
        let currentView = 'dashboard';
        let deviceDataListeners = {}; // To store Firebase listeners for device data
        const ITEMS_PER_PAGE = 15;

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const adminEmailEl = document.getElementById('admin-email');
        const logoutButton = document.getElementById('logout-button');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mainContent = document.getElementById('main-content');
        const currentSectionTitleEl = document.getElementById('current-section-title');
        const deviceSpecificLinks = document.getElementById('device-specific-links');
        const currentDeviceNameSidebar = document.querySelector('.current-device-name-sidebar');
        const themeToggle = document.getElementById('theme-toggle');
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- Utility Functions ---
        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function formatTimestamp(timestamp, format = 'full') {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            if (format === 'timeago') {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = Math.floor(seconds / 31536000);
                if (interval > 1) return interval + " years ago";
                interval = Math.floor(seconds / 2592000);
                if (interval > 1) return interval + " months ago";
                interval = Math.floor(seconds / 86400);
                if (interval > 1) return interval + " days ago";
                interval = Math.floor(seconds / 3600);
                if (interval > 1) return interval + " hours ago";
                interval = Math.floor(seconds / 60);
                if (interval > 1) return interval + " mins ago";
                if (seconds < 10) return "just now";
                return Math.floor(seconds) + " secs ago";
            }
            return date.toLocaleString();
        }

        function formatDuration(seconds) {
            if (seconds === null || seconds === undefined) return 'N/A';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [
                h > 0 ? `${h}h` : '',
                m > 0 ? `${m}m` : '',
                `${s}s`
            ].filter(Boolean).join(' ') || '0s';
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // --- Theme Toggle ---
        function applyTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                themeToggle.querySelector('i').classList.remove('fa-moon');
                themeToggle.querySelector('i').classList.add('fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggle.querySelector('i').classList.remove('fa-sun');
                themeToggle.querySelector('i').classList.add('fa-moon');
            }
        }
        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyTheme(isDark);
        });
        // Apply saved theme on load
        const savedTheme = localStorage.getItem('theme');
        applyTheme(savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches));


        // --- Authentication ---
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                adminEmailEl.textContent = user.email;
                loginPage.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                navigateTo(window.location.hash || '#dashboard');
                loadAllDevicesData(); // Initial load for dashboard
            } else {
                loginPage.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                currentDeviceUID = null;
                deviceSpecificLinks.classList.add('hidden');
                detachAllDeviceListeners();
                allDevicesData = {};
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = '';
            showLoading();
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    loginError.textContent = error.message;
                })
                .finally(hideLoading);
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // --- Sidebar Toggle ---
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-collapsed');
            sidebar.classList.toggle('sidebar-expanded');
            const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', isCollapsed);
        });
        // Apply sidebar state on load
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar.classList.add('sidebar-collapsed');
            sidebar.classList.remove('sidebar-expanded');
        }


        // --- Navigation ---
        function navigateTo(hash) {
            const section = hash.substring(1).split('/')[0] || 'dashboard'; // e.g. #sms/deviceId -> sms
            const deviceIdFromHash = hash.substring(1).split('/')[1];

            if (deviceIdFromHash && deviceIdFromHash !== currentDeviceUID) {
                selectDevice(deviceIdFromHash); // This will also trigger a navigation update
                return;
            }

            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            const targetSection = document.getElementById(`${section}-section`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                currentSectionTitleEl.textContent = section.charAt(0).toUpperCase() + section.slice(1).replace('-', ' ');
                if (currentDeviceUID && section !== 'dashboard' && section !== 'devices') {
                     currentSectionTitleEl.textContent += ` (Device: ${allDevicesData[currentDeviceUID]?.alias || currentDeviceUID.substring(0,8)})`;
                }
            } else {
                document.getElementById('dashboard-section').classList.remove('hidden');
                currentSectionTitleEl.textContent = 'Dashboard';
            }

            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            const activeSidebarItem = document.querySelector(`.sidebar-item[data-section="${section}"]`);
            if (activeSidebarItem) {
                activeSidebarItem.classList.add('active');
            }

            currentView = section;
            window.location.hash = (currentDeviceUID && section !== 'dashboard' && section !== 'devices') ? `${section}/${currentDeviceUID}` : section;

            // Load data for the current view
            if (currentUser) {
                loadDataForView(section);
            }
        }

        window.addEventListener('hashchange', () => navigateTo(window.location.hash));


        // --- Data Loading and Rendering ---
        function loadDataForView(section) {
            showLoading();
            switch (section) {
                case 'dashboard':
                    renderDashboard(); // Uses allDevicesData which is loaded/updated separately
                    break;
                case 'devices':
                    renderDeviceList(); // Uses allDevicesData
                    break;
                case 'device-info':
                    if (currentDeviceUID) renderDeviceInfo();
                    break;
                case 'sms':
                    if (currentDeviceUID) loadAndRenderPaginatedData('sms', renderSmsLogs, filterSms);
                    break;
                case 'calls':
                    if (currentDeviceUID) loadAndRenderPaginatedData('calls', renderCallLogs, filterCalls);
                    break;
                case 'apps':
                    if (currentDeviceUID) loadAndRenderAppData();
                    break;
                case 'battery':
                    if (currentDeviceUID) renderBatteryInfo();
                    break;
                case 'location':
                    if (currentDeviceUID) renderLocationInfo();
                    break;
                case 'files':
                    if (currentDeviceUID) loadAndRenderPaginatedData('files', renderFileLogs, filterFiles);
                    break;
                case 'screenshots':
                    if (currentDeviceUID) renderScreenshots();
                    break;
                case 'notifications':
                    if (currentDeviceUID) loadAndRenderNotificationLogs();
                    break;
                case 'history':
                    if (currentDeviceUID) loadAndRenderPaginatedData('browsingHistory', renderBrowsingHistory, filterHistory);
                    break;
                default:
                    console.warn("Unknown section:", section);
            }
            hideLoading();
        }

        function detachAllDeviceListeners() {
            Object.values(deviceDataListeners).forEach(offFunc => offFunc());
            deviceDataListeners = {};
        }

        function attachDeviceListener(path, callback) {
            if (!currentDeviceUID) return;
            const fullPath = `devices/${currentDeviceUID}/${path}`;
            // Detach previous listener for this path if exists
            if (deviceDataListeners[path]) {
                deviceDataListeners[path]();
            }
            const listener = db.ref(fullPath).on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    // Update currentDeviceData selectively
                    const pathParts = path.split('/');
                    let target = currentDeviceData;
                    for (let i = 0; i < pathParts.length -1; i++) {
                        target[pathParts[i]] = target[pathParts[i]] || {};
                        target = target[pathParts[i]];
                    }
                    target[pathParts[pathParts.length-1]] = data;

                    // Also update allDevicesData for dashboard and device list consistency
                    if (allDevicesData[currentDeviceUID]) {
                        let allTarget = allDevicesData[currentDeviceUID];
                         for (let i = 0; i < pathParts.length -1; i++) {
                            allTarget[pathParts[i]] = allTarget[pathParts[i]] || {};
                            allTarget = allTarget[pathParts[i]];
                        }
                        allTarget[pathParts[pathParts.length-1]] = data;

                        // Re-render if current view depends on this specific data
                        if (currentView === path || (currentView === 'devices' && path.startsWith('status')) || currentView === 'dashboard') {
                             loadDataForView(currentView);
                        }
                    }
                }
                callback(data);
            }, error => {
                console.error(`Error listening to ${fullPath}:`, error);
                // Potentially show an error to the user
            });
            deviceDataListeners[path] = () => db.ref(fullPath).off('value', listener);
        }

        // --- Dashboard ---
        let allDevicesListener = null;
        function loadAllDevicesData() {
            showLoading();
            if (allDevicesListener) allDevicesListener(); // Detach previous listener

            const devicesRef = db.ref('devices');
            allDevicesListener = devicesRef.on('value', snapshot => {
                allDevicesData = snapshot.val() || {};
                if (currentView === 'dashboard' || currentView === 'devices') {
                     renderDashboard(); // Always update dashboard with fresh totals
                     if (currentView === 'devices') renderDeviceList();
                }
                hideLoading();
            }, error => {
                console.error("Error loading all devices data:", error);
                document.getElementById('total-devices').textContent = 'Error';
                hideLoading();
            });
        }

        function renderDashboard() {
            const deviceUIDs = Object.keys(allDevicesData);
            document.getElementById('total-devices').textContent = deviceUIDs.length;

            let onlineCount = 0;
            let totalSms = 0;
            let totalCalls = 0;

            deviceUIDs.forEach(uid => {
                const device = allDevicesData[uid];
                if (device && device.status && device.status.online) {
                    onlineCount++;
                }
                if (device && device.sms) {
                    totalSms += Object.keys(device.sms).length;
                }
                if (device && device.calls) {
                    totalCalls += Object.keys(device.calls).length;
                }
                // Add more counts as needed (screenshots, notifications, etc.)
            });

            document.getElementById('online-devices').textContent = onlineCount;
            document.getElementById('total-sms').textContent = totalSms;
            document.getElementById('total-calls').textContent = totalCalls;
            // Potentially show "recent activity" based on timestamps from allDevicesData
        }

        // --- Device List ---
        function renderDeviceList(searchTerm = '') {
            const tableBody = document.getElementById('device-list-table');
            const noDevicesRow = document.getElementById('no-devices-row');
            const loadingRow = document.getElementById('devices-loading-row');
            tableBody.innerHTML = ''; // Clear existing rows
            loadingRow.classList.remove('hidden');
            noDevicesRow.classList.add('hidden');

            const deviceUIDs = Object.keys(allDevicesData);

            if (deviceUIDs.length === 0) {
                noDevicesRow.classList.remove('hidden');
                loadingRow.classList.add('hidden');
                return;
            }

            let filteredUIDs = deviceUIDs;
            if (searchTerm) {
                searchTerm = searchTerm.toLowerCase();
                filteredUIDs = deviceUIDs.filter(uid => {
                    const device = allDevicesData[uid];
                    const alias = (device.alias || '').toLowerCase();
                    return uid.toLowerCase().includes(searchTerm) || alias.includes(searchTerm);
                });
            }

            if (filteredUIDs.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4">No devices match your search.</td></tr>`;
                 loadingRow.classList.add('hidden');
                 return;
            }

            filteredUIDs.forEach(uid => {
                const device = allDevicesData[uid];
                const alias = device.alias || 'N/A';
                const status = device.status || {};
                const isOnline = status.online;
                const lastSeen = status.lastSeen ? formatTimestamp(status.lastSeen, 'timeago') : 'Never';
                const isSyncing = status.syncing;

                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${alias}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${uid}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span class="badge ${isOnline ? 'badge-online' : 'badge-offline'}">${isOnline ? 'Online' : 'Offline'}</span>
                            ${isSyncing ? '<span class="badge badge-live ml-1">Live</span>' : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${lastSeen}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="selectDevice('${uid}')" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-200">View Details</button>
                        </td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
            loadingRow.classList.add('hidden');
        }

        document.getElementById('device-search').addEventListener('input', (e) => {
            renderDeviceList(e.target.value);
        });

        function selectDevice(uid) {
            detachAllDeviceListeners(); // Clear listeners for the old device
            currentDeviceUID = uid;
            currentDeviceData = allDevicesData[uid] || {}; // Initialize with existing data or empty

            const deviceName = currentDeviceData.alias || currentDeviceData.deviceInfo?.model || uid.substring(0,8);
            currentDeviceNameSidebar.textContent = `Device: ${deviceName}`;
            deviceSpecificLinks.classList.remove('hidden');

            // Pre-fill alias edit field
            document.getElementById('edit-device-alias').value = currentDeviceData.alias || '';

            // Attach listeners for dynamic data of the selected device
            attachDeviceListener('status', data => {
                if (data && currentView === 'devices') renderDeviceList(document.getElementById('device-search').value);
                // Update device list status or dashboard if needed
                if(allDevicesData[currentDeviceUID]) allDevicesData[currentDeviceUID].status = data;
                if (currentView === 'dashboard') renderDashboard();
                if (currentView === 'devices') renderDeviceList(document.getElementById('device-search').value);
            });
            attachDeviceListener('battery', data => {
                if(currentDeviceData) currentDeviceData.battery = data;
                if(allDevicesData[currentDeviceUID]) allDevicesData[currentDeviceUID].battery = data;
                if (currentView === 'battery') renderBatteryInfo();
            });
            attachDeviceListener('location/latest', data => {
                if(currentDeviceData && currentDeviceData.location) currentDeviceData.location.latest = data;
                else if (currentDeviceData) currentDeviceData.location = { latest: data };

                if(allDevicesData[currentDeviceUID] && allDevicesData[currentDeviceUID].location) allDevicesData[currentDeviceUID].location.latest = data;
                else if (allDevicesData[currentDeviceUID]) allDevicesData[currentDeviceUID].location = { latest: data };

                if (currentView === 'location') renderLocationInfo();
            });
            // Add more specific listeners for real-time updates on active views if needed
            // e.g., for notifications if you want them to appear live without full reload
            attachDeviceListener('notifications', data => {
                 if(currentDeviceData) currentDeviceData.notifications = data;
                 if(allDevicesData[currentDeviceUID]) allDevicesData[currentDeviceUID].notifications = data;
                 if (currentView === 'notifications') loadAndRenderNotificationLogs(); // Re-render to show new ones
            });


            // Navigate to device info by default when a device is selected for the first time or if no specific sub-page is in hash
            let currentSubSection = window.location.hash.split('/')[0].substring(1);
            if (!['device-info', 'sms', 'calls', 'apps', 'battery', 'location', 'files', 'screenshots', 'notifications', 'history'].includes(currentSubSection)) {
                navigateTo(`#device-info/${uid}`);
            } else {
                 navigateTo(`#${currentSubSection}/${uid}`); // Reload current sub-section for the new device
            }
        }

        // --- Generic Paginated Data Loader ---
        let currentDataCache = []; // For client-side search/sort/pagination
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        function loadAndRenderPaginatedData(dataType, renderFunction, filterFunction, page = 1) {
            showLoading();
            const tableBody = document.getElementById(`${dataType === 'browsingHistory' ? 'history' : dataType}-log-table`);
            const paginationControls = document.getElementById(`${dataType === 'browsingHistory' ? 'history' : dataType}-pagination`);
            const searchInput = document.getElementById(`${dataType === 'browsingHistory' ? 'history' : dataType}-search`);

            if (tableBody) tableBody.innerHTML = `<tr><td colspan="100%"><div class="loader"></div></td></tr>`; // Wide colspan
            if (paginationControls) paginationControls.innerHTML = '';

            // Listen for data changes
            attachDeviceListener(dataType, data => {
                currentDeviceData[dataType] = data || {};
                let items = Object.entries(currentDeviceData[dataType] || {}).map(([id, item]) => ({ ...item, id }));

                // Apply search filter if any
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                if (searchTerm && filterFunction) {
                    items = items.filter(item => filterFunction(item, searchTerm));
                }

                // Apply sorting
                if (currentSortColumn) {
                    items.sort((a, b) => {
                        let valA = a[currentSortColumn];
                        let valB = b[currentSortColumn];

                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();
                        if (currentSortColumn === 'date' || currentSortColumn === 'time' || currentSortColumn === 'timestamp' || currentSortColumn === 'lastModified' || currentSortColumn === 'visitTime' || currentSortColumn === 'postTime') {
                            valA = Number(valA) || 0;
                            valB = Number(valB) || 0;
                        }

                        if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                } else { // Default sort by date descending if available
                     const dateKey = items.length > 0 ? (items[0].date ? 'date' : (items[0].time ? 'time' : (items[0].timestamp ? 'timestamp' : (items[0].lastModified ? 'lastModified' : (items[0].visitTime ? 'visitTime' : (items[0].postTime ? 'postTime' : null)))))) : null;
                     if (dateKey) {
                        items.sort((a,b) => (Number(b[dateKey]) || 0) - (Number(a[dateKey]) || 0));
                     }
                }


                currentDataCache = items; // Store filtered and sorted items
                renderPaginatedView(dataType, renderFunction, page);
                hideLoading();
            });
        }

        function renderPaginatedView(dataType, renderFunction, page = 1) {
            const items = currentDataCache;
            const tableBody = document.getElementById(`${dataType === 'browsingHistory' ? 'history' : dataType}-log-table`);
            const paginationControls = document.getElementById(`${dataType === 'browsingHistory' ? 'history' : dataType}-pagination`);

            if (tableBody) tableBody.innerHTML = '';
            if (paginationControls) paginationControls.innerHTML = '';

            if (!items || items.length === 0) {
                if (tableBody) tableBody.innerHTML = `<tr><td colspan="100%" class="text-center py-4">No ${dataType.replace('-', ' ')} found.</td></tr>`;
                return;
            }

            const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
            const startIndex = (page - 1) * ITEMS_PER_PAGE;
            const endIndex = page * ITEMS_PER_PAGE;
            const paginatedItems = items.slice(startIndex, endIndex);

            renderFunction(paginatedItems, tableBody);

            // Render pagination controls
            if (totalPages > 1 && paginationControls) {
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.className = `px-3 py-1 border rounded ${i === page ? 'bg-primary text-white' : 'bg-white dark:bg-gray-600 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-500'}`;
                    button.onclick = () => renderPaginatedView(dataType, renderFunction, i);
                    paginationControls.appendChild(button);
                }
            }
        }

        // Add event listeners for search inputs
        ['sms-search', 'call-search', 'file-search', 'history-search'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', () => {
                    const dataType = id.split('-')[0];
                    const renderFunc = dataType === 'sms' ? renderSmsLogs : (dataType === 'calls' ? renderCallLogs : (dataType === 'files' ? renderFileLogs : renderBrowsingHistory));
                    const filterFunc = dataType === 'sms' ? filterSms : (dataType === 'calls' ? filterCalls : (dataType === 'files' ? filterFiles : filterHistory));
                    loadAndRenderPaginatedData(dataType === 'history' ? 'browsingHistory' : dataType, renderFunc, filterFunc, 1); // Reset to page 1 on search
                });
            }
        });

        // Add event listeners for sortable table headers
        document.addEventListener('click', function(e) {
            if (e.target.matches('.sortable')) {
                const column = e.target.dataset.sort;
                const dataType = e.target.closest('table').parentElement.parentElement.id.split('-')[0]; // e.g. sms-section -> sms

                if (currentSortColumn === column) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = column;
                    currentSortDirection = 'asc';
                }

                // Remove existing sort indicators
                e.target.closest('thead').querySelectorAll('.sortable i').forEach(icon => icon.remove());
                e.target.closest('thead').querySelectorAll('.sortable').forEach(th => th.classList.remove('sorted-asc', 'sorted-desc'));


                // Add new sort indicator
                const icon = document.createElement('i');
                icon.classList.add('fas', currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down', 'ml-1');
                e.target.appendChild(icon);
                e.target.classList.add(currentSortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');


                const renderFunc = dataType === 'sms' ? renderSmsLogs : (dataType === 'calls' ? renderCallLogs : (dataType === 'files' ? renderFileLogs : renderBrowsingHistory));
                const filterFunc = dataType === 'sms' ? filterSms : (dataType === 'calls' ? filterCalls : (dataType === 'files' ? filterFiles : filterHistory));
                loadAndRenderPaginatedData(dataType === 'history' ? 'browsingHistory' : dataType, renderFunc, filterFunc, 1);
            }
        });


        // --- SMS Logs ---
        function renderSmsLogs(smsLogs, tableBody) {
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (!smsLogs || smsLogs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No SMS logs available.</td></tr>';
                return;
            }
            smsLogs.forEach(sms => {
                // SMS type: 1 (inbox), 2 (sent) - adapt if your Android app uses different values
                let typeDisplay = 'Unknown';
                if (sms.type === 1 || sms.type === 'inbox' || sms.type === 'RECEIVED' || sms.type?.toLowerCase() === 'inbox') typeDisplay = 'Inbox';
                else if (sms.type === 2 || sms.type === 'sent' || sms.type === 'SENT' || sms.type?.toLowerCase() === 'sent') typeDisplay = 'Sent';
                else if (typeof sms.type === 'string') typeDisplay = sms.type.charAt(0).toUpperCase() + sms.type.slice(1).toLowerCase();


                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${sms.address || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300 max-w-xs truncate" title="${sms.body || ''}">${sms.body || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatTimestamp(sms.date || sms.time)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${typeDisplay}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        function filterSms(sms, term) {
            return (sms.address && sms.address.toLowerCase().includes(term)) ||
                   (sms.body && sms.body.toLowerCase().includes(term));
        }

        // --- Call Logs ---
        function renderCallLogs(callLogs, tableBody) {
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (!callLogs || callLogs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No call logs available.</td></tr>';
                return;
            }
            callLogs.forEach(call => {
                // Call type: 1 (Incoming), 2 (Outgoing), 3 (Missed) - adapt if different
                let typeDisplay = 'Unknown';
                if (call.type === 1 || call.type?.toLowerCase() === 'incoming') typeDisplay = 'Incoming';
                else if (call.type === 2 || call.type?.toLowerCase() === 'outgoing') typeDisplay = 'Outgoing';
                else if (call.type === 3 || call.type?.toLowerCase() === 'missed') typeDisplay = 'Missed';
                else if (call.type === 4 || call.type?.toLowerCase() === 'voicemail') typeDisplay = 'Voicemail';
                else if (call.type === 5 || call.type?.toLowerCase() === 'rejected') typeDisplay = 'Rejected';
                else if (call.type === 6 || call.type?.toLowerCase() === 'blocked') typeDisplay = 'Blocked';
                else if (typeof call.type === 'string') typeDisplay = call.type.charAt(0).toUpperCase() + call.type.slice(1).toLowerCase();

                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${call.number || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${call.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${typeDisplay}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatDuration(call.duration)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatTimestamp(call.date)}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        function filterCalls(call, term) {
            return (call.number && call.number.toLowerCase().includes(term)) ||
                   (call.name && call.name.toLowerCase().includes(term));
        }

        // --- Installed Apps ---
        function loadAndRenderAppData() {
            showLoading();
            const tableBody = document.getElementById('app-list-table');
            const totalAppsCountEl = document.getElementById('total-apps-count');
            tableBody.innerHTML = `<tr><td colspan="4"><div class="loader"></div></td></tr>`;
            totalAppsCountEl.textContent = '';

            attachDeviceListener('apps', data => {
                currentDeviceData.apps = data || {};
                const apps = Object.values(currentDeviceData.apps);
                tableBody.innerHTML = '';
                if (apps.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No apps information available.</td></tr>';
                    totalAppsCountEl.textContent = 'Total Apps: 0';
                    hideLoading();
                    return;
                }
                totalAppsCountEl.textContent = `Total Apps: ${apps.length}`;
                apps.sort((a,b) => (a.appName || "").localeCompare(b.appName || "")); // Sort by app name

                apps.forEach(app => {
                    const row = `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${app.appName || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${app.packageName || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${app.type ? app.type.toUpperCase() : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${app.versionName || 'N/A'}</td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
                hideLoading();
            });
        }

        // --- Battery Info ---
        function renderBatteryInfo() {
            const contentDiv = document.getElementById('battery-info-content');
            contentDiv.innerHTML = `<div class="loader"></div>`;

            // Data is updated via attachDeviceListener, so we just use currentDeviceData
            const battery = currentDeviceData.battery;
            if (!battery) {
                contentDiv.innerHTML = '<p>No battery information available.</p>';
                return;
            }

            contentDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><strong>Level:</strong> ${battery.level || 'N/A'}%</div>
                    <div><strong>Status:</strong> ${battery.isCharging ? 'Charging' : 'Discharging'}</div>
                    <div><strong>Health:</strong> ${battery.health || 'N/A'}</div>
                    <div><strong>Temperature:</strong> ${battery.temperature ? battery.temperature + '°C' : 'N/A'}</div>
                    <div><strong>Voltage:</strong> ${battery.voltage ? battery.voltage + 'V' : 'N/A'}</div>
                    <div><strong>Technology:</strong> ${battery.technology || 'N/A'}</div>
                    <div><strong>Last Updated:</strong> ${formatTimestamp(battery.lastUpdated)}</div>
                </div>
            `;
        }

        // --- Location ---
        let map;
        let marker;
        function initMap() { // This is the callback for Google Maps API script
            // Default map center (e.g., world center)
            const defaultLatLng = { lat: 0, lng: 0 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 2,
                center: defaultLatLng,
                mapTypeId: 'roadmap' // satellite, hybrid, terrain
            });
            marker = new google.maps.Marker({
                position: defaultLatLng,
                map: map,
                title: "Device Location"
            });
             // If location data is already available when map initializes, update it
            if (currentDeviceUID && currentDeviceData && currentDeviceData.location && currentDeviceData.location.latest) {
                renderLocationInfo();
            }
        }

        function renderLocationInfo() {
            const detailsDiv = document.getElementById('location-details');
            detailsDiv.innerHTML = `<div class="loader"></div>`;

            const locationData = currentDeviceData.location?.latest;

            if (!locationData || typeof locationData.latitude === 'undefined' || typeof locationData.longitude === 'undefined') {
                detailsDiv.innerHTML = '<p>No location data available or data is incomplete.</p>';
                 if (map) map.setCenter({lat:0, lng:0}); // Reset map
                 if (marker) marker.setPosition({lat:0, lng:0});
                return;
            }

            detailsDiv.innerHTML = `
                <p><strong>Latitude:</strong> ${locationData.latitude}</p>
                <p><strong>Longitude:</strong> ${locationData.longitude}</p>
                <p><strong>Accuracy:</strong> ${locationData.accuracy ? locationData.accuracy + 'm' : 'N/A'}</p>
                <p><strong>Speed:</strong> ${locationData.speed ? locationData.speed + ' m/s' : 'N/A'}</p>
                <p><strong>Timestamp:</strong> ${formatTimestamp(locationData.timestamp)}</p>
                <p><strong>Provider:</strong> ${locationData.provider || 'N/A'}</p>
            `;

            if (map && marker) {
                const latLng = new google.maps.LatLng(locationData.latitude, locationData.longitude);
                map.setCenter(latLng);
                map.setZoom(15);
                marker.setPosition(latLng);
                marker.setTitle(`Location at ${formatTimestamp(locationData.timestamp)}`);
            } else {
                 console.warn("Map not initialized yet. Location will update once it is.");
            }
        }

        // --- File Logs ---
        function renderFileLogs(fileLogs, tableBody) {
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (!fileLogs || fileLogs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No file logs available.</td></tr>';
                return;
            }
            fileLogs.forEach(file => {
                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${file.folder || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300" title="${file.path || ''}">${file.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${file.extension || file.type || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatBytes(file.size || 0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatTimestamp(file.lastModified || file.timestamp)}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        function filterFiles(file, term) {
            return (file.name && file.name.toLowerCase().includes(term)) ||
                   (file.folder && file.folder.toLowerCase().includes(term)) ||
                   (file.path && file.path.toLowerCase().includes(term));
        }

        // --- Screenshots ---
        const screenshotModal = document.getElementById('screenshot-modal');
        const modalImg = document.getElementById('modal-screenshot-img');
        const closeScreenshotModal = document.getElementById('close-screenshot-modal');

        function renderScreenshots() {
            showLoading();
            const gallery = document.getElementById('screenshot-gallery');
            const noScreenshotsMsg = document.getElementById('no-screenshots-message');
            gallery.innerHTML = ''; // Clear previous
            noScreenshotsMsg.classList.add('hidden');

            attachDeviceListener('screenshots', data => {
                currentDeviceData.screenshots = data || {};
                const screenshots = Object.values(currentDeviceData.screenshots);
                gallery.innerHTML = ''; // Clear again due to async nature

                if (screenshots.length === 0) {
                    noScreenshotsMsg.classList.remove('hidden');
                    noScreenshotsMsg.textContent = 'No screenshots available for this device.';
                    hideLoading();
                    return;
                }
                noScreenshotsMsg.classList.add('hidden');

                screenshots.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)); // Newest first

                screenshots.forEach(ss => {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden shadow-lg cursor-pointer transform hover:scale-105 transition-transform';
                    div.innerHTML = `
                        <img src="${ss.url}" alt="${ss.fileName || 'Screenshot'}" class="w-full h-32 object-cover">
                        <div class="p-2 text-xs text-center text-gray-700 dark:text-gray-300">${ss.fileName || 'Screenshot'}<br>${formatTimestamp(ss.timestamp, 'timeago')}</div>
                    `;
                    div.onclick = () => {
                        modalImg.src = ss.url;
                        screenshotModal.style.display = "block";
                    };
                    gallery.appendChild(div);
                });
                hideLoading();
            });
        }
        closeScreenshotModal.onclick = () => screenshotModal.style.display = "none";
        window.onclick = (event) => {
            if (event.target == screenshotModal) {
                screenshotModal.style.display = "none";
            }
        }

        // --- Notifications ---
        function loadAndRenderNotificationLogs() { // This one might benefit from child_added for true real-time append
            showLoading();
            const tableBody = document.getElementById('notification-log-table');
            tableBody.innerHTML = `<tr><td colspan="4"><div class="loader"></div></td></tr>`;

            // Using onValue for simplicity here, but child_added would be more efficient for live appending
            attachDeviceListener('notifications', data => {
                currentDeviceData.notifications = data || {};
                const notifications = Object.values(currentDeviceData.notifications);
                tableBody.innerHTML = '';

                if (notifications.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No notifications captured.</td></tr>';
                    hideLoading();
                    return;
                }

                notifications.sort((a,b) => (b.postTime || 0) - (a.postTime || 0)); // Newest first

                notifications.forEach(notif => {
                    const row = `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">${notif.appName || notif.packageName || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">${notif.title || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 max-w-md truncate" title="${notif.text || notif.content || ''}">${notif.text || notif.content || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatTimestamp(notif.postTime || notif.timestamp)}</td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', row);
                });
                hideLoading();
            });
        }

        // --- Browsing History ---
        function renderBrowsingHistory(historyLogs, tableBody) {
            if (!tableBody) return;
            tableBody.innerHTML = '';
            if (!historyLogs || historyLogs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No browsing history available.</td></tr>';
                return;
            }
            historyLogs.forEach(entry => {
                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300 max-w-sm truncate" title="${entry.title || ''}">${entry.title || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 max-w-md truncate" title="${entry.url || ''}"><a href="${entry.url}" target="_blank" rel="noopener noreferrer">${entry.url || 'N/A'}</a></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatTimestamp(entry.date || entry.visitTime)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${entry.browser || 'N/A'}</td>
                    </tr>
                `;
                tableBody.insertAdjacentHTML('beforeend', row);
            });
        }
        function filterHistory(entry, term) {
            return (entry.title && entry.title.toLowerCase().includes(term)) ||
                   (entry.url && entry.url.toLowerCase().includes(term));
        }


        // --- Device Info ---
        function renderDeviceInfo() {
            const contentDiv = document.getElementById('device-info-content');
            contentDiv.innerHTML = `<div class="loader"></div>`;

            // Data is updated via attachDeviceListener, so we just use currentDeviceData
            const deviceInfo = currentDeviceData.deviceInfo;
            if (!deviceInfo) {
                contentDiv.innerHTML = '<p>No device information available.</p>';
                return;
            }
            // Update editable alias field if not already done by selectDevice
            document.getElementById('edit-device-alias').value = currentDeviceData.alias || '';

            let simInfoHtml = 'N/A';
            if (deviceInfo.simInfo) {
                simInfoHtml = `Operator: ${deviceInfo.simInfo.operatorName || 'N/A'}, Number: ${deviceInfo.simInfo.phoneNumber || 'N/A'}`;
            }

            contentDiv.innerHTML = `
                <div><strong>Model:</strong> ${deviceInfo.model || 'N/A'}</div>
                <div><strong>Manufacturer:</strong> ${deviceInfo.manufacturer || 'N/A'}</div>
                <div><strong>Android Version:</strong> ${deviceInfo.androidVersion || 'N/A'} (SDK ${deviceInfo.sdkVersion || 'N/A'})</div>
                <div><strong>IP Address:</strong> ${deviceInfo.ipAddress || 'N/A'}</div>
                <div><strong>MAC Address:</strong> ${deviceInfo.macAddress || 'N/A'}</div>
                <div><strong>IMEI:</strong> ${deviceInfo.imei || 'N/A'}</div>
                <div><strong>SIM Info:</strong> ${simInfoHtml}</div>
                <div><strong>Kernel Version:</strong> <span class="text-xs">${deviceInfo.kernelVersion || 'N/A'}</span></div>
                <div><strong>Build Version:</strong> <span class="text-xs">${deviceInfo.buildVersion || 'N/A'}</span></div>
                <div><strong>Is Rooted:</strong> ${typeof deviceInfo.isRooted !== 'undefined' ? (deviceInfo.isRooted ? 'Yes' : 'No') : 'N/A'}</div>
                <div><strong>Registration Time:</strong> ${formatTimestamp(deviceInfo.registrationTime)}</div>
            `;
        }

        document.getElementById('save-device-alias').addEventListener('click', () => {
            if (!currentDeviceUID) return;
            const newAlias = document.getElementById('edit-device-alias').value.trim();
            if (newAlias) {
                showLoading();
                db.ref(`devices/${currentDeviceUID}/alias`).set(newAlias)
                    .then(() => {
                        console.log("Alias updated");
                        if (allDevicesData[currentDeviceUID]) allDevicesData[currentDeviceUID].alias = newAlias;
                        currentDeviceData.alias = newAlias; // Update local cache
                        currentDeviceNameSidebar.textContent = `Device: ${newAlias}`;
                         // Re-render device list if currently on it to show new alias
                        if (currentView === 'devices') renderDeviceList(document.getElementById('device-search').value);
                        if (currentView === 'device-info') currentSectionTitleEl.textContent = `Device Info (Device: ${newAlias})`;

                        alert('Alias saved successfully!');
                    })
                    .catch(error => {
                        console.error("Error saving alias:", error);
                        alert(`Error saving alias: ${error.message}`);
                    })
                    .finally(hideLoading);
            }
        });

        // --- CSV Export ---
        function escapeCsvValue(value) {
            if (value == null) return ''; // Handles undefined or null
            let strValue = String(value);
            if (strValue.includes(',') || strValue.includes('"') || strValue.includes('\n')) {
                strValue = '"' + strValue.replace(/"/g, '""') + '"';
            }
            return strValue;
        }

        function exportToCsv(filename, rows) {
            if (!rows || rows.length === 0) {
                alert("No data to export.");
                return;
            }
            const csvContent = "data:text/csv;charset=utf-8,"
                + rows.map(row => row.map(escapeCsvValue).join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        document.querySelectorAll('.export-csv-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const type = e.target.dataset.type;
                if (!currentDeviceUID && type !== 'all-devices-info') { // Add a way to export all devices basic info if needed
                    alert("Please select a device first.");
                    return;
                }

                let dataToExport = [];
                let headers = [];
                const deviceAlias = currentDeviceData.alias || currentDeviceUID.substring(0,8);
                let filename = `${type}_${deviceAlias}_${new Date().toISOString().split('T')[0]}.csv`;


                switch (type) {
                    case 'sms':
                        headers = ["Address", "Body", "Date", "Type"];
                        dataToExport = Object.values(currentDeviceData.sms || {}).map(sms => [
                            sms.address, sms.body, formatTimestamp(sms.date || sms.time), sms.type // Adapt type as needed
                        ]);
                        break;
                    case 'calls':
                        headers = ["Number", "Name", "Type", "Duration (s)", "Date"];
                        dataToExport = Object.values(currentDeviceData.calls || {}).map(call => [
                            call.number, call.name, call.type, call.duration, formatTimestamp(call.date)
                        ]);
                        break;
                    case 'apps':
                        headers = ["App Name", "Package Name", "Type", "Version Name", "Version Code", "Install Time", "Update Time"];
                        dataToExport = Object.values(currentDeviceData.apps || {}).map(app => [
                            app.appName, app.packageName, app.type, app.versionName, app.versionCode,
                            formatTimestamp(app.firstInstallTime), formatTimestamp(app.lastUpdateTime)
                        ]);
                        break;
                    case 'files':
                        headers = ["Folder", "Name", "Path", "Extension", "Size (Bytes)", "Last Modified"];
                        dataToExport = Object.values(currentDeviceData.files || {}).map(file => [
                            file.folder, file.name, file.path, file.extension || file.type, file.size, formatTimestamp(file.lastModified || file.timestamp)
                        ]);
                        break;
                    case 'history': // browsing history
                        headers = ["Title", "URL", "Visit Time", "Browser"];
                        dataToExport = Object.values(currentDeviceData.browsingHistory || {}).map(h => [
                            h.title, h.url, formatTimestamp(h.date || h.visitTime), h.browser
                        ]);
                         filename = `browsing_history_${deviceAlias}_${new Date().toISOString().split('T')[0]}.csv`;
                        break;
                    case 'device-info':
                        headers = ["Property", "Value"];
                        const di = currentDeviceData.deviceInfo || {};
                        dataToExport.push(["Alias", currentDeviceData.alias || 'N/A']);
                        for (const key in di) {
                            if (typeof di[key] === 'object' && di[key] !== null) {
                                for (const subKey in di[key]) {
                                    dataToExport.push([`${key}_${subKey}`, di[key][subKey]]);
                                }
                            } else {
                                dataToExport.push([key, di[key]]);
                            }
                        }
                        filename = `device_info_${deviceAlias}_${new Date().toISOString().split('T')[0]}.csv`;
                        break;
                    // Add other types as needed (notifications, etc.)
                    default:
                        alert("Export type not implemented yet.");
                        return;
                }

                if (dataToExport.length > 0) {
                    exportToCsv(filename, [headers, ...dataToExport]);
                } else {
                    alert(`No ${type.replace('-', ' ')} data available to export for this device.`);
                }
            });
        });

        // --- Initial Load ---
        // navigateTo will be called by onAuthStateChanged or hashchange
        // If there's a hash on load, and user is already logged in, it will navigate there.
        // If no hash, defaults to #dashboard.
        if (window.location.hash) {
            navigateTo(window.location.hash);
        } else {
            navigateTo('#dashboard'); // Default view
        }

        // --- Example Placeholder Data (For UI testing without Firebase) ---
        // You can uncomment this block and comment out Firebase init for testing UI with dummy data.
        /*
        function loadDummyData() {
            currentUser = { email: "test@example.com" };
            loginPage.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            adminEmailEl.textContent = currentUser.email;

            allDevicesData = {
                "dummyUID123": {
                    alias: "Test Phone 1",
                    status: { online: true, lastSeen: Date.now() - 60000, syncing: true },
                    deviceInfo: { model: "Pixel Test", androidVersion: "12", registrationTime: Date.now() - 86400000 },
                    sms: {
                        "sms1": { address: "12345", body: "Hello from dummy", date: Date.now() - 3600000, type: "inbox" },
                        "sms2": { address: "67890", body: "Test message sent", date: Date.now() - 7200000, type: "sent" }
                    },
                    calls: {
                        "call1": { number: "555-1234", name: "John Doe", type: "incoming", duration: 120, date: Date.now() - 10000000 }
                    },
                    apps: { "com.test.app": { appName: "Dummy App", packageName: "com.test.app", type: "user", versionName: "1.0"} },
                    battery: { level: 75, isCharging: false, lastUpdated: Date.now() - 300000 },
                    location: { latest: { latitude: 34.0522, longitude: -118.2437, timestamp: Date.now() - 900000, accuracy: 10 }},
                    files: { "file1": { folder: "Downloads", name: "dummy.pdf", extension: "pdf", size: 102400, lastModified: Date.now() - 12000000 }},
                    screenshots: { "scr1": { url: "https://via.placeholder.com/300", fileName: "dummy_ss.png", timestamp: Date.now() - 1500000}},
                    notifications: { "notif1": { appName: "TestApp", title: "Dummy Notification", text: "This is a test notification.", postTime: Date.now() - 60000}},
                    browsingHistory: { "hist1": { title: "Example Site", url: "http://example.com", visitTime: Date.now() - 18000000, browser: "TestBrowser"}}
                },
                 "dummyUID456": {
                    alias: "Old Device",
                    status: { online: false, lastSeen: Date.now() - 86400000 * 5 }, // 5 days ago
                    deviceInfo: { model: "Galaxy Test", androidVersion: "10", registrationTime: Date.now() - 86400000 * 10 },
                }
            };
            currentDeviceUID = "dummyUID123";
            currentDeviceData = allDevicesData[currentDeviceUID];
            selectDevice(currentDeviceUID); // This will populate device specific links and trigger nav
            navigateTo(window.location.hash || "#dashboard");
        }
        // loadDummyData(); // Call this instead of Firebase init for UI testing
        */

    </script>
</body>
</html>